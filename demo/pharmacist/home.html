<!DOCTYPE html>
<html lang="en" x-data="pharmacistDashboard()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pharmacist Dashboard - Umi Health Demo</title>
  <link rel="icon" href="../../logo.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../shared/css/shared-styles.css">
  <script src="../shared/js/demo-storage.js"></script>
</head>
<body>
  <!-- Demo Banner -->
  <div class="demo-banner">
    <strong>DEMO MODE:</strong> This is a demonstration version using local storage. No backend connection required.
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" :class="{ 'open': sidebarOpen }">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="../../logo.png" alt="Umi Health" />
        <div>
          <div class="sidebar-title">Umi Health</div>
          <div class="sidebar-subtitle">Pharmacist Portal</div>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Pharmacy</div>
        <a href="home.html" class="nav-item">
          <span class="material-symbols-rounded">home</span>
          Dashboard
        </a>
        <a href="prescriptions.html" class="nav-item" @click="navigateTo('prescriptions')">
          <span class="material-symbols-rounded">description</span>
          Prescriptions
        </a>
        <a href="inventory.html" class="nav-item" @click="navigateTo('inventory')">
          <span class="material-symbols-rounded">medication</span>
          Inventory
        </a>
        <a href="patients.html" class="nav-item" @click="navigateTo('patients')">
          <span class="material-symbols-rounded">group</span>
          Patients
        </a>
        <a href="#" class="nav-item" @click="navigateTo('clinical')">
          <span class="material-symbols-rounded">science</span>
          Clinical
        </a>
        <a href="#" class="nav-item" @click="navigateTo('compliance')">
          <span class="material-symbols-rounded">check_circle</span>
          Compliance
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Management</div>
        <a href="#" class="nav-item" @click="navigateTo('suppliers')">
          <span class="material-symbols-rounded">local_shipping</span>
          Suppliers
        </a>
        <a href="#" class="nav-item" @click="navigateTo('reports')">
          <span class="material-symbols-rounded">bar_chart</span>
          Reports
        </a>
        <a href="#" class="nav-item" @click="navigateTo('payments')">
          <span class="material-symbols-rounded">credit_card</span>
          Payments
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a href="#" class="nav-item" @click="showSettings()">
          <span class="material-symbols-rounded">settings</span>
          Settings
        </a>
        <a href="#" class="nav-item" @click="exportData()">
          <span class="material-symbols-rounded">upload</span>
          Export Data
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        <div class="page-title-section">
          <h1 class="page-title">Pharmacist Dashboard</h1>
        </div>
      </div>

      <div class="header-right">
        <div class="search-bar">
          <span class="search-icon">üîç</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search patients, medications, prescriptions..."
            x-model="searchQuery"
            @input="performSearch"
          >
        </div>

        <div class="user-info">
          <div class="user-avatar">P</div>
          <div class="user-details">
            <div class="user-name">Esther Mwale</div>
            <div class="user-role">Pharmacist</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="content">
      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
            üìã
          </div>
          <div class="stat-value" x-text="stats.pendingPrescriptions"></div>
          <div class="stat-label">Pending Prescriptions</div>
          <div class="stat-change positive">Requires attention</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--color-info);">
            üíä
          </div>
          <div class="stat-value" x-text="stats.lowStockItems"></div>
          <div class="stat-label">Low Stock Items</div>
          <div class="stat-change negative">Reorder needed</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
            ‚è∞
          </div>
          <div class="stat-value" x-text="stats.expiringSoon"></div>
          <div class="stat-label">Expiring Soon</div>
          <div class="stat-change negative">Action required</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
            <span class="material-symbols-rounded">group</span>
          </div>
          <div class="stat-value" x-text="stats.todayPatients"></div>
          <div class="stat-label">Today's Patients</div>
          <div class="stat-change positive">+5 from yesterday</div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Pending Prescriptions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Pending Prescriptions</h3>
            <button class="btn btn-sm btn-primary" @click="navigateTo('prescriptions')">
              View All
            </button>
          </div>
          <div class="card-content">
            <div class="prescription-list">
              <template x-for="prescription in pendingPrescriptions" :key="prescription.id">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid var(--color-border); border-radius: 0.5rem; margin-bottom: 0.75rem; background: var(--color-surface);">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="font-weight: 600; color: var(--color-text-primary);" x-text="prescription.patientName"></span>
                      <span class="status-badge status-pending" x-text="prescription.status"></span>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;" x-text="prescription.diagnosis"></div>
                    <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                      <span>Dr. </span><span x-text="prescription.doctorName"></span>
                      <span style="margin: 0 0.5rem;">‚Ä¢</span>
                      <span x-text="formatDate(prescription.date)"></span>
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-xs btn-primary" @click="processPrescription(prescription)">
                      Process
                    </button>
                    <button class="btn btn-xs btn-secondary" @click="viewPrescription(prescription)">
                      View
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Inventory Alerts -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Inventory Alerts</h3>
            <button class="btn btn-sm btn-secondary" @click="navigateTo('inventory')">
              Manage
            </button>
          </div>
          <div class="card-content">
            <div class="alert-list">
              <template x-for="alert in inventoryAlerts" :key="alert.id">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;" 
                     :style="`background: ${alert.severity === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'};`">
                  <div style="font-size: 1.25rem;" x-text="alert.icon"></div>
                  <div style="flex: 1;">
                    <div style="font-weight: 500; color: var(--color-text-primary); font-size: 0.875rem;" x-text="alert.medication"></div>
                    <div style="font-size: 0.75rem; color: var(--color-text-secondary);" x-text="alert.message"></div>
                  </div>
                  <div style="font-size: 0.75rem; font-weight: 600;" 
                       :style="`color: ${alert.severity === 'high' ? 'var(--color-warning)' : '#f59e0b'};`" 
                       x-text="alert.quantity">
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity & Quick Actions -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
            <button class="btn btn-sm btn-secondary" @click="refreshActivity()">
              Refresh
            </button>
          </div>
          <div class="card-content">
            <div class="activity-list">
              <template x-for="activity in recentActivity" :key="activity.id">
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--color-border);">
                  <div style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem;" 
                       :style="`background: ${activity.color}20; color: ${activity.color};`" 
                       x-text="activity.icon">
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 500; color: var(--color-text-primary); font-size: 0.875rem;" x-text="activity.title"></div>
                    <div style="font-size: 0.75rem; color: var(--color-text-secondary);" x-text="activity.description"></div>
                  </div>
                  <div style="font-size: 0.625rem; color: var(--color-text-muted);" x-text="activity.time"></div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="card-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <button class="btn btn-secondary" @click="quickAction('new-prescription')">
                <span style="margin-right: 0.5rem;">üìã</span>
                New Prescription
              </button>
              <button class="btn btn-secondary" @click="quickAction('dispense-medication')">
                <span style="margin-right: 0.5rem;">üíä</span>
                Dispense Medication
              </button>
              <button class="btn btn-secondary" @click="quickAction('stock-check')">
                <span style="margin-right: 0.5rem;">üîç</span>
                Stock Check
              </button>
              <button class="btn btn-secondary" @click="quickAction('patient-search')">
                <span class="material-symbols-rounded" style="margin-right: 0.5rem;">group</span>
                Patient Search
              </button>
              <button class="btn btn-secondary" @click="quickAction('order-supplies')">
                <span style="margin-right: 0.5rem;">üöö</span>
                Order Supplies
              </button>
              <button class="btn btn-secondary" @click="quickAction('generate-report')">
                <span class="material-symbols-rounded" style="margin-right: 0.5rem;">bar_chart</span>
                Generate Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Prescription Modal -->
  <div class="modal-overlay" x-show="showPrescriptionModal" @click.self="showPrescriptionModal = false">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Prescription Details</h3>
        <button class="modal-close" @click="showPrescriptionModal = false">√ó</button>
      </div>
      <div class="modal-body">
        <div x-show="selectedPrescription">
          <div style="margin-bottom: 1.5rem;">
            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Patient Information</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
              <div><strong>Name:</strong> <span x-text="selectedPrescription?.patientName"></span></div>
              <div><strong>Date:</strong> <span x-text="formatDate(selectedPrescription?.date)"></span></div>
              <div><strong>Doctor:</strong> <span x-text="selectedPrescription?.doctorName"></span></div>
              <div><strong>Status:</strong> <span x-text="selectedPrescription?.status"></span></div>
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Diagnosis</h4>
            <p style="color: var(--color-text-secondary);" x-text="selectedPrescription?.diagnosis"></p>
          </div>
          
          <div>
            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Medications</h4>
            <div style="border: 1px solid var(--color-border); border-radius: 0.5rem; overflow: hidden;">
              <template x-for="med in selectedPrescription?.medications" :key="med.name">
                <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                  <div style="font-weight: 500; margin-bottom: 0.25rem;" x-text="med.name"></div>
                  <div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.25rem;" x-text="med.dosage"></div>
                  <div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 0.25rem;" x-text="med.duration"></div>
                  <div style="font-size: 0.75rem; color: var(--color-text-muted);" x-text="med.instructions"></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="showPrescriptionModal = false">Close</button>
        <button class="btn btn-primary" @click="processPrescription(selectedPrescription)">Process Prescription</button>
      </div>
    </div>
  </div>

  <script>
    function pharmacistDashboard() {
      return {
        sidebarOpen: false,
        searchQuery: '',
        showPrescriptionModal: false,
        selectedPrescription: null,
        stats: {},
        pendingPrescriptions: [],
        inventoryAlerts: [],
        recentActivity: [],

        init() {
          this.loadDashboardData();
          this.loadPendingPrescriptions();
          this.loadInventoryAlerts();
          this.loadRecentActivity();
        },

        loadDashboardData() {
          const allStats = window.demoStorage.getDashboardStats();
          const medications = window.demoStorage.getItem('medications') || [];
          const prescriptions = window.demoStorage.getItem('prescriptions') || [];
          const sales = window.demoStorage.getItem('sales') || [];
          
          this.stats = {
            pendingPrescriptions: prescriptions.filter(p => p.status === 'Active').length,
            lowStockItems: medications.filter(m => m.stockQuantity <= m.reorderLevel).length,
            expiringSoon: medications.filter(m => {
              const expiryDate = new Date(m.expiryDate);
              const threeMonthsFromNow = new Date();
              threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);
              return expiryDate <= threeMonthsFromNow;
            }).length,
            todayPatients: sales.filter(s => s.date === new Date().toISOString().split('T')[0]).length
          };
        },

        loadPendingPrescriptions() {
          const prescriptions = window.demoStorage.getItem('prescriptions') || [];
          this.pendingPrescriptions = prescriptions
            .filter(p => p.status === 'Active')
            .slice(0, 5);
        },

        loadInventoryAlerts() {
          const medications = window.demoStorage.getItem('medications') || [];
          this.inventoryAlerts = [];
          
          medications.forEach(med => {
            if (med.stockQuantity <= med.reorderLevel) {
              this.inventoryAlerts.push({
                id: med.id,
                medication: med.name,
                message: `Stock: ${med.stockQuantity} (Reorder at: ${med.reorderLevel})`,
                quantity: `${med.stockQuantity} units`,
                severity: med.stockQuantity <= med.reorderLevel / 2 ? 'high' : 'medium',
                icon: '‚ö†Ô∏è'
              });
            }
            
            const expiryDate = new Date(med.expiryDate);
            const threeMonthsFromNow = new Date();
            threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);
            
            if (expiryDate <= threeMonthsFromNow) {
              this.inventoryAlerts.push({
                id: `${med.id}-expiry`,
                medication: med.name,
                message: `Expires: ${med.expiryDate}`,
                quantity: this.formatDate(med.expiryDate),
                severity: expiryDate <= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) ? 'high' : 'medium',
                icon: '‚è∞'
              });
            }
          });
          
          this.inventoryAlerts = this.inventoryAlerts.slice(0, 5);
        },

        loadRecentActivity() {
          const prescriptions = window.demoStorage.getItem('prescriptions') || [];
          const medications = window.demoStorage.getItem('medications') || [];
          
          this.recentActivity = [
            ...prescriptions.slice(0, 3).map(prescription => ({
              id: prescription.id,
              icon: 'üìã',
              title: 'New Prescription',
              description: `For ${prescription.patientName} - ${prescription.diagnosis}`,
              time: this.formatTime(prescription.date),
              color: '#3b82f6'
            })),
            ...medications.slice(0, 2).filter(m => m.stockQuantity <= m.reorderLevel).map(med => ({
              id: `${med.id}-lowstock`,
              icon: '‚ö†Ô∏è',
              title: 'Low Stock Alert',
              description: `${med.name} - ${med.stockQuantity} units remaining`,
              time: '2 hours ago',
              color: '#f59e0b'
            }))
          ].slice(0, 5);
        },

        formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('en-ZM', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        },

        formatTime(dateString) {
          const date = new Date(dateString);
          const now = new Date();
          const diffTime = Math.abs(now - date);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays === 1) return 'Yesterday';
          if (diffDays < 7) return `${diffDays} days ago`;
          return this.formatDate(dateString);
        },

        navigateTo(page) {
          console.log('Navigate to:', page);
          this.showNotification(`Navigating to ${page}...`, 'info');
        },

        performSearch() {
          if (this.searchQuery.trim()) {
            const results = {
              patients: window.demoStorage.searchPatients(this.searchQuery),
              medications: window.demoStorage.searchMedications(this.searchQuery)
            };
            console.log('Search results:', results);
          }
        },

        viewPrescription(prescription) {
          this.selectedPrescription = prescription;
          this.showPrescriptionModal = true;
        },

        processPrescription(prescription) {
          if (prescription) {
            // Update prescription status
            window.demoStorage.updatePrescription(prescription.id, { status: 'Completed' });
            this.showNotification('Prescription processed successfully', 'success');
            this.showPrescriptionModal = false;
            this.loadPendingPrescriptions();
            this.loadRecentActivity();
            this.loadDashboardData();
          }
        },

        refreshActivity() {
          this.loadRecentActivity();
          this.showNotification('Activity refreshed', 'success');
        },

        quickAction(action) {
          const actions = {
            'new-prescription': 'Opening new prescription form...',
            'dispense-medication': 'Opening medication dispensing...',
            'stock-check': 'Performing stock check...',
            'patient-search': 'Opening patient search...',
            'order-supplies': 'Opening supply ordering...',
            'generate-report': 'Opening report generator...'
          };
          
          this.showNotification(actions[action] || 'Processing...', 'info');
        },

        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification notification-${type}`;
          notification.textContent = message;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            border-radius: 0.5rem;
            z-index: 9999;
            animation: slideIn 0.3s ease;
          `;
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }
      };
    }
  </script>

  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</body>
</html>
