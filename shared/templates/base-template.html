<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{page-description}}">
    <meta name="keywords" content="{{page-keywords}}">
    <meta name="author" content="Umi Health">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{{page-title}}">
    <meta property="og:description" content="{{page-description}}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{page-url}}">
    <meta property="og:image" content="{{page-image}}">
    <meta property="og:site_name" content="Umi Health">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{page-title}}">
    <meta name="twitter:description" content="{{page-description}}">
    <meta name="twitter:image" content="{{page-image}}">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta name="theme-color" content="#007bff">
    
    <title>{{page-title}} - Umi Health</title>
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Framework and Libraries -->
    <link href="/shared/css/enhanced-components.css" rel="stylesheet">
    <link href="/shared/css/portal-themes.css" rel="stylesheet">
    <link href="/shared/css/responsive-design.css" rel="stylesheet">
    <link href="/shared/css/shared-styles.css" rel="stylesheet">
    
    <!-- Portal-specific CSS -->
    {{portal-css}}
    
    <!-- Page-specific CSS -->
    {{page-css}}
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    
    <!-- Manifest for PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Critical CSS (inline for performance) -->
    <style>
        /* Critical above-the-fold styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-collapsed {
            margin-left: 70px;
        }
        
        .content-area {
            flex: 1;
            padding: 20px;
            background: #f8fafc;
            min-height: calc(100vh - 64px);
        }
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="{{portal-class}} {{page-class}}">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- App Layout -->
    <div class="app-layout">
        <!-- Header Component -->
        {{include:header}}
        
        <!-- Main Content Area -->
        <div class="main-content" id="main-content">
            <!-- Sidebar Component -->
            {{include:sidebar}}
            
            <!-- Page Content -->
            <main class="content-area" role="main">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header-content">
                        <div class="page-title-section">
                            <h1 class="page-title">{{page-title}}</h1>
                            <p class="page-description">{{page-description}}</p>
                        </div>
                        <div class="page-actions">
                            {{page-actions}}
                        </div>
                    </div>
                </div>
                
                <!-- Breadcrumb Navigation -->
                {{breadcrumb}}
                
                <!-- Alert Messages -->
                <div class="alert-container" id="alert-container"></div>
                
                <!-- Page Content -->
                <div class="page-content">
                    {{content}}
                </div>
            </main>
        </div>
        
        <!-- Footer Component -->
        {{include:footer}}
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- JavaScript Libraries -->
    <script src="/public/js/components/DataTable.js"></script>
    <script src="/public/js/components/FormValidator.js"></script>
    <script src="/public/js/components/Modal.js"></script>
    <script src="/public/js/components/NotificationSystem.js"></script>
    <script src="/public/js/auth-manager.js"></script>
    <script src="/public/js/api-client.js"></script>
    
    <!-- Portal-specific JavaScript -->
    {{portal-js}}
    
    <!-- Page-specific JavaScript -->
    {{page-js}}
    
    <!-- Main Application JavaScript -->
    <script>
        // Application Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize notification system
            const notificationSystem = NotificationSystem.getInstance();
            
            // Hide loading overlay
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }, 500);
            
            // Initialize global event handlers
            initializeGlobalEventHandlers();
            
            // Initialize theme
            initializeTheme();
            
            // Initialize accessibility features
            initializeAccessibility();
            
            // Initialize error handling
            initializeErrorHandling();
            
            // Emit app ready event
            window.dispatchEvent(new CustomEvent('appReady'));
        });
        
        // Global Event Handlers
        function initializeGlobalEventHandlers() {
            // Handle navigation events
            window.addEventListener('navigation', function(e) {
                const { page, url } = e.detail;
                console.log('Navigating to:', page, url);
                // Implement navigation logic here
            });
            
            // Handle sidebar toggle
            window.addEventListener('sidebarToggle', function(e) {
                const { collapsed } = e.detail;
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    if (collapsed) {
                        mainContent.classList.add('sidebar-collapsed');
                    } else {
                        mainContent.classList.remove('sidebar-collapsed');
                    }
                }
            });
            
            // Handle global search
            window.addEventListener('globalSearch', function(e) {
                const { query } = e.detail;
                console.log('Global search:', query);
                // Implement global search logic here
            });
            
            // Handle user logout
            window.addEventListener('userLogout', function() {
                // Implement logout logic here
                window.location.href = '/signin';
            });
            
            // Handle newsletter subscription
            window.addEventListener('newsletterSubscribe', function(e) {
                const { email } = e.detail;
                console.log('Newsletter subscription:', email);
                // Implement newsletter subscription logic here
            });
            
            // Handle analytics events
            window.addEventListener('footerLinkClick', function(e) {
                const { url, text } = e.detail;
                console.log('Footer link clicked:', url, text);
                // Implement analytics tracking here
            });
            
            window.addEventListener('socialLinkClick', function(e) {
                const { platform, url } = e.detail;
                console.log('Social link clicked:', platform, url);
                // Implement analytics tracking here
            });
        }
        
        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Theme toggle functionality (if needed)
            const themeToggle = document.querySelector('.theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    
                    // Emit theme change event
                    window.dispatchEvent(new CustomEvent('themeChange', {
                        detail: { theme: newTheme }
                    }));
                });
            }
        }
        
        // Accessibility Features
        function initializeAccessibility() {
            // Skip link functionality
            const skipLink = document.querySelector('.skip-link');
            if (skipLink) {
                skipLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.focus();
                        target.scrollIntoView();
                    }
                });
            }
            
            // Focus management for modals
            window.addEventListener('modalShow', function() {
                document.body.classList.add('modal-open');
            });
            
            window.addEventListener('modalHide', function() {
                document.body.classList.remove('modal-open');
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                // Escape key handling
                if (e.key === 'Escape') {
                    // Close modals, dropdowns, etc.
                    window.dispatchEvent(new CustomEvent('escapeKey'));
                }
                
                // Ctrl+K for global search
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            });
        }
        
        // Error Handling
        function initializeErrorHandling() {
            // Global error handler
            window.addEventListener('error', function(e) {
                console.error('Global error:', e.error);
                // Show user-friendly error message
                const notificationSystem = NotificationSystem.getInstance();
                notificationSystem.error('An unexpected error occurred. Please try again.');
            });
            
            // Unhandled promise rejection handler
            window.addEventListener('unhandledrejection', function(e) {
                console.error('Unhandled promise rejection:', e.reason);
                // Show user-friendly error message
                const notificationSystem = NotificationSystem.getInstance();
                notificationSystem.error('An unexpected error occurred. Please try again.');
            });
        }
        
        // Utility Functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                
                alertContainer.appendChild(alert);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }
        
        function formatDate(date) {
            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }).format(new Date(date));
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        // Make utility functions globally available
        window.showAlert = showAlert;
        window.formatDate = formatDate;
        window.formatCurrency = formatCurrency;
    </script>
</body>
</html>
