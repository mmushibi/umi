<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalR Test - Umi Health</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .testing { background: #cce5ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .event-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
        }
        .event-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .event-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <h1>ðŸ”— SignalR Real-time Test</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status offline">Not connected</div>
        <div id="connectionDetails"></div>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="testNotifications()">Test Notifications</button>
        <button onclick="testInventory()">Test Inventory Events</button>
        <button onclick="testPrescriptions()">Test Prescription Events</button>
        <button onclick="testSales()">Test Sales Events</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Real-time Events</h2>
        <div id="eventList" class="event-list">
            <div class="event-item">Waiting for events...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="testLog" class="log">SignalR test ready. Click buttons to test functionality.</div>
    </div>

    <!-- Include required libraries -->
    <script src="../../js/api-client.js"></script>
    <script src="../../js/auth-manager.js"></script>
    <script src="../shared/js/backend-integration-helper.js"></script>
    <script src="../shared/js/page-integration-template.js"></script>
    <script src="../shared/js/signalr-client.js"></script>
    <script src="../shared/js/realtime-events.js"></script>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>

    <script>
        let testLog = document.getElementById('testLog');
        let eventList = document.getElementById('eventList');
        let connectionStatus = document.getElementById('connectionStatus');
        let connectionDetails = document.getElementById('connectionDetails');
        let eventCounter = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            testLog.textContent += logEntry;
            testLog.scrollTop = testLog.scrollHeight;
            console.log(message);
        }

        function addEventToList(eventName, data) {
            eventCounter++;
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <strong>#${eventCounter}</strong> - ${eventName}<br>
                <small>${new Date().toLocaleTimeString()}</small><br>
                <em>${JSON.stringify(data, null, 2)}</em>
            `;
            
            if (eventList.children[0].textContent.includes('Waiting for events')) {
                eventList.innerHTML = '';
            }
            
            eventList.insertBefore(eventItem, eventList.firstChild);
            
            // Keep only last 20 events
            while (eventList.children.length > 20) {
                eventList.removeChild(eventList.lastChild);
            }
        }

        function updateConnectionStatus(status, details = null) {
            connectionStatus.className = `status ${status}`;
            connectionStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (details) {
                connectionDetails.innerHTML = `
                    <small>
                        User Role: ${details.userRole || 'N/A'}<br>
                        Tenant ID: ${details.tenantId || 'N/A'}<br>
                        Branch ID: ${details.branchId || 'N/A'}<br>
                        Connections: ${(details.connections || []).join(', ') || 'None'}
                    </small>
                `;
            }
        }

        async function testConnection() {
            log('Testing SignalR connection...');
            
            try {
                // Mock user for testing
                const mockUser = {
                    id: 'test-user-123',
                    name: 'Test User',
                    roles: ['Admin'],
                    tenantId: 'test-tenant',
                    branchId: 'test-branch',
                    token: 'mock-token'
                };

                // Initialize real-time events
                await window.realtimeEvents.initialize(mockUser);
                
                const status = window.realtimeEvents.getStatus();
                updateConnectionStatus(status.isConnected ? 'online' : 'offline', status);
                
                log(`SignalR connection test: ${status.isConnected ? 'SUCCESS' : 'FAILED'}`);
                log(`Status: ${JSON.stringify(status, null, 2)}`);
                
            } catch (error) {
                log(`Connection test failed: ${error.message}`, 'error');
                updateConnectionStatus('offline');
            }
        }

        async function testNotifications() {
            log('Testing notification events...');
            
            try {
                // Simulate receiving a notification
                const mockNotification = {
                    id: 'notif-123',
                    type: 'info',
                    title: 'Test Notification',
                    message: 'This is a test notification from SignalR',
                    timestamp: new Date().toISOString(),
                    userId: 'test-user-123'
                };
                
                // Trigger the notification handler directly
                window.realtimeEvents.handleNotification(mockNotification);
                addEventToList('notification-received', mockNotification);
                
                log('Notification test completed successfully');
            } catch (error) {
                log(`Notification test failed: ${error.message}`, 'error');
            }
        }

        async function testInventory() {
            log('Testing inventory events...');
            
            try {
                const mockStockChange = {
                    productId: 'prod-123',
                    productName: 'Test Medicine',
                    currentStock: 15,
                    previousStock: 25,
                    isLowStock: true,
                    changeType: 'decrease'
                };
                
                window.realtimeEvents.handleStockLevelChange(mockStockChange);
                addEventToList('stock-level-changed', mockStockChange);
                
                log('Inventory test completed successfully');
            } catch (error) {
                log(`Inventory test failed: ${error.message}`, 'error');
            }
        }

        async function testPrescriptions() {
            log('Testing prescription events...');
            
            try {
                const mockPrescription = {
                    id: 'presc-123',
                    patientName: 'John Doe',
                    medications: ['Paracetamol', 'Ibuprofen'],
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                window.realtimeEvents.handleNewPrescription(mockPrescription);
                addEventToList('new-prescription', mockPrescription);
                
                log('Prescription test completed successfully');
            } catch (error) {
                log(`Prescription test failed: ${error.message}`, 'error');
            }
        }

        async function testSales() {
            log('Testing sales events...');
            
            try {
                const mockSale = {
                    id: 'sale-123',
                    totalAmount: 150.00,
                    items: ['Medicine A', 'Medicine B'],
                    customerName: 'Jane Smith',
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };
                
                window.realtimeEvents.handleSaleCompleted(mockSale);
                addEventToList('sale-completed', mockSale);
                
                log('Sales test completed successfully');
            } catch (error) {
                log(`Sales test failed: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            testLog.textContent = '';
            eventList.innerHTML = '<div class="event-item">Waiting for events...</div>';
            eventCounter = 0;
        }

        // Setup real-time event listeners
        window.realtimeEvents.on('notification-received', (data) => {
            addEventToList('notification-received', data);
        });

        window.realtimeEvents.on('stock-level-changed', (data) => {
            addEventToList('stock-level-changed', data);
        });

        window.realtimeEvents.on('new-prescription', (data) => {
            addEventToList('new-prescription', data);
        });

        window.realtimeEvents.on('sale-completed', (data) => {
            addEventToList('sale-completed', data);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('SignalR test page loaded');
            updateConnectionStatus('offline');
        });
    </script>
</body>
</html>
