<!DOCTYPE html>
<html lang="en" x-data="offlineTest()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Offline Test</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Backend Integration Libraries -->
    <script src="../../js/api-client.js"></script>
    <script src="../../js/auth-manager.js"></script>
    <script src="../shared/js/backend-integration-helper.js"></script>
    <script src="../shared/js/page-integration-template.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .cached { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .data-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Super Admin Offline Functionality Test</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connection-status" class="status">Checking...</div>
        <button onclick="testOfflineMode()">Simulate Offline</button>
        <button onclick="testOnlineMode()">Simulate Online</button>
        <button onclick="checkConnectionStatus()">Check Status</button>
    </div>

    <div class="test-section">
        <h2>Data Sync Tests</h2>
        <button onclick="testDashboardLoad()">Load Dashboard Data</button>
        <button onclick="testCacheStorage()">Test Cache Storage</button>
        <button onclick="testOfflineStorage()">Test Offline Storage</button>
        <button onclick="clearAllData()">Clear All Data</button>
        <div id="data-display" class="data-display">No data loaded yet</div>
    </div>

    <div class="test-section">
        <h2>Request Queue Tests</h2>
        <button onclick="testQueuedRequest()">Queue Test Request</button>
        <button onclick="processQueue()">Process Queue</button>
        <button onclick="showQueueStatus()">Queue Status</button>
        <div id="queue-status" class="data-display">No queued requests</div>
    </div>

    <div class="test-section">
        <h2>Real-time Sync Tests</h2>
        <button onclick="testRealtimeConnection()">Test Real-time Connection</button>
        <button onclick="testRealtimeSubscription()">Test Subscription</button>
        <div id="realtime-status" class="data-display">Real-time not tested</div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="test-log" class="log">Test log will appear here...</div>
    </div>

    <!-- Include the super admin data sync scripts -->
    <script src="../shared/js/super-admin-data-sync.js"></script>
    <script src="../shared/js/realtime-sync.js"></script>

    <script>
        let testLog = document.getElementById('test-log');
        let connectionStatus = document.getElementById('connection-status');
        let dataDisplay = document.getElementById('data-display');
        let queueStatus = document.getElementById('queue-status');
        let realtimeStatus = document.getElementById('realtime-status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            testLog.textContent += logEntry;
            testLog.scrollTop = testLog.scrollHeight;
            console.log(message);
        }

        function updateConnectionStatus() {
            const status = window.superAdminDataSync.getConnectionStatus();
            let statusText = `Online: ${status.isOnline}, `;
            statusText += `Cached Data: ${status.hasCachedData}, `;
            statusText += `Offline Data: ${status.hasOfflineData}, `;
            statusText += `Queued Requests: ${status.queuedRequests}, `;
            statusText += `Real-time Active: ${status.realtimeActive}`;

            connectionStatus.textContent = statusText;
            connectionStatus.className = `status ${status.isOnline ? 'online' : 'offline'}`;
            
            log(`Connection status updated: ${statusText}`);
        }

        function testOfflineMode() {
            log('Simulating offline mode...');
            // Simulate offline by setting the flag
            window.superAdminDataSync.isOnline = false;
            updateConnectionStatus();
        }

        function testOnlineMode() {
            log('Simulating online mode...');
            // Simulate online by setting the flag
            window.superAdminDataSync.isOnline = true;
            updateConnectionStatus();
        }

        async function testDashboardLoad() {
            log('Testing dashboard data load...');
            try {
                const data = await window.superAdminDataSync.getDashboardSummary();
                dataDisplay.textContent = JSON.stringify(data, null, 2);
                log('Dashboard data loaded successfully');
            } catch (error) {
                dataDisplay.textContent = `Error: ${error.message}`;
                log(`Dashboard load failed: ${error.message}`, 'error');
            }
            updateConnectionStatus();
        }

        function testCacheStorage() {
            log('Testing cache storage...');
            const testData = { test: 'data', timestamp: Date.now() };
            window.superAdminDataSync.setCache('test-key', testData);
            
            const cached = window.superAdminDataSync.getCache('test-key');
            const isValid = window.superAdminDataSync.isCacheValid('test-key');
            
            log(`Cache test: Stored=${!!cached}, Valid=${isValid}`);
            updateConnectionStatus();
        }

        function testOfflineStorage() {
            log('Testing offline storage...');
            const testData = { test: 'offline-data', timestamp: Date.now() };
            window.superAdminDataSync.storeOfflineData('/test', testData);
            
            const retrieved = window.superAdminDataSync.getOfflineData('/test');
            const isValid = window.superAdminDataSync.isOfflineDataValid(Date.now());
            
            log(`Offline storage test: Retrieved=${!!retrieved}, Valid=${isValid}`);
            updateConnectionStatus();
        }

        function clearAllData() {
            log('Clearing all cached and offline data...');
            window.superAdminDataSync.clearCache();
            localStorage.removeItem('offlineData');
            localStorage.removeItem('offlineQueue');
            dataDisplay.textContent = 'All data cleared';
            updateConnectionStatus();
        }

        function testQueuedRequest() {
            log('Testing queued request...');
            const testRequest = {
                endpoint: '/test',
                options: { method: 'POST', body: JSON.stringify({ test: true }) }
            };
            
            window.superAdminDataSync.queueOfflineRequest(testRequest.endpoint, testRequest.options);
            log('Test request queued');
            showQueueStatus();
        }

        function processQueue() {
            log('Processing offline queue...');
            window.superAdminDataSync.processOfflineQueue();
            setTimeout(() => {
                showQueueStatus();
                updateConnectionStatus();
            }, 1000);
        }

        function showQueueStatus() {
            const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
            queueStatus.textContent = `Queued requests: ${queue.length}\n${JSON.stringify(queue, null, 2)}`;
            log(`Queue status: ${queue.length} requests queued`);
        }

        function testRealtimeConnection() {
            log('Testing real-time connection...');
            if (window.superAdminDataSync.realtimeSync) {
                const status = window.superAdminDataSync.realtimeSync.getConnectionStatus();
                const isActive = window.superAdminDataSync.realtimeSync.isRealtimeActive();
                realtimeStatus.textContent = `Status: ${status}, Active: ${isActive}`;
                log(`Real-time connection test: Status=${status}, Active=${isActive}`);
            } else {
                realtimeStatus.textContent = 'Real-time sync not available';
                log('Real-time sync not available', 'error');
            }
        }

        function testRealtimeSubscription() {
            log('Testing real-time subscription...');
            if (window.superAdminDataSync.realtimeSync) {
                window.superAdminDataSync.subscribe('/dashboard', (data) => {
                    log(`Received real-time update: ${JSON.stringify(data)}`);
                });
                log('Subscribed to dashboard updates');
            } else {
                log('Real-time sync not available for subscription', 'error');
            }
        }

        function checkConnectionStatus() {
            updateConnectionStatus();
        }

        function clearLog() {
            testLog.textContent = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Super Admin Offline Test Page Loaded');
            
            // Wait for scripts to load
            setTimeout(() => {
                if (window.superAdminDataSync) {
                    log('Super admin data sync loaded successfully');
                    updateConnectionStatus();
                    
                    // Set up event listeners
                    window.superAdminDataSync.addEventListener('error', (message) => {
                        log(`Data sync error: ${message}`, 'error');
                    });
                    
                    window.superAdminDataSync.addEventListener('success', (message) => {
                        log(`Data sync success: ${message}`, 'success');
                    });
                    
                    // Listen for connection changes
                    window.addEventListener('online', () => {
                        log('Browser went online');
                        updateConnectionStatus();
                    });
                    
                    window.addEventListener('offline', () => {
                        log('Browser went offline');
                        updateConnectionStatus();
                    });
                    
                } else {
                    log('Super admin data sync not loaded', 'error');
                }
            }, 1000);
        });

        // Alpine.js component function
        function offlineTest() {
            return {
                async init() {
                    // Initialize backend integration
                    if (window.backendHelper) {
                        await window.backendHelper.initPage('offline-test', {
                            enableRealTime: false
                        });
                    }
                    
                    this.updateConnectionStatus();
                    this.setupEventListeners();
                },
                
                updateConnectionStatus() {
                    updateConnectionStatus();
                },
                
                setupEventListeners() {
                    if (window.superAdminDataSync) {
                        // Set up event listeners
                        window.superAdminDataSync.addEventListener('error', (message) => {
                            log(`Data sync error: ${message}`, 'error');
                        });
                        
                        window.superAdminDataSync.addEventListener('success', (message) => {
                            log(`Data sync success: ${message}`, 'success');
                        });
                        
                        // Listen for connection changes
                        window.addEventListener('online', () => {
                            log('Browser went online');
                            this.updateConnectionStatus();
                        });
                        
                        window.addEventListener('offline', () => {
                            log('Browser went offline');
                            this.updateConnectionStatus();
                        });
                    }
                },
                
                async testOfflineMode() {
                    if (window.backendHelper) {
                        try {
                            window.backendHelper.showNotification('Testing offline mode...', 'info');
                            // Simulate offline test
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            window.backendHelper.showNotification('Offline mode test completed', 'success');
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Offline Test');
                        }
                    }
                },
                
                async testSyncMode() {
                    if (window.backendHelper) {
                        try {
                            window.backendHelper.showNotification('Testing sync mode...', 'info');
                            // Simulate sync test
                            await new Promise(resolve => setTimeout(resolve, 1500));
                            window.backendHelper.showNotification('Sync mode test completed', 'success');
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Sync Test');
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
