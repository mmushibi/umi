<!DOCTYPE html>
<html lang="en" x-data="posSystem()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Point of Sale - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
  <!-- Using local CSS instead of CDN for production -->
  <link rel="stylesheet" href="../shared/css/shared-styles.css">
  <style>
    :root {
      --color-primary: #000000;
      --color-accent: #14B8A6;
      --color-success: #22c55e;
      --color-warning: #ef4444;
      --color-text-primary: #000000;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      --color-background: #ffffff;
      --color-surface: #f9fafb;
      --color-border: #e5e7eb;
      --font-primary: 'Inter', sans-serif;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      font-family: 'Nunito', 'Varela Round', sans-serif;
      font-size: 13px;
      line-height: 1.4;
      overflow-x: hidden;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--color-text-primary);
      color: var(--color-accent);
      z-index: 1000;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo-text {
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .nav-menu {
      padding: 1rem 0;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-accent);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-accent);
      border-left: 3px solid var(--color-accent);
    }

    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .pos-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 1.5rem;
      padding: 1.25rem;
      height: calc(100vh - 80px);
    }

    .products-section {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .search-bar {
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      font-size: 0.875rem;
      background: var(--color-surface);
    }

    .search-wrapper {
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-text-secondary);
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
    }

    .product-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--color-primary);
    }

    .product-icon {
      font-size: 2rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }

    .product-name {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .product-price {
      color: var(--color-text-secondary);
      font-size: 0.75rem;
    }

    .cart-section {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .cart-header {
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--color-surface);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .cart-item-price {
      color: var(--color-text-secondary);
      font-size: 0.75rem;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .quantity-btn {
      width: 24px;
      height: 24px;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    .quantity-btn:hover {
      background: var(--color-surface);
    }

    .cart-summary {
      padding: 1rem;
      border-top: 1px solid var(--color-border);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .summary-row.total {
      font-weight: 700;
      font-size: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--color-border);
    }

    .payment-section {
      padding: 1rem;
      border-top: 1px solid var(--color-border);
    }

    .payment-methods {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .payment-btn {
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-size: 0.75rem;
    }

    .payment-btn:hover {
      background: var(--color-surface);
    }

    .payment-btn.active {
      background: var(--color-primary);
      color: var(--color-accent);
      border-color: var(--color-primary);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background: var(--color-text-secondary);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .btn-danger {
      background: var(--color-warning);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--color-border);
      border-radius: 12px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--color-background);
      font-weight: 500;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      background: white;
    }

    .cash-payment {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid var(--color-border);
    }

    .change-amount {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #166534;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 2px solid #22c55e;
      animation: slideIn 0.3s ease-out;
    }

    .change-amount .material-symbols-rounded {
      font-size: 1.25rem;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .insufficient-payment {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #dc2626;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      border: 2px solid #ef4444;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .logout-section {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }

    .logout-button {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
    }

    .logout-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    .mobile-menu.pos-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      height: calc(100vh - 120px);
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      .pos-container {
        grid-template-columns: 1fr;
        gap: 0.75rem;
        height: calc(100vh - 100px);
      }
      
      .cart-section {
        order: -1;
        max-height: 300px;
        overflow-y: auto;
      }
    }

    @media (max-width: 768px) {
      .pos-container {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        height: calc(100vh - 80px);
      }
      
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        padding: 0.75rem;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .product-card {
        padding: 0.75rem;
        min-height: 80px;
      }
      
      .cart-section {
        position: sticky;
        bottom: 0;
        background: var(--color-background);
        border-top: 1px solid var(--color-border);
        padding: 1rem;
        max-height: 40vh;
        overflow-y: auto;
      }
      
      .payment-section {
        padding: 0.75rem;
      }
      
      .btn {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        min-height: 44px;
      }
      
      .form-input {
        font-size: 16px;
        padding: 0.875rem;
        min-height: 44px;
      }
      
      .header {
        padding: 1rem 0.75rem;
      }
      
      .search-bar {
        padding: 0.75rem;
      }
      
      .search-input {
        padding: 0.875rem;
        font-size: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .pos-container {
        grid-template-columns: 1fr;
        gap: 0.25rem;
        height: calc(100vh - 60px);
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        gap: 0.25rem;
        padding: 0.25rem;
      }
      
      .product-card {
        padding: 0.5rem;
        min-height: 60px;
      }
      
      .cart-item {
        padding: 0.5rem 0;
      }
      
      .quantity-btn {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }
      
      .modal-content {
        max-width: 98vw;
        max-height: 98vh;
        margin: 1vh auto;
        border-radius: 12px;
      }
      
      .btn {
        padding: 0.625rem 0.875rem;
        font-size: 0.8rem;
        min-height: 40px;
      }
      
      .form-input {
        font-size: 14px;
        padding: 0.625rem;
        min-height: 40px;
      }
      
      .header {
        padding: 0.75rem 0.5rem;
      }
      
      .search-bar {
        padding: 0.5rem;
      }
      
      .search-input {
        padding: 0.625rem;
        font-size: 14px;
      }
      
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>

    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="point-of-sale.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">point_of_sale</span>
        <span>Point of Sale</span>
      </a>
      <a href="patients.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="sales.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">receipt_long</span>
        <span>Sales</span>
      </a>
      <a href="payments.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">payments</span>
        <span>Payments</span>
      </a>
      <a href="inventory-quick.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory</span>
        <span>Inventory</span>
      </a>
      <a href="queue-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">queue</span>
        <span>Queue</span>
      </a>
      <a href="shift-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">schedule</span>
        <span>Shift Management</span>
      </a>
      <a href="reports.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">summarize</span>
        <span>Reports</span>
      </a>
      <a href="help.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">help</span>
        <span>Help & Training</span>
      </a>
      <a href="account.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">settings</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        <h1 class="page-title">Point of Sale</h1>
      </div>
    </header>

    <!-- POS Container -->
    <div class="pos-container">
      <!-- Products Section -->
      <div class="products-section">
        <div class="search-bar">
          <div class="search-wrapper">
            <span class="material-symbols-rounded search-icon">search</span>
            <input type="text" class="search-input" x-model="searchQuery" placeholder="Search products...">
          </div>
        </div>
        
        <div class="products-grid">
          <template x-for="product in filteredProducts" :key="product.id">
            <div class="product-card" @click="addToCart(product)">
              <div class="product-icon">
                <span class="material-symbols-rounded" x-text="product.icon"></span>
              </div>
              <div class="product-name" x-text="product.name"></div>
              <div class="product-price" x-text="'ZMW ' + product.price.toFixed(2)"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Cart Section -->
      <div class="cart-section">
        <div class="cart-header">
          Shopping Cart (<span x-text="cartItems.length"></span>)
        </div>
        
        <div class="cart-items">
          <template x-for="item in cartItems" :key="item.id">
            <div class="cart-item">
              <div class="cart-item-info">
                <div class="cart-item-name" x-text="item.name"></div>
                <div class="cart-item-price" x-text="'ZMW ' + item.price.toFixed(2)"></div>
              </div>
              <div class="quantity-controls">
                <button class="quantity-btn" @click="updateQuantity(item.id, item.quantity - 1)">-</button>
                <span x-text="item.quantity"></span>
                <button class="quantity-btn" @click="updateQuantity(item.id, item.quantity + 1)">+</button>
                <button class="quantity-btn" @click="removeFromCart(item.id)" style="color: var(--color-warning);">Ã—</button>
              </div>
            </div>
          </template>
          
          <div x-show="cartItems.length === 0" style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">
            Cart is empty
          </div>
        </div>
        
        <div class="cart-summary">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span x-text="'ZMW ' + subtotal.toFixed(2)"></span>
          </div>
          <div class="summary-row">
            <span>Tax (16%):</span>
            <span x-text="'ZMW ' + tax.toFixed(2)"></span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span x-text="'ZMW ' + total.toFixed(2)"></span>
          </div>
          
          <div x-show="paymentMethod === 'cash'" class="cash-payment">
            <div style="margin-bottom: 0.75rem; font-weight: 600; color: var(--color-text-primary); display: flex; align-items: center; gap: 0.5rem;">
              <span class="material-symbols-rounded">payments</span>
              Amount Received:
            </div>
            <input type="number" 
                   class="form-input" 
                   x-model="amountReceived" 
                   placeholder="Enter amount received"
                   step="0.01"
                   min="0">
            
            <div x-show="amountReceived && parseFloat(amountReceived) > 0" style="margin-top: 0.75rem;">
              <div x-show="parseFloat(amountReceived) >= total" class="change-amount">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span class="material-symbols-rounded">savings</span>
                  <span>Change to Give Back:</span>
                </div>
                <span x-text="'ZMW ' + (parseFloat(amountReceived) - total).toFixed(2)"></span>
              </div>
              
              <div x-show="parseFloat(amountReceived) < total && amountReceived" class="insufficient-payment">
                <span class="material-symbols-rounded">error_outline</span>
                <span>Insufficient amount: Need ZMW <span x-text="(total - parseFloat(amountReceived)).toFixed(2)"></span> more</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="payment-section">
          <div class="payment-methods">
            <button class="payment-btn" :class="paymentMethod === 'cash' ? 'active' : ''" @click="paymentMethod = 'cash'">
              <span class="material-symbols-rounded">payments</span>
              Cash
            </button>
            <button class="payment-btn" :class="paymentMethod === 'card' ? 'active' : ''" @click="paymentMethod = 'card'">
              <span class="material-symbols-rounded">credit_card</span>
              Card
            </button>
            <button class="payment-btn" :class="paymentMethod === 'mobile' ? 'active' : ''" @click="paymentMethod = 'mobile'">
              <span class="material-symbols-rounded">smartphone</span>
              Mobile
            </button>
            <button class="payment-btn" :class="paymentMethod === 'insurance' ? 'active' : ''" @click="paymentMethod = 'insurance'">
              <span class="material-symbols-rounded">health_and_safety</span>
              Insurance
            </button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <button class="btn btn-secondary" @click="console.log('Void button clicked'); voidSale()">
              <span class="material-symbols-rounded">cancel</span>
              Void
            </button>
            <button class="btn btn-secondary" @click="console.log('Clear button clicked'); clearCart()">
              <span class="material-symbols-rounded">clear</span>
              Clear
            </button>
            <button class="btn btn-primary" @click="console.log('Pay button clicked'); processPayment()" :disabled="cartItems.length === 0 || isProcessingPayment || (paymentMethod === 'cash' && (!amountReceived || parseFloat(amountReceived) < total))">
              <span x-show="!isProcessingPayment" class="material-symbols-rounded">paid</span>
              <span x-show="isProcessingPayment" class="material-symbols-rounded animate-spin">hourglass_empty</span>
              <span x-text="isProcessingPayment ? 'Processing...' : 'Pay'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Receipt Modal -->
  <div x-show="showReceipt" x-transition class="modal-overlay" @click.self="showReceipt = false" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div x-show="currentReceipt" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-90" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-90" class="modal-content" style="max-width: 90vw; max-height: 90vh; overflow: hidden; background: white; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
      <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--color-text-primary); margin: 0;">Transaction Receipt</h3>
        <button class="modal-close" @click="showReceipt = false" style="background: none; border: none; font-size: 1.5rem; color: var(--color-text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.2s ease;">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 0; overflow-y: auto; max-height: calc(90vh - 140px);">
        <iframe id="receiptFrame" x-show="currentReceipt" style="width: 100%; height: 100%; border: none; min-height: 500px;" src="../cashier/receipt-template.html"></iframe>
      </div>
      <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid var(--color-border); display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-secondary" @click="printReceipt" style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="material-symbols-rounded">print</span>
          Print Receipt
        </button>
        <button class="btn btn-primary" @click="downloadReceipt" style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="material-symbols-rounded">download</span>
          Download PDF
        </button>
        <button class="btn btn-secondary" @click="showReceipt = false" style="background: var(--color-surface); color: var(--color-text-secondary);">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      console.log('Alpine.js initialized');
    });

    function posSystem() {
      console.log('POS System initializing...');
      return {
        sidebarOpen: false,
        searchQuery: '',
        paymentMethod: 'cash',
        cartItems: [],
        amountReceived: '',
        showReceipt: false,
        currentReceipt: null,
        receiptCounter: 1000,
        isProcessingPayment: false,
        products: [],
        
        // Initialize products from backend
        async loadProducts() {
          try {
            const response = await fetch('/api/products');
            if (response.ok) {
              this.products = await response.json();
            } else {
              console.warn('No products available from backend');
              this.products = [];
            }
          } catch (error) {
            console.error('Failed to load products:', error);
            this.products = [];
          }
        },
        
        // Initialize products when page loads
        async init() {
          await this.loadProducts();
          console.log('Products loaded:', this.products.length);
        },
        
        get filteredProducts() {
          if (!this.searchQuery) return this.products;
          return this.products.filter(product => 
            product.name.toLowerCase().includes(this.searchQuery.toLowerCase())
          );
        },
        
        get subtotal() {
          return this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        },
        
        get tax() {
          return this.subtotal * 0.16;
        },
        
        get total() {
          return this.subtotal + this.tax;
        },
        
        addToCart(product) {
          const existingItem = this.cartItems.find(item => item.id === product.id);
          if (existingItem) {
            existingItem.quantity++;
          } else {
            this.cartItems.push({ ...product, quantity: 1 });
          }
        },
        
        updateQuantity(productId, newQuantity) {
          if (newQuantity <= 0) {
            this.removeFromCart(productId);
            return;
          }
          
          const item = this.cartItems.find(item => item.id === productId);
          if (item) {
            item.quantity = newQuantity;
          }
        },
        
        removeFromCart(productId) {
          this.cartItems = this.cartItems.filter(item => item.id !== productId);
        },
        
        clearCart() {
          this.cartItems = [];
          this.amountReceived = '';
        },
        
        voidSale() {
          console.log('Void sale clicked');
          if (this.cartItems.length === 0) {
            alert('Cart is already empty');
            return;
          }
          
          if (confirm('Are you sure you want to void this sale?')) {
            this.cartItems = [];
            this.amountReceived = '';
            alert('Sale has been voided');
          }
        },
        
        processPayment() {
          console.log('Process payment clicked');
          console.log('Cart items:', this.cartItems.length);
          console.log('Payment method:', this.paymentMethod);
          console.log('Amount received:', this.amountReceived);
          console.log('Total:', this.total);
          
          if (this.cartItems.length === 0) {
            alert('Cart is empty');
            return;
          }
          
          if (this.paymentMethod === 'cash') {
            if (!this.amountReceived || this.amountReceived === '') {
              alert('Please enter amount received');
              return;
            }
            if (parseFloat(this.amountReceived) < this.total) {
              alert('Insufficient amount. Please enter at least ZMW ' + this.total.toFixed(2));
              return;
            }
          }
          
          // Process payment based on method
          this.processPaymentByMethod();
        },
        
        processPaymentByMethod(method) {
          this.isProcessingPayment = true;
          
          // Simulate API call for different payment methods
          setTimeout(() => {
            let success = true;
            let transactionId = '';
            
            switch(method) {
              case 'mobile':
                transactionId = 'MOBILE_' + Date.now();
                break;
              case 'card':
                transactionId = 'CARD_' + Date.now();
                break;
              case 'insurance':
                transactionId = 'INS_' + Date.now();
                break;
              case 'cash':
                transactionId = 'CASH_' + Date.now();
                break;
            }
            
            if (success) {
              const change = this.paymentMethod === 'cash' ? parseFloat(this.amountReceived) - this.total : 0;
              
              this.currentReceipt = {
                number: 'R' + (++this.receiptCounter),
                date: new Date().toLocaleString(),
                cashier: this.getCashierName(),
                paymentMethod: this.paymentMethod.charAt(0).toUpperCase() + this.paymentMethod.slice(1),
                transactionType: 'SALE',
                merchantId: this.getMerchantId(),
                terminalId: this.getTerminalId(),
                status: 'APPROVED',
                authCode: this.generateAuthCode(),
                statusCode: '00',
                rrn: this.generateRRN(),
                stan: this.generateSTAN(),
                aid: this.generateAID(),
                maskedCardNumber: this.generateMaskedCardNumber(),
                cardType: this.generateCardType(),
                accountType: this.generateAccountType(),
                phoneNumber: this.paymentMethod === 'mobile' ? this.getPhoneNumber() : null,
                insuranceProvider: this.paymentMethod === 'insurance' ? this.getInsuranceProvider() : null,
                policyNumber: this.paymentMethod === 'insurance' ? this.getPolicyNumber() : null,
                memberNumber: this.paymentMethod === 'insurance' ? this.getMemberNumber() : null,
                transactionId: transactionId,
                items: [...this.cartItems],
                subtotal: this.subtotal,
                tax: this.tax,
                total: this.total,
                change: change
              };
              
              this.showReceipt = true;
              this.cartItems = [];
              this.amountReceived = '';
              
              // Send receipt data to iframe after a short delay
              setTimeout(() => {
                this.sendReceiptDataToIframe();
              }, 500);
              
              console.log('Payment processed successfully');
            } else {
              alert('Payment failed. Please try again.');
            }
            
            this.isProcessingPayment = false;
          }, 2000);
        },
        
        sendReceiptDataToIframe() {
          const iframe = document.getElementById('receiptFrame');
          if (iframe && iframe.contentWindow && this.currentReceipt) {
            iframe.contentWindow.postMessage({
              type: 'RECEIPT_DATA',
              receiptData: this.currentReceipt
            }, '*');
            console.log('Receipt data sent to iframe:', this.currentReceipt);
          } else {
            console.error('Could not send receipt data to iframe');
          }
        },
        
        // Initialize products when page loads
        async init() {
          await this.loadProducts();
          console.log('Products loaded:', this.products.length);
        },
        getCashierName() {
          return localStorage.getItem('cashierName') || 'Cashier';
        },
        
        getMerchantId() {
          return localStorage.getItem('merchantId') || 'MER001';
        },
        
        getTerminalId() {
          return localStorage.getItem('terminalId') || 'TER001';
        },
        
        getPhoneNumber() {
          const phone = prompt('Enter customer phone number for mobile payment:');
          return phone || '+260123456789';
        },
        
        getExpiryDate() {
          const expiry = prompt('Enter expiry date (MM/YY):');
          return expiry || '12/25';
        },
        
        getCVV() {
          const cvv = prompt('Enter CVV:');
          return cvv || '123';
        },
        
        getInsuranceProvider() {
          const provider = prompt('Enter insurance provider:');
          return provider || 'Insurance Provider';
        },
        
        getPolicyNumber() {
          const policy = prompt('Enter policy number:');
          return policy || 'POL123456';
        },
        
        getMemberNumber() {
          const member = prompt('Enter member number:');
          return member || 'MEM789012';
        },
        
        simulateDelay(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        },
        
        // Professional receipt data generators
        generateAuthCode() {
          return Math.floor(100000 + Math.random() * 900000).toString();
        },
        
        generateRRN() {
          return Date.now().toString().slice(-12);
        },
        
        generateSTAN() {
          return Math.floor(100000 + Math.random() * 900000).toString();
        },
        
        generateAID() {
          const aids = ['A0000000031010', 'A0000000031010', 'A0000001524010'];
          return aids[Math.floor(Math.random() * aids.length)];
        },
        
        generateMaskedCardNumber() {
          const prefixes = ['424242', '555555', '378282'];
          const suffixes = ['1234', '5678', '9012'];
          const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
          const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
          return `${prefix}******${suffix}`;
        },
        
        generateCardType() {
          // Generate random card type based on payment method
          const cardTypes = ['Visa', 'Mastercard', 'American Express', 'Debit'];
          return cardTypes[Math.floor(Math.random() * cardTypes.length)];
        },
        
        generateAccountType() {
          const types = ['Checking', 'Savings', 'Credit'];
          return types[Math.floor(Math.random() * types.length)];
        },
        
        printReceipt() {
          const iframe = document.getElementById('receiptFrame');
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.print();
          } else {
            // Fallback to window print
            window.print();
          }
        },
        
        downloadReceipt() {
          if (!this.currentReceipt) {
            console.error('No receipt data available');
            return;
          }
          
          // Send PDF download request to iframe
          const iframe = document.getElementById('receiptFrame');
          if (iframe && iframe.contentWindow) {
            // Wait for iframe to be ready
            setTimeout(() => {
              if (iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                  type: 'RECEIPT_DATA',
                  receiptData: this.currentReceipt
                }, '*');
              } else {
                console.error('Iframe not ready for communication');
                // Fallback: try to download PDF directly
                this.downloadPDFDirectly();
              }
            }, 1000);
          } else {
            // Fallback: try to download PDF directly
            this.downloadPDFDirectly();
          }
        },
        
        downloadPDFDirectly() {
          // Check if jsPDF is available
          if (typeof window.jspdf === 'undefined') {
            console.error('jsPDF library not available');
            alert('PDF library not loaded. Please refresh the page and try again.');
            return;
          }
          
          try {
            const { jsPDF } = window.jspdf;
            
            // Create PDF document
            const doc = new jsPDF({
              orientation: 'portrait',
              unit: 'mm',
              format: [80, 120], // Thermal printer width
              putOnly: true
            });
            
            // Add receipt content
            doc.setFontSize(10);
            doc.setFont('helvetica');
            
            // Header
            doc.setFont('helvetica', 'bold', 12);
            doc.text('UMI HEALTH PHARMACY', 105, 20, { align: 'center' });
            doc.setFont('helvetica', 'normal', 10);
            doc.text('123 Main Street, Lusaka, Zambia', 105, 30, { align: 'center' });
            doc.text('Tel: +260 123 456 789', 105, 40, { align: 'center' });
            doc.text('Email: info@umihealth.com', 105, 50, { align: 'center' });
            
            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, 60, 80, 120);
            doc.setLineWidth(0.1);
            
            // Receipt info
            doc.setFont('helvetica', 'bold', 10);
            doc.text(`Receipt #: ${this.currentReceipt.number}`, 20, 70);
            doc.text(`Date: ${this.currentReceipt.date}`, 20, 80);
            doc.text(`Cashier: ${this.currentReceipt.cashier}`, 20, 90);
            doc.text(`Payment: ${this.currentReceipt.paymentMethod}`, 20, 100);
            
            // Items
            let yPosition = 110;
            this.currentReceipt.items.forEach(item => {
              doc.setFont('helvetica', 'normal', 9);
              doc.text(item.name, 20, yPosition);
              doc.text(`${item.quantity} x ZMW ${item.price.toFixed(2)} = ZMW ${(item.price * item.quantity).toFixed(2)}`, 120, yPosition);
              yPosition += 10;
            });
            
            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, yPosition + 10, 80, 120);
            doc.setLineWidth(0.1);
            
            // Summary
            doc.setFont('helvetica', 'bold', 10);
            doc.text(`Subtotal: ZMW ${this.currentReceipt.subtotal.toFixed(2)}`, 20, yPosition + 20);
            doc.text(`Tax (16%): ZMW ${this.currentReceipt.tax.toFixed(2)}`, 20, yPosition + 30);
            doc.text(`Total: ZMW ${this.currentReceipt.total.toFixed(2)}`, 20, yPosition + 40);
            
            // Footer
            doc.setFont('helvetica', 'normal', 8);
            doc.text('Thank you for your purchase!', 105, yPosition + 60, { align: 'center' });
            doc.text('Please come again', 105, yPosition + 70, { align: 'center' });
            doc.text('** This is a computer-generated receipt **', 105, yPosition + 80, { align: 'center' });
            doc.text('Valid for returns within 30 days', 105, yPosition + 90, { align: 'center' });
            doc.text('Pharmacy License No: ZMP-2024-001', 105, yPosition + 100, { align: 'center' });
            
            // Save PDF
            const pdfBlob = doc.output('blob');
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt_${this.currentReceipt.number.replace('#', '')}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('PDF downloaded successfully');
            alert('PDF receipt downloaded successfully!');
            
          } catch (error) {
            console.error('PDF generation failed:', error);
            alert('Failed to generate PDF: ' + error.message);
          }
        },
        
        logout() {
          if (confirm('Are you sure you want to logout?')) {
            window.location.href = '../public/admin-signin.html';
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // Initialize POS system when Alpine.js is ready
    document.addEventListener('alpine:initialized', () => {
      // Get the Alpine.js data and initialize products
      Alpine.effect(() => {
        const posData = Alpine.$data(document.querySelector('[x-data]'));
        if (posData && posData.init) {
          posData.init();
        }
      });
    });
    
    // Fallback initialization if Alpine.js doesn't load properly
    setTimeout(() => {
      if (typeof Alpine === 'undefined') {
        console.error('Alpine.js failed to load');
        document.querySelectorAll('[@click]').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Fallback click handler for:', this.textContent);
          });
        });
      } else {
        console.log('Alpine.js is available');
      }
    }, 2000);
  </script>
</body>
</html>
