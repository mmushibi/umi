<!DOCTYPE html>
<html lang="en" x-data="signup()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sign Up | Umi Health Pharmacy</title>
  <link rel="icon" href="../logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-primary-blue: #2563EB;
      --color-accent-teal: #14B8A6;
      --color-text-white: #FFFFFF;
      --font-primary: 'Inter', sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-accent-teal) 100%);
      color: var(--color-text-white);
      font-family: 'Nunito', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .signup-container {
      width: 100%;
      max-width: 450px;
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-accent-teal);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .submit-button {
      width: 100%;
      padding: 1rem;
      background: var(--color-accent-teal);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .submit-button:hover:not(:disabled) {
      background: #0d9488;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .success-message {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 1.2rem;
      height: 1.2rem;
      accent-color: var(--color-accent-teal);
    }

    .checkbox-wrapper label {
      font-size: 0.9rem;
      cursor: pointer;
    }

    .checkbox-wrapper a {
      color: var(--color-accent-teal);
      text-decoration: none;
    }

    .checkbox-wrapper a:hover {
      text-decoration: underline;
    }

    .loading-spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .password-requirements {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .password-requirements ul {
      list-style: none;
      padding: 0;
    }

    .password-requirements li {
      margin-bottom: 0.25rem;
      padding-left: 1rem;
      position: relative;
    }

    .password-requirements li.met {
      color: #86efac;
    }

    .password-requirements li.met::before {
      content: "✓";
      position: absolute;
      left: 0;
    }

    .password-requirements li:not(.met)::before {
      content: "○";
      position: absolute;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="signup-container">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold mb-2">Create Pharmacy Account</h1>
      <p class="opacity-80">Join Umi Health Pharmacy Management System</p>
    </div>

    <form @submit.prevent="handleSignup">
      <div class="form-group">
        <label class="form-label" for="pharmacyName">Pharmacy Name</label>
        <input 
          type="text" 
          id="pharmacyName"
          class="form-input" 
          x-model="form.pharmacyName"
          placeholder="Enter your pharmacy name"
          required
          @blur="checkPharmacyName"
        >
        <div x-show="fieldErrors.pharmacyName" class="text-red-300 text-sm mt-1" x-text="fieldErrors.pharmacyName"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="email">Email Address</label>
        <input 
          type="email" 
          id="email"
          class="form-input" 
          x-model="form.email"
          placeholder="Enter your email"
          required
        >
        <div x-show="fieldErrors.email" class="text-red-300 text-sm mt-1" x-text="fieldErrors.email"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="phoneNumber">Phone Number</label>
        <input 
          type="tel" 
          id="phoneNumber"
          class="form-input" 
          x-model="form.phoneNumber"
          placeholder="Enter your phone number"
          required
        >
        <div x-show="fieldErrors.phoneNumber" class="text-red-300 text-sm mt-1" x-text="fieldErrors.phoneNumber"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input 
          type="password" 
          id="password"
          class="form-input" 
          x-model="form.password"
          placeholder="Create a strong password"
          required
          @input="checkPasswordStrength"
        >
        <div x-show="fieldErrors.password" class="text-red-300 text-sm mt-1" x-text="fieldErrors.password"></div>
      </div>

      <div class="checkbox-wrapper">
        <input 
          type="checkbox" 
          id="acceptTerms"
          x-model="form.acceptTerms"
          required
        >
        <label for="acceptTerms">
          I agree to the <a href="#" @click.prevent="showTerms = true">Terms of Service</a> and <a href="#" @click.prevent="showPrivacy = true">Privacy Policy</a>
        </label>
      </div>

      <button 
        type="submit" 
        class="submit-button"
        :disabled="loading || !isFormValid"
        title="Create Account"
      >
        <div x-show="loading" class="loading-spinner"></div>
        <span x-text="loading ? 'Creating Account...' : 'Create Account'"></span>
      </button>
    </form>

    <div class="text-center mt-6">
      <p class="opacity-80">
        Already have an account? 
        <a href="signin.html" class="text-accent-teal hover:underline">Sign In</a>
      </p>
    </div>
  </div>

  <script>
    function signup() {
      return {
        form: {
          pharmacyName: '',
          email: '',
          phoneNumber: '',
          password: '',
          acceptTerms: false
        },
        passwordRequirements: {
          hasMinLength: false,
          hasLetter: false,
          hasNumber: false
        },
        fieldErrors: {},
        loading: false,
        errorMessage: '',
        successMessage: '',
        showTerms: false,
        showPrivacy: false,

        get isFormValid() {
          const requiredFields = ['pharmacyName', 'email', 'phoneNumber', 'password'];
          const allFilled = requiredFields.every(field => Boolean(this.form[field]));
          
          return allFilled &&
                 this.form.acceptTerms &&
                 this.form.password.length >= 6 &&
                 Object.keys(this.fieldErrors).length === 0;
        },

        checkPasswordStrength() {
          const password = this.form.password;
          
          this.passwordRequirements = {
            hasMinLength: password.length >= 6,
            hasLetter: /[a-zA-Z]/.test(password),
            hasNumber: /\d/.test(password)
          };
        },

        async checkPharmacyName() {
          if (!this.form.pharmacyName || this.form.pharmacyName.length < 3) {
            this.fieldErrors.pharmacyName = '';
            return;
          }

          try {
            const response = await fetch(`http://localhost:5001/api/v1/auth/check-pharmacy-name/${encodeURIComponent(this.form.pharmacyName)}`);
            const result = await response.json();
            
            if (!result.success || !result.available) {
              this.fieldErrors.pharmacyName = result.message || 'Pharmacy name not available';
            } else {
              this.fieldErrors.pharmacyName = '';
            }
          } catch (error) {
            console.error('Error checking pharmacy name:', error);
            this.fieldErrors.pharmacyName = '';
          }
        },

        async handleSignup() {
          console.log('Starting signup process...');
          this.loading = true;
          this.errorMessage = '';
          this.successMessage = '';

          try {
            console.log('Sending signup request:', {
              pharmacyName: this.form.pharmacyName,
              adminFullName: this.form.pharmacyName,
              email: this.form.email,
              phoneNumber: this.form.phoneNumber,
              password: this.form.password
            });
            
            const response = await fetch('http://localhost:5001/api/v1/auth/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                pharmacyName: this.form.pharmacyName,
                adminFullName: this.form.pharmacyName, // Use pharmacy name as admin name for simplicity
                email: this.form.email,
                phoneNumber: this.form.phoneNumber,
                password: this.form.password
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error('API Error:', errorData);
              throw new Error(errorData.message || 'Registration failed');
            }

            const result = await response.json();
            console.log('API Response:', result);

            if (result.success) {
              this.successMessage = 'Account created successfully! Setting up your pharmacy...';
              
              // Store auth data
              localStorage.setItem('umi_access_token', result.accessToken);
              localStorage.setItem('umi_refresh_token', result.refreshToken);
              localStorage.setItem('umi_current_user', JSON.stringify(result.user));
              localStorage.setItem('umi_current_tenant', JSON.stringify(result.tenant));
              localStorage.setItem('umi_tenant_id', result.tenant.id);
              
              // Always redirect to onboarding first for new users
              setTimeout(() => {
                window.location.href = '/public/onboarding.html';
              }, 1500);
            } else {
              this.errorMessage = result.message || 'Registration failed. Please try again.';
            }
          } catch (error) {
            console.error('Registration error:', error);
            this.errorMessage = 'Network error. Please check your connection and try again.';
          } finally {
            this.loading = false;
          }
        }
      }
    }
  </script>
</body>
</html>
