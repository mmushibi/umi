<!DOCTYPE html>
<html lang="en" x-data="additionalUsersManagement()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Additional Users Management - Umi Health Operations</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Backend Integration Libraries -->
    <script src="../../js/api-client.js"></script>
    <script src="../../js/auth-manager.js"></script>
    <script src="../shared/js/backend-integration-helper.js"></script>
    <script src="../shared/js/page-integration-template.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .notification-badge {
            animation: pulse 2s infinite;
            width: 6px;
            height: 6px;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .status-pending { background-color: #FEF3C7; color: #92400E; font-size: 0.625rem; padding: 0.25rem 0.5rem; border-radius: 6px; }
        .status-approved { background-color: #D1FAE5; color: #065F46; font-size: 0.625rem; padding: 0.25rem 0.5rem; border-radius: 6px; }
        .status-rejected { background-color: #FEE2E2; color: #991B1B; font-size: 0.625rem; padding: 0.25rem 0.5rem; border-radius: 6px; }
        .status-paid { background-color: #DBEAFE; color: #1E40AF; font-size: 0.625rem; padding: 0.25rem 0.5rem; border-radius: 6px; }
        body { font-size: 13px; line-height: 1.4; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-lg font-semibold text-gray-900">Additional Users Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="text-gray-500 hover:text-gray-700" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="relative">
                        <i class="fas fa-bell text-gray-500"></i>
                        <span id="notificationCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center notification-badge">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-full">
                        <i class="fas fa-clock text-yellow-600 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-xs font-medium text-gray-500">Pending Requests</h3>
                        <p id="pendingCount" class="text-lg font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-xs font-medium text-gray-500">Approved Today</h3>
                        <p id="approvedCount" class="text-lg font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-full">
                        <i class="fas fa-times-circle text-red-600 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-xs font-medium text-gray-500">Rejected Today</h3>
                        <p id="rejectedCount" class="text-lg font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-full">
                        <i class="fas fa-money-bill-wave text-blue-600 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-xs font-medium text-gray-500">Revenue This Month</h3>
                        <p id="revenueCount" class="text-lg font-semibold text-gray-900">K0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Requests Section -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-3 border-b border-gray-200">
                <h2 class="text-base font-medium text-gray-900">Pending Additional User Requests</h2>
                <p class="text-xs text-gray-500">Review and approve or reject requests for additional users beyond subscription limits</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request ID</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Details</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscription</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Users</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Charge</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingRequestsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Requests will be populated here -->
                    </tbody>
                </table>
                <div id="noPendingRequests" class="hidden text-center py-6">
                    <i class="fas fa-inbox text-gray-400 text-3xl mb-3"></i>
                    <p class="text-gray-500 text-sm">No pending additional user requests</p>
                </div>
            </div>
        </div>

        <!-- Monthly Billing Report -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-3 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-base font-medium text-gray-900">Monthly Billing Report</h2>
                        <p class="text-xs text-gray-500">Overview of additional user charges and payments</p>
                    </div>
                    <div class="flex space-x-2">
                        <label for="billingMonth" class="sr-only">Billing Month</label>
                        <select id="billingMonth" class="border rounded px-2 py-1 text-xs" title="Select billing month">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <button onclick="loadBillingReport()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700" title="Generate Report">
                            <i class="fas fa-search mr-1 text-xs"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div id="billingReportContent">
                    <!-- Billing report will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Approval Modal -->
    <div id="approvalModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-4 border w-80 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-base font-medium text-gray-900 mb-3">Confirm Approval</h3>
                <p id="approvalMessage" class="text-xs text-gray-500 mb-4"></p>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal('approvalModal')" class="px-3 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-xs">
                        Cancel
                    </button>
                    <button onclick="confirmApproval()" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                        <i class="fas fa-check mr-1 text-xs"></i>Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-4 border w-80 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-base font-medium text-gray-900 mb-3">Reject Request</h3>
                <p id="rejectionMessage" class="text-xs text-gray-500 mb-3"></p>
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700 mb-2">Rejection Reason</label>
                    <textarea id="rejectionReason" rows="2" class="w-full border rounded px-2 py-1 text-xs" placeholder="Please provide a reason for rejection..."></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal('rejectionModal')" class="px-3 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 text-xs">
                        Cancel
                    </button>
                    <button onclick="confirmRejection()" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-xs">
                        <i class="fas fa-times mr-1 text-xs"></i>Reject
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../shared/js/data-sync.js"></script>
    <script>
        let currentRequestId = null;
        let pendingRequests = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadPendingRequests();
            loadStats();
            setDefaultBillingMonth();
            
            // Auto-refresh every 30 seconds
            setInterval(loadPendingRequests, 30000);
            setInterval(loadStats, 60000);
        });

        async function loadPendingRequests() {
            try {
                const response = await fetch('/api/additionaluser/requests/pending', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    pendingRequests = await response.json();
                    renderPendingRequests();
                    updateNotificationCount();
                } else {
                    console.error('Failed to load pending requests');
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
            }
        }

        function renderPendingRequests() {
            const tbody = document.getElementById('pendingRequestsTable');
            const noRequests = document.getElementById('noPendingRequests');
            
            if (pendingRequests.length === 0) {
                tbody.innerHTML = '';
                noRequests.classList.remove('hidden');
                return;
            }
            
            noRequests.classList.add('hidden');
            tbody.innerHTML = pendingRequests.map(request => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap text-xs font-medium text-gray-900">
                        ${request.requestId}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-xs font-medium text-gray-900">${request.tenantName}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-xs text-gray-900">${request.userFirstName} ${request.userLastName}</div>
                        <div class="text-xs text-gray-500">${request.userEmail}</div>
                        <div class="text-xs text-gray-400">${request.userRole}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${request.subscriptionPlanAtRequest}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-900">
                        ${request.currentUserCount} / ${request.maxAllowedUsers}
                        <div class="text-xs text-gray-500">+${request.currentUserCount - request.maxAllowedUsers} users</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-xs font-medium text-gray-900">K${request.chargeAmount.toFixed(2)}</div>
                        <div class="text-xs text-gray-500">K50 per user</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">
                        ${formatDate(request.createdAt)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-xs font-medium">
                        <button onclick="showApprovalModal('${request.requestId}', '${request.tenantName}', '${request.userFirstName} ${request.userLastName}', ${request.chargeAmount})" 
                                class="text-green-600 hover:text-green-900 mr-2 text-xs">
                            <i class="fas fa-check text-xs"></i> Approve
                        </button>
                        <button onclick="showRejectionModal('${request.requestId}', '${request.tenantName}', '${request.userFirstName} ${request.userLastName}')" 
                                class="text-red-600 hover:text-red-900 text-xs">
                            <i class="fas fa-times text-xs"></i> Reject
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadStats() {
            try {
                // This would typically call a stats endpoint
                // For now, we'll calculate from pending requests
                const today = new Date().toDateString();
                const approvedToday = 0; // Would come from API
                const rejectedToday = 0; // Would come from API
                const monthlyRevenue = pendingRequests.reduce((sum, req) => sum + req.chargeAmount, 0);
                
                document.getElementById('pendingCount').textContent = pendingRequests.length;
                document.getElementById('approvedCount').textContent = approvedToday;
                document.getElementById('rejectedCount').textContent = rejectedToday;
                document.getElementById('revenueCount').textContent = `K${monthlyRevenue.toFixed(2)}`;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function showApprovalModal(requestId, tenantName, userName, chargeAmount) {
            currentRequestId = requestId;
            document.getElementById('approvalMessage').textContent = 
                `Approve additional user request for ${userName} from ${tenantName}? This will charge K${chargeAmount.toFixed(2)} to the tenant.`;
            document.getElementById('approvalModal').classList.remove('hidden');
        }

        function showRejectionModal(requestId, tenantName, userName) {
            currentRequestId = requestId;
            document.getElementById('rejectionMessage').textContent = 
                `Reject additional user request for ${userName} from ${tenantName}?`;
            document.getElementById('rejectionModal').classList.remove('hidden');
        }

        async function confirmApproval() {
            try {
                const response = await fetch(`/api/additionaluser/requests/${currentRequestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    closeModal('approvalModal');
                    showNotification('Request approved successfully', 'success');
                    loadPendingRequests();
                    loadStats();
                } else {
                    showNotification('Failed to approve request', 'error');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                showNotification('Error approving request', 'error');
            }
        }

        async function confirmRejection() {
            const rejectionReason = document.getElementById('rejectionReason').value;
            if (!rejectionReason.trim()) {
                showNotification('Please provide a rejection reason', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/additionaluser/requests/${currentRequestId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rejectionReason })
                });
                
                if (response.ok) {
                    closeModal('rejectionModal');
                    document.getElementById('rejectionReason').value = '';
                    showNotification('Request rejected successfully', 'success');
                    loadPendingRequests();
                    loadStats();
                } else {
                    showNotification('Failed to reject request', 'error');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                showNotification('Error rejecting request', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            currentRequestId = null;
        }

        function updateNotificationCount() {
            const count = pendingRequests.length;
            const badge = document.getElementById('notificationCount');
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }

        function setDefaultBillingMonth() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Populate the select dropdown with month options
            const select = document.getElementById('billingMonth');
            select.innerHTML = '';
            
            // Add last 12 months + current month
            for (let i = 0; i <= 12; i++) {
                const date = new Date(currentYear, currentMonth - i - 1, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                const option = document.createElement('option');
                option.value = `${year}-${month}`;
                option.textContent = monthName;
                if (i === 0) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        async function loadBillingReport() {
            const month = document.getElementById('billingMonth').value;
            const [year, monthNum] = month.split('-');
            
            try {
                const response = await fetch(`/api/additionaluser/operations/billing/${year}/${monthNum}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const report = await response.json();
                    renderBillingReport(report);
                } else {
                    showNotification('Failed to load billing report', 'error');
                }
            } catch (error) {
                console.error('Error loading billing report:', error);
                showNotification('Error loading billing report', 'error');
            }
        }

        function renderBillingReport(report) {
            const content = document.getElementById('billingReportContent');
            // This would render the actual billing report
            content.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">Billing report feature coming soon</p>
                </div>
            `;
        }

        function refreshData() {
            loadPendingRequests();
            loadStats();
            showNotification('Data refreshed', 'info');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function getAuthToken() {
            return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }

        function showNotification(message, type = 'info') {
            // Simple notification implementation
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Alpine.js component function
        function additionalUsersManagement() {
            return {
                async init() {
                    // Initialize backend integration
                    if (window.backendHelper) {
                        await window.backendHelper.initPage('additional-users', {
                            enableRealTime: true
                        });
                    }
                    
                    await this.loadPendingRequests();
                    await this.loadStats();
                },
                
                async loadPendingRequests() {
                    if (window.backendHelper) {
                        try {
                            const response = await window.backendHelper.apiCall('/api/users/pending-requests');
                            this.pendingRequests = response.data || [];
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Load Pending Requests');
                            this.pendingRequests = [];
                        }
                    } else {
                        await loadPendingRequests();
                    }
                },
                
                async loadStats() {
                    if (window.backendHelper) {
                        try {
                            const response = await window.backendHelper.apiCall('/api/users/stats');
                            this.stats = response.data || {};
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Load Stats');
                            this.stats = {};
                        }
                    } else {
                        await loadStats();
                    }
                },
                
                async refreshData() {
                    if (window.backendHelper) {
                        await this.loadPendingRequests();
                        await this.loadStats();
                        window.backendHelper.showNotification('Data refreshed successfully', 'success');
                    } else {
                        refreshData();
                    }
                },
                
                async approveUser(userId) {
                    if (window.backendHelper) {
                        try {
                            await window.backendHelper.apiCall(`/api/users/${userId}/approve`, {
                                method: 'POST'
                            });
                            window.backendHelper.showNotification('User approved successfully', 'success');
                            await this.loadPendingRequests();
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Approve User');
                        }
                    }
                },
                
                async rejectUser(userId) {
                    if (window.backendHelper) {
                        try {
                            await window.backendHelper.apiCall(`/api/users/${userId}/reject`, {
                                method: 'POST'
                            });
                            window.backendHelper.showNotification('User rejected successfully', 'success');
                            await this.loadPendingRequests();
                        } catch (error) {
                            window.backendHelper.handleError(error, 'Reject User');
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
