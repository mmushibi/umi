<!DOCTYPE html>
<html lang="en" x-data="reportsSystem()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reports - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/reports.css">
  </head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>

    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="point-of-sale.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">point_of_sale</span>
        <span>Point of Sale</span>
      </a>
      <a href="patients.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="sales.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">receipt_long</span>
        <span>Sales</span>
      </a>
      <a href="payments.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">payments</span>
        <span>Payments</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory_2</span>
        <span>Inventory</span>
      </a>
      <a href="queue-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">queue</span>
        <span>Queue</span>
      </a>
      <a href="shift-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">schedule</span>
        <span>Shift Management</span>
      </a>
      <a href="reports.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">summarize</span>
        <span>Reports</span>
      </a>
      <a href="help.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">help</span>
        <span>Help & Training</span>
      </a>
      <a href="account.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">settings</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        
        <div class="page-title-section">
          <h1 class="page-title">Reports</h1>
        </div>
      </div>

      <div class="header-right">
        <!-- Header right content available for future additions -->
      </div>
    </header>

    <!-- Reports Content -->
    <div class="reports-content">
      <!-- Filters Section -->
      <div class="filters-section">
        <h2 class="section-title">Report Filters</h2>
        <p class="section-description">Customize your reports by selecting date ranges and report types.</p>
        
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label" for="dateFrom">From Date</label>
            <input type="date" id="dateFrom" class="filter-input" x-model="filters.dateFrom">
          </div>
          <div class="filter-group">
            <label class="filter-label" for="dateTo">To Date</label>
            <input type="date" id="dateTo" class="filter-input" x-model="filters.dateTo">
          </div>
          <div class="filter-group">
            <label class="filter-label" for="reportType">Report Type</label>
            <select id="reportType" class="filter-input" x-model="filters.reportType">
              <option value="all">All Reports</option>
              <option value="sales">Sales Reports</option>
              <option value="inventory">Inventory Reports</option>
              <option value="patients">Patient Reports</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" for="shift">Shift</label>
            <select id="shift" class="filter-input" x-model="filters.shift">
              <option value="all">All Shifts</option>
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
              <option value="evening">Evening</option>
            </select>
          </div>
        </div>
        
        <div class="filter-actions">
          <button class="btn btn-secondary" @click="refreshAllData">
            <span class="material-symbols-rounded">refresh</span>
            <span>Refresh All</span>
          </button>
          <button class="btn btn-secondary" @click="resetFilters">
            <span class="material-symbols-rounded">restart_alt</span>
            <span>Reset</span>
          </button>
          <button class="btn btn-primary" @click="applyFilters">
            <span class="material-symbols-rounded">filter_list</span>
            <span>Apply Filters</span>
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="reports-grid">
        <div class="report-card">
          <div class="report-header">
            <h3 class="report-title">Total Sales</h3>
            <div class="report-icon">
              <span class="material-symbols-rounded">payments</span>
            </div>
          </div>
          <div class="report-value" x-text="formatCurrency(summary.totalSales)"></div>
          <div class="report-description">Revenue from all sales transactions</div>
          <div class="report-trend trend-up">
            <span class="material-symbols-rounded">trending_up</span>
            <span x-text="`${summary.salesGrowth}% from last period`"></span>
          </div>
        </div>

        <div class="report-card">
          <div class="report-header">
            <h3 class="report-title">Transactions</h3>
            <div class="report-icon">
              <span class="material-symbols-rounded">receipt_long</span>
            </div>
          </div>
          <div class="report-value" x-text="summary.totalTransactions.toLocaleString()"></div>
          <div class="report-description">Total number of transactions processed</div>
          <div class="report-trend trend-up">
            <span class="material-symbols-rounded">trending_up</span>
            <span x-text="`${summary.transactionsGrowth}% from last period`"></span>
          </div>
        </div>

        <div class="report-card">
          <div class="report-header">
            <h3 class="report-title">Items Sold</h3>
            <div class="report-icon">
              <span class="material-symbols-rounded">inventory</span>
            </div>
          </div>
          <div class="report-value" x-text="summary.itemsSold.toLocaleString()"></div>
          <div class="report-description">Total number of items sold</div>
          <div class="report-trend trend-down">
            <span class="material-symbols-rounded">trending_down</span>
            <span x-text="`${summary.itemsGrowth}% from last period`"></span>
          </div>
        </div>

        <div class="report-card">
          <div class="report-header">
            <h3 class="report-title">Average Transaction</h3>
            <div class="report-icon">
              <span class="material-symbols-rounded">calculate</span>
            </div>
          </div>
          <div class="report-value" x-text="formatCurrency(summary.averageTransaction)"></div>
          <div class="report-description">Average value per transaction</div>
          <div class="report-trend trend-up">
            <span class="material-symbols-rounded">trending_up</span>
            <span x-text="`${summary.averageGrowth}% from last period`"></span>
          </div>
        </div>
      </div>

      <!-- Detailed Reports -->
      <div class="detailed-reports">
        <h2 class="section-title">Detailed Reports</h2>
        <p class="section-description">View comprehensive reports for different aspects of your pharmacy operations.</p>
        
        <!-- Report Tabs -->
        <div class="report-tabs">
          <button class="tab-button" :class="activeTab === 'sales' ? 'active' : ''" @click="setActiveTab('sales')">Sales Reports</button>
          <button class="tab-button" :class="activeTab === 'inventory' ? 'active' : ''" @click="setActiveTab('inventory')">Inventory Reports</button>
          <button class="tab-button" :class="activeTab === 'patients' ? 'active' : ''" @click="setActiveTab('patients')">Patient Reports</button>
        </div>

        <!-- Sales Reports Tab -->
        <div class="tab-content" :class="activeTab === 'sales' ? 'active' : ''">
          <!-- Loading State -->
          <div x-show="loading.sales" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading sales reports...</p>
          </div>
          
          <!-- Sales Content -->
          <div x-show="!loading.sales">
            <div class="table-container">
              <table class="reports-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Transaction ID</th>
                    <th>Patient</th>
                    <th>Items</th>
                    <th>Total Amount</th>
                    <th>Payment Method</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="sale in salesData" :key="sale.id">
                    <tr>
                      <td x-text="formatDate(sale.date)"></td>
                      <td x-text="sale.transactionId"></td>
                      <td x-text="sale.patientName"></td>
                      <td x-text="sale.items"></td>
                      <td x-text="formatCurrency(sale.totalAmount)"></td>
                      <td x-text="sale.paymentMethod"></td>
                      <td>
                        <span class="status-badge" :class="sale.status.toLowerCase()" x-text="sale.status"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            
            <div class="export-options" style="margin-top: 1rem;">
              <button class="export-btn" @click="exportReport('sales', 'pdf')">
                <span class="material-symbols-rounded">picture_as_pdf</span>
                Export PDF
              </button>
              <button class="export-btn" @click="exportReport('sales', 'excel')">
                <span class="material-symbols-rounded">table_chart</span>
                Export Excel
              </button>
              <button class="export-btn" @click="exportReport('sales', 'csv')">
                <span class="material-symbols-rounded">description</span>
                Export CSV
              </button>
            </div>
          </div>
        </div>

        <!-- Inventory Reports Tab -->
        <div class="tab-content" :class="activeTab === 'inventory' ? 'active' : ''">
          <!-- Loading State -->
          <div x-show="loading.inventory" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading inventory reports...</p>
          </div>
          
          <!-- Inventory Content -->
          <div x-show="!loading.inventory">
            <div class="table-container">
              <table class="reports-table">
                <thead>
                  <tr>
                    <th>Medicine Name</th>
                    <th>Category</th>
                    <th>Current Stock</th>
                    <th>Reorder Level</th>
                    <th>Unit Price</th>
                    <th>Total Value</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="item in inventoryData" :key="item.id">
                    <tr>
                      <td x-text="item.medicineName"></td>
                      <td x-text="item.category"></td>
                      <td x-text="item.currentStock"></td>
                      <td x-text="item.reorderLevel"></td>
                      <td x-text="formatCurrency(item.unitPrice)"></td>
                      <td x-text="formatCurrency(item.totalValue)"></td>
                      <td>
                        <span class="status-badge" :class="item.status.toLowerCase()" x-text="item.status"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            
            <div class="export-options" style="margin-top: 1rem;">
              <button class="export-btn" @click="exportReport('inventory', 'pdf')">
                <span class="material-symbols-rounded">picture_as_pdf</span>
                Export PDF
              </button>
              <button class="export-btn" @click="exportReport('inventory', 'excel')">
                <span class="material-symbols-rounded">table_chart</span>
                Export Excel
              </button>
              <button class="export-btn" @click="exportReport('inventory', 'csv')">
                <span class="material-symbols-rounded">description</span>
                Export CSV
              </button>
            </div>
          </div>
        </div>

        
        <!-- Patient Reports Tab -->
        <div class="tab-content" :class="activeTab === 'patients' ? 'active' : ''">
          <!-- Loading State -->
          <div x-show="loading.patients" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading patient reports...</p>
          </div>
          
          <!-- Patients Content -->
          <div x-show="!loading.patients">
            <div class="table-container">
              <table class="reports-table">
                <thead>
                  <tr>
                    <th>Patient ID</th>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Total Visits</th>
                    <th>Last Visit</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="patient in patientData" :key="patient.id">
                    <tr>
                      <td x-text="patient.patientId"></td>
                      <td x-text="patient.name"></td>
                      <td x-text="patient.age"></td>
                      <td x-text="patient.gender"></td>
                      <td x-text="patient.totalVisits"></td>
                      <td x-text="formatDate(patient.lastVisit)"></td>
                      <td>
                        <span class="status-badge" :class="patient.status.toLowerCase()" x-text="patient.status"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
            
            <div class="export-options" style="margin-top: 1rem;">
              <button class="export-btn" @click="exportReport('patients', 'pdf')">
                <span class="material-symbols-rounded">picture_as_pdf</span>
                Export PDF
              </button>
              <button class="export-btn" @click="exportReport('patients', 'excel')">
                <span class="material-symbols-rounded">table_chart</span>
                Export Excel
              </button>
              <button class="export-btn" @click="exportReport('patients', 'csv')">
                <span class="material-symbols-rounded">description</span>
                Export CSV
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Alpine.js Component -->
  <script>
    function reportsSystem() {
      return {
        sidebarOpen: false,
        activeTab: localStorage.getItem('activeReportTab') || 'sales',
        userInfo: {
          name: '',
          role: 'Cashier',
          initials: ''
        },
        filters: {
          dateFrom: '',
          dateTo: '',
          reportType: 'all',
          shift: 'all'
        },
        summary: {
          totalSales: 0,
          totalTransactions: 0,
          itemsSold: 0,
          averageTransaction: 0,
          salesGrowth: 0,
          transactionsGrowth: 0,
          itemsGrowth: 0,
          averageGrowth: 0
        },
        salesData: [],
        inventoryData: [],
        patientData: [],
        
        // Loading states
        loading: {
          sales: true,
          inventory: true,
          patients: true
        },

        async init() {
          await this.loadUserInfo();
          
          // Ensure data manager is available
          if (!window.umiDataManager) {
            console.warn('Data manager not available, using fallback API calls');
            this.useDataManager = false;
          } else {
            this.useDataManager = true;
            // Subscribe to real-time data updates
            this.subscribeToDataUpdates();
          }
          
          await this.loadReportData();
          this.setDefaultDateRange();
        },

        subscribeToDataUpdates() {
          // Subscribe to sales data changes
          window.umiDataManager.subscribe('sales', (data) => {
            if (this.activeTab === 'sales') {
              this.salesData = data;
            }
            // Update summary when sales data changes
            this.loadSummaryData();
          });

          // Subscribe to inventory data changes
          window.umiDataManager.subscribe('inventory', (data) => {
            if (this.activeTab === 'inventory') {
              this.inventoryData = data;
            }
          });

          // Subscribe to patient data changes
          window.umiDataManager.subscribe('patients', (data) => {
            if (this.activeTab === 'patients') {
              this.patientData = data;
            }
          });

          // Subscribe to shift changes
          window.umiDataManager.subscribe('shift', (shift) => {
            if (shift) {
              this.currentShift = shift;
              // Reload data when shift changes
              this.loadReportData();
            }
          });
        },

        async loadUserInfo() {
          // User profile removed from header, but keep basic info for potential future use
          this.userInfo = {
            name: 'Cashier',
            role: 'Cashier',
            initials: 'C'
          };
        },

        getInitials(firstName, lastName) {
          const first = firstName ? firstName.charAt(0).toUpperCase() : '';
          const last = lastName ? lastName.charAt(0).toUpperCase() : '';
          return (first + last) || 'C';
        },

        setDefaultDateRange() {
          const today = new Date();
          const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
          
          this.filters.dateTo = today.toISOString().split('T')[0];
          this.filters.dateFrom = lastMonth.toISOString().split('T')[0];
        },

        async loadReportData() {
          try {
            // Load summary data
            await this.loadSummaryData();
            
            // Load tab-specific data based on active tab
            await this.loadTabData(this.activeTab);
            
          } catch (error) {
            console.error('Error loading report data:', error);
            window.cashierAPI.handleError(error, 'loadReportData');
          }
        },

        async loadSummaryData() {
          try {
            let summaryData;
            if (this.useDataManager && window.umiDataManager) {
              summaryData = await window.umiDataManager.getSummaryData({
                startDate: this.filters.dateFrom,
                endDate: this.filters.dateTo,
                shift: this.filters.shift
              });
            } else {
              // Fallback to direct API call
              summaryData = await window.cashierAPI.getReportSummary({
                startDate: this.filters.dateFrom,
                endDate: this.filters.dateTo,
                reportType: 'summary'
              });
              summaryData = {
                totalSales: summaryData.totalSales || 0,
                totalTransactions: summaryData.totalTransactions || 0,
                itemsSold: summaryData.itemsSold || 0,
                averageTransaction: summaryData.averageTransaction || 0,
                salesGrowth: summaryData.salesGrowth || 0,
                transactionsGrowth: summaryData.transactionsGrowth || 0,
                itemsGrowth: summaryData.itemsGrowth || 0,
                averageGrowth: summaryData.averageGrowth || 0
              };
            }
            
            this.summary = summaryData;
          } catch (error) {
            console.error('Error loading summary data:', error);
            window.cashierAPI.handleError(error, 'loadSummaryData');
            // Set empty values when API fails
            this.summary = {
              totalSales: 0,
              totalTransactions: 0,
              itemsSold: 0,
              averageTransaction: 0,
              salesGrowth: 0,
              transactionsGrowth: 0,
              itemsGrowth: 0,
              averageGrowth: 0
            };
          }
        },

        async loadTabData(tab) {
          switch (tab) {
            case 'sales':
              await this.loadSalesData();
              break;
            case 'inventory':
              await this.loadInventoryData();
              break;
            case 'patients':
              await this.loadPatientData();
              break;
          }
        },

        async loadSalesData() {
          this.loading.sales = true;
          try {
            const salesData = await window.umiDataManager.getSalesData({
              startDate: this.filters.dateFrom,
              endDate: this.filters.dateTo,
              shift: this.filters.shift === 'all' ? '' : this.filters.shift
            });
            this.salesData = salesData;
          } catch (error) {
            console.error('Error loading sales data:', error);
            window.cashierAPI.handleError(error, 'loadSalesData');
            this.salesData = [];
          } finally {
            this.loading.sales = false;
          }
        },

        async loadInventoryData() {
          this.loading.inventory = true;
          try {
            const inventoryData = await window.umiDataManager.getInventoryData({
              startDate: this.filters.dateFrom,
              endDate: this.filters.dateTo
            });
            this.inventoryData = inventoryData;
          } catch (error) {
            console.error('Error loading inventory data:', error);
            window.cashierAPI.handleError(error, 'loadInventoryData');
            this.inventoryData = [];
          } finally {
            this.loading.inventory = false;
          }
        },

        async loadPatientData() {
          this.loading.patients = true;
          try {
            const patientData = await window.umiDataManager.getPatientData({
              startDate: this.filters.dateFrom,
              endDate: this.filters.dateTo
            });
            this.patientData = patientData;
          } catch (error) {
            console.error('Error loading patient data:', error);
            window.cashierAPI.handleError(error, 'loadPatientData');
            this.patientData = [];
          } finally {
            this.loading.patients = false;
          }
        },

        setActiveTab(tab) {
          this.activeTab = tab;
          localStorage.setItem('activeReportTab', tab);
          this.loadTabData(tab);
        },

        async refreshAllData() {
          try {
            // Show loading states
            this.loading.sales = true;
            this.loading.inventory = true;
            this.loading.patients = true;
            
            // Force refresh all data through data manager or fallback
            if (this.useDataManager && window.umiDataManager) {
              await window.umiDataManager.refreshAll();
            }
            
            // Reload current tab data
            await this.loadTabData(this.activeTab);
            
            this.showNotification('All data refreshed successfully', 'success');
          } catch (error) {
            console.error('Error refreshing data:', error);
            this.showNotification('Failed to refresh data', 'error');
          }
        },

        async applyFilters() {
          await this.loadReportData();
          this.showNotification('Filters applied successfully', 'success');
        },

        resetFilters() {
          this.filters = {
            dateFrom: '',
            dateTo: '',
            reportType: 'all',
            shift: 'all'
          };
          this.setDefaultDateRange();
          this.loadReportData();
          this.showNotification('Filters reset to default', 'info');
        },

        async exportReport(reportType, format) {
          try {
            const blob = await window.cashierAPI.exportReport(reportType, format, this.filters);
            
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportType}-report-${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            this.showNotification(`Report exported as ${format.toUpperCase()} successfully`, 'success');
          } catch (error) {
            console.error('Error exporting report:', error);
            window.cashierAPI.handleError(error, 'exportReport');
            this.showNotification('Failed to export report. Please try again.', 'error');
          }
        },

        formatCurrency(amount) {
          return new Intl.NumberFormat('en-ZM', {
            style: 'currency',
            currency: 'ZMW'
          }).format(amount).replace('ZMW', 'K');
        },

        formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('en-ZM', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        },

        showNotification(message, type = 'info') {
          // Create notification element
          const notification = document.createElement('div');
          notification.className = `notification notification-${type}`;
          notification.textContent = message;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            ${type === 'success' ? 'background: #22c55e;' : ''}
            ${type === 'error' ? 'background: #ef4444;' : ''}
            ${type === 'info' ? 'background: #3b82f6;' : ''}
          `;
          
          document.body.appendChild(notification);
          
          // Slide in
          setTimeout(() => {
            notification.style.transform = 'translateX(0)';
          }, 100);
          
          // Remove after 3 seconds
          setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 3000);
        },

        logout() {
          // Clear local storage
          localStorage.removeItem('activeReportTab');
          
          // Call logout API
          window.cashierAPI.logout()
            .then(() => {
              // Redirect to login page
              window.location.href = '../public/admin-signin.html';
            })
            .catch(error => {
              console.error('Logout error:', error);
              // Still redirect even if API call fails
              window.location.href = '../public/admin-signin.html';
            });
        }
      }
    }
  </script>

  <!-- Include API Services -->
  <script src="js/cashier-api.js"></script>
  <script src="js/data-manager.js"></script>

  <script>
  // Initialize reports system when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Alpine.js with the reports system
    Alpine.data('reportsSystem', reportsSystem);
  });
  
  // Save active tab before page unload
  window.addEventListener('beforeunload', () => {
    const activeTab = localStorage.getItem('activeReportTab') || 'sales';
    localStorage.setItem('activeReportTab', activeTab);
  });
</script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
