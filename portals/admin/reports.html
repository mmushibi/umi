<!DOCTYPE html>
<html lang="en" x-data="reportsSystem()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reports - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../shared/css/shared-styles.css">
  <script src="../shared/js/data-sync.js"></script>
  <script src="../shared/js/role-based-access.js"></script>
  <script src="../shared/js/feature-protection.js"></script>
  <script src="../admin/js/admin-api.js"></script>
  <style>
    :root {
      --color-primary: #000000;
      --color-accent: #14B8A6;
      --color-success: #22c55e;
      --color-warning: #ef4444;
      --color-text-primary: #000000;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      --color-background: #ffffff;
      --color-surface: #f9fafb;
      --color-border: #e5e7eb;
      --font-primary: 'Inter', sans-serif;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      font-family: 'Nunito', 'Varela Round', sans-serif;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--color-text-primary);
      color: var(--color-accent);
      z-index: 1000;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }

    .tenant-info {
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      margin: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 0.85rem;
    }

    .tenant-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .tenant-location {
      opacity: 0.8;
      font-size: 0.75rem;
    }

    .nav-menu {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-accent);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-accent);
      border-left: 3px solid var(--color-accent);
    }

    .nav-icon {
      font-size: 1.25rem;
    }

    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    /* Header Styles */
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-title-section {
      margin-right: 2rem;
    }

    .page-title-section .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0;
      font-family: 'Inter', sans-serif;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .export-button {
      background: var(--color-primary);
      color: var(--color-accent);
      border: none;
      padding: 0.625rem 1.25rem;
      border-radius: 16px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .export-button:hover {
      background: var(--color-text-secondary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-profile:hover {
      background: var(--color-surface);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--color-text-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.875rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    /* Reports Content */
    .reports-content {
      padding: 2rem;
    }

    /* Date Range Selector */
    .date-range-selector {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .date-range-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .date-range-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .date-range-options {
      display: flex;
      gap: 0.5rem;
    }

    .date-range-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      background: var(--color-background);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .date-range-btn:hover {
      background: var(--color-surface);
    }

    .date-range-btn.active {
      background: var(--color-primary);
      color: var(--color-accent);
      border-color: var(--color-primary);
    }

    .custom-date-range {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .date-input {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.875rem;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .summary-card {
      background: var(--color-background);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .summary-icon.primary {
      background: rgba(0, 0, 0, 0.1);
      color: var(--color-primary);
    }

    .summary-icon.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .summary-icon.warning {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
    }

    .summary-label {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .summary-change {
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .summary-change.positive {
      color: var(--color-success);
    }

    .summary-change.negative {
      color: var(--color-warning);
    }

    /* Report Tables */
    .report-section {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      margin-bottom: 2rem;
    }

    .section-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .table-container {
      overflow-x: auto;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
    }

    .report-table th {
      background: var(--color-surface);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
    }

    .report-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.875rem;
    }

    .report-table tr:hover {
      background: var(--color-surface);
    }

    .product-name {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .amount {
      font-weight: 700;
      color: var(--color-success);
    }

    .percentage {
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .percentage.positive {
      color: var(--color-success);
    }

    .percentage.negative {
      color: var(--color-warning);
    }

    .logout-section {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }

    .logout-button {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
    }

    .logout-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .logout-icon {
      font-size: 1.25rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .page-title-section {
        display: block;
        flex: 1;
        margin-right: 0;
      }

      .page-title-section .page-title {
        font-size: 1.125rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .header-left {
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
      }

      .search-bar {
        flex: 0 0 auto;
        width: auto;
        min-width: 150px;
      }

      .reports-content {
        padding: 1rem;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      .date-range-options {
        flex-wrap: wrap;
      }

      .custom-date-range {
        flex-direction: column;
        align-items: stretch;
      }

      .table-container {
        font-size: 0.75rem;
      }

      .report-table th,
      .report-table td {
        padding: 0.5rem;
      }
    }

    /* Reports Content Styles */
    .content-area {
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .content-header > div:first-child span {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .quick-stats {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .stat-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .stat-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-button .material-symbols-rounded {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--color-primary);
    }

    .stat-button span {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.25rem;
    }

    .stat-button strong {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text-primary);
    }

    .add-product-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--color-primary);
      color: var(--color-accent);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-product-btn:hover {
      background: #333;
      transform: translateY(-1px);
    }

    /* Report Filters */
    .report-filters {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .filter-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-group label {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 200px;
    }

    .filter-group label span {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .filter-group select {
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-background);
      color: var(--color-text-primary);
      font-size: 0.875rem;
    }

    /* Widgets */
    .widgets-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .widget {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .widget-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .widget-subtitle {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .icon-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .icon-button:hover {
      background: var(--color-surface);
    }

    .widget-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 150px;
    }

    .widget-menu button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--color-text-primary);
    }

    .widget-menu button:hover {
      background: var(--color-surface);
    }

    .chart-container {
      padding: 1.5rem;
      height: 300px;
      position: relative;
    }

    /* Top Products List */
    .top-products-list {
      padding: 1.5rem;
    }

    .product-performance-item {
      display: grid;
      grid-template-columns: 40px 1fr auto auto;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--color-border);
    }

    .product-performance-item:last-child {
      border-bottom: none;
    }

    .product-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--color-primary);
      color: var(--color-accent);
      border-radius: 50%;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .product-name {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .product-sales {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .product-revenue {
      font-weight: 700;
      color: var(--color-success);
    }

    /* Inventory Metrics */
    .inventory-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
    }

    .metric-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 8px;
    }

    .metric-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--color-primary);
      color: var(--color-accent);
      border-radius: 8px;
    }

    .metric-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .metric-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    .metric-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    /* Customer Insights */
    .customer-insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
    }

    .insight-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 8px;
    }

    .insight-label {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .insight-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text-primary);
    }

    /* Report List Container */
    .report-list-container {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .report-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .report-list-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .report-list-header span {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .table-controls {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .control-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .table-search {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      flex: 1;
      max-width: 400px;
    }

    .table-search input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      font-size: 0.875rem;
      color: var(--color-text-primary);
    }

    .table-search input::placeholder {
      color: var(--color-text-muted);
    }

    .table-scroll {
      overflow-x: auto;
    }

    .product-table {
      width: 100%;
      border-collapse: collapse;
    }

    .product-table th {
      background: var(--color-surface);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
    }

    .product-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.875rem;
    }

    .product-table tr:hover {
      background: var(--color-surface);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.in-stock {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .actions {
      display: flex;
      gap: 0.5rem;
    }

    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-button:hover {
      background: var(--color-surface);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--color-background);
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .modal-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .modal-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .modal-close:hover {
      background: var(--color-surface);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .form-grid label {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-grid label span {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .form-grid input,
    .form-grid select {
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-background);
      color: var(--color-text-primary);
      font-size: 0.875rem;
    }

    .form-textarea {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-textarea span {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .form-textarea textarea {
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-background);
      color: var(--color-text-primary);
      font-size: 0.875rem;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      padding: 1.5rem;
      border-top: 1px solid var(--color-border);
    }

    .modal-footer button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-footer button.secondary {
      background: var(--color-surface);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
    }

    .modal-footer button.primary {
      background: var(--color-primary);
      color: var(--color-accent);
    }

    .modal-footer button:hover {
      transform: translateY(-1px);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-area {
        padding: 1rem;
      }

      .content-header {
        flex-direction: column;
        align-items: stretch;
      }

      .quick-stats {
        justify-content: center;
      }

      .widgets-row {
        grid-template-columns: 1fr;
      }

      .inventory-metrics,
      .customer-insights {
        grid-template-columns: repeat(2, 1fr);
      }

      .product-performance-item {
        grid-template-columns: 30px 1fr;
        gap: 0.5rem;
      }

      .product-sales,
      .product-revenue {
        display: none;
      }

      .report-list-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .control-group {
        flex-direction: column;
      }

      .table-search {
        max-width: none;
      }

      .modal-content {
        width: 95%;
        margin: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>

    <div class="pharmacy-info">
      <div class="pharmacy-name" x-text="pharmacyInfo.name"></div>
      <div class="pharmacy-location" x-text="pharmacyInfo.location"></div>
    </div>

    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="point-of-sale.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">point_of_sale</span>
        <span>Point of Sale</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory_2</span>
        <span>Inventory</span>
      </a>
      <a href="prescriptions.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">prescriptions</span>
        <span>Prescriptions</span>
      </a>
      <a href="patients.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="sales.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">receipt_long</span>
        <span>Sales</span>
      </a>
      <a href="payments.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">payments</span>
        <span>Payments</span>
      </a>
      <a href="reports.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">analytics</span>
        <span>Reports</span>
      </a>
      <a href="user-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">admin_panel_settings</span>
        <span>User Management</span>
      </a>
      <!-- Branch navigation - always show for admin users -->
      <a href="branches.html" class="nav-item" x-show="true" data-feature="multiple_branches">
        <span class="material-symbols-rounded nav-icon">business</span>
        <span>Branches</span>
      </a>
      <a href="account.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">settings</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        
        <div class="page-title-section">
          <h1 class="page-title">Reports & Analytics</h1>
        </div>
        
        <div class="search-bar" x-data="{ searchOpen: false, query: '' }">
          <span class="material-symbols-rounded search-icon">search</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search reports by type, date, or keyword..."
            x-model="query"
            @focus="searchOpen = true"
            @input="searchOpen = true"
            @blur="setTimeout(() => searchOpen = false, 200)"
          >
          
          <div class="search-suggestions" :class="searchOpen && query.length > 0 ? 'show' : ''">
            <template x-for="suggestion in filteredSuggestions" :key="suggestion.id">
              <div class="suggestion-item" @click="selectSuggestion(suggestion)">
                <div class="suggestion-icon">
                  <span class="material-symbols-rounded" x-text="suggestion.icon"></span>
                </div>
                <div class="suggestion-content">
                  <div class="suggestion-title" x-text="suggestion.title"></div>
                  <div class="suggestion-description" x-text="suggestion.description"></div>
                </div>
                <div class="suggestion-type" x-text="suggestion.type"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div class="header-right">
        <!-- Header elements removed per request -->
      </div>
    </header>

    <!-- Reports Content -->
    <section class="content-area">
      <div class="content-header">
        <div>
          <span>Transform data into actionable business insights</span>
        </div>
        <div class="quick-stats">
          <button class="stat-button" data-stat="total-revenue">
            <span class="material-symbols-rounded">payments</span>
            <span>Total Revenue</span>
            <strong id="totalRevenueCount" x-text="formatCurrency(totalRevenue)"></strong>
          </button>
          <button class="stat-button" data-stat="total-transactions">
            <span class="material-symbols-rounded">receipt_long</span>
            <span>Transactions</span>
            <strong id="totalTransactionsCount" x-text="totalTransactions"></strong>
          </button>
          <button class="stat-button" data-stat="growth-rate">
            <span class="material-symbols-rounded">trending_up</span>
            <span>Growth Rate</span>
            <strong id="growthRateCount" x-text="growthRate"></strong>
          </button>
          <button class="stat-button" data-stat="top-products">
            <span class="material-symbols-rounded">star</span>
            <span>Top Products</span>
            <strong id="topProductsCount" x-text="topProducts.length"></strong>
          </button>
        </div>
        <button class="add-product-btn" id="generateReportButton" type="button" data-permission="generate_reports" @click="openGenerateReportModal()">
          <span class="material-symbols-rounded">download</span>
          Generate Report
        </button>
      </div>

      <div class="report-filters">
        <div class="filter-group">
          <label>
            <span>Report Period</span>
            <select id="reportPeriod" x-model="reportPeriod">
              <option value="today">Today</option>
              <option value="week" selected>This Week</option>
              <option value="month">This Month</option>
              <option value="quarter">This Quarter</option>
              <option value="year">This Year</option>
              <option value="custom">Custom Range</option>
            </select>
          </label>
          <label>
            <span>Report Type</span>
            <select id="reportType" x-model="reportType">
              <option value="all" selected>All Reports</option>
              <option value="sales">Sales Reports</option>
              <option value="inventory">Inventory Reports</option>
              <option value="financial">Financial Reports</option>
              <option value="patient">Patient Reports</option>
            </select>
          </label>
          <label>
            <span>Branch</span>
            <select id="reportBranch" x-model="reportBranch">
              <option value="all" selected>All Branches</option>
              <template x-for="branch in availableBranches" :key="branch.id">
                <option :value="branch.id" x-text="branch.name"></option>
              </template>
            </select>
          </label>
        </div>
      </div>

      <div class="widgets-row">
        <article class="widget">
          <header class="widget-header">
            <div>
              <h3 class="widget-title">Revenue Overview</h3>
              <p class="widget-subtitle">Income trends for the selected period</p>
            </div>
            <button class="icon-button" type="button" data-menu="revenue" aria-haspopup="true"
              aria-expanded="false" aria-controls="revenueMenu" aria-label="Revenue menu">
              <span class="material-symbols-rounded" aria-hidden="true">more_horiz</span>
            </button>
            <div class="widget-menu" id="revenueMenu" hidden>
              <button type="button" data-action="refresh-revenue"><span class="material-symbols-rounded"
                  aria-hidden="true">refresh</span>Refresh data</button>
              <button type="button" data-action="export-revenue"><span class="material-symbols-rounded"
                  aria-hidden="true">download</span>Export chart</button>
            </div>
          </header>
          <div class="chart-container">
            <canvas id="revenueChart" aria-label="Revenue trends over time"></canvas>
          </div>
        </article>

        <article class="widget">
          <header class="widget-header">
            <div>
              <h3 class="widget-title">Sales by Category</h3>
              <p class="widget-subtitle">Product category performance breakdown</p>
            </div>
            <button class="icon-button" type="button" data-menu="category" aria-haspopup="true"
              aria-expanded="false" aria-controls="categoryMenu" aria-label="Category menu">
              <span class="material-symbols-rounded" aria-hidden="true">more_horiz</span>
            </button>
            <div class="widget-menu" id="categoryMenu" hidden>
              <button type="button" data-action="refresh-category"><span class="material-symbols-rounded"
                  aria-hidden="true">refresh</span>Refresh chart</button>
              <button type="button" data-action="export-category"><span class="material-symbols-rounded"
                  aria-hidden="true">download</span>Export data</button>
            </div>
          </header>
          <div class="chart-container">
            <canvas id="categoryChart" aria-label="Sales by product category"></canvas>
          </div>
        </article>

        <article class="widget">
          <header class="widget-header">
            <div>
              <h3 class="widget-title">Top Performing Products</h3>
              <p class="widget-subtitle">Best-selling products by revenue</p>
            </div>
            <button class="icon-button" type="button" data-menu="top-products" aria-haspopup="true"
              aria-expanded="false" aria-controls="topProductsMenu" aria-label="Top products menu">
              <span class="material-symbols-rounded" aria-hidden="true">more_horiz</span>
            </button>
            <div class="widget-menu" id="topProductsMenu" hidden>
              <button type="button" data-action="refresh-top-products"><span class="material-symbols-rounded"
                  aria-hidden="true">refresh</span>Refresh list</button>
              <button type="button" data-action="view-all-products"><span class="material-symbols-rounded"
                  aria-hidden="true">list</span>View all products</button>
            </div>
          </header>
          <div class="top-products-list" id="topProductsList">
            <template x-for="(product, index) in topProducts" :key="index">
              <div class="product-performance-item">
                <span class="product-rank" x-text="index + 1"></span>
                <span class="product-name" x-text="product.name"></span>
                <span class="product-sales" x-text="product.sales + ' units'"></span>
                <span class="product-revenue" x-text="formatCurrency(product.revenue)"></span>
              </div>
            </template>
          </div>
        </article>
      </div>

      <div class="widgets-row">
        <article class="widget">
          <header class="widget-header">
            <div>
              <h3 class="widget-title">Inventory Performance</h3>
              <p class="widget-subtitle">Stock levels and movement analysis</p>
            </div>
            <button class="icon-button" type="button" data-menu="inventory" aria-haspopup="true"
              aria-expanded="false" aria-controls="inventoryMenu" aria-label="Inventory menu">
              <span class="material-symbols-rounded" aria-hidden="true">more_horiz</span>
            </button>
            <div class="widget-menu" id="inventoryMenu" hidden>
              <button type="button" data-action="refresh-inventory"><span class="material-symbols-rounded"
                  aria-hidden="true">refresh</span>Refresh data</button>
              <button type="button" data-action="export-inventory"><span class="material-symbols-rounded"
                  aria-hidden="true">download</span>Export report</button>
            </div>
          </header>
          <div class="inventory-metrics">
            <div class="metric-card">
              <span class="metric-icon material-symbols-rounded">inventory</span>
              <div class="metric-info">
                <span class="metric-label">Total Stock Value</span>
                <span class="metric-value" x-text="formatCurrency(totalStockValue)"></span>
              </div>
            </div>
            <div class="metric-card">
              <span class="metric-icon material-symbols-rounded">trending_down</span>
              <div class="metric-info">
                <span class="metric-label">Low Stock Items</span>
                <span class="metric-value" x-text="lowStockItems"></span>
              </div>
            </div>
            <div class="metric-card">
              <span class="metric-icon material-symbols-rounded">warning</span>
              <div class="metric-info">
                <span class="metric-label">Expiring Soon</span>
                <span class="metric-value" x-text="expiringItems"></span>
              </div>
            </div>
            <div class="metric-card">
              <span class="metric-icon material-symbols-rounded">speed</span>
              <div class="metric-info">
                <span class="metric-label">Turnover Rate</span>
                <span class="metric-value" x-text="turnoverRate"></span>
              </div>
            </div>
          </div>
        </article>

        <article class="widget">
          <header class="widget-header">
            <div>
              <h3 class="widget-title">Patient Analytics</h3>
              <p class="widget-subtitle">Patient behavior and demographics</p>
            </div>
            <button class="icon-button" type="button" data-menu="patient" aria-haspopup="true"
              aria-expanded="false" aria-controls="customerMenu" aria-label="Patient menu">
              <span class="material-symbols-rounded" aria-hidden="true">more_horiz</span>
            </button>
            <div class="widget-menu" id="customerMenu" hidden>
              <button type="button" data-action="refresh-customer"><span class="material-symbols-rounded"
                  aria-hidden="true">refresh</span>Refresh data</button>
              <button type="button" data-action="export-customer"><span class="material-symbols-rounded"
                  aria-hidden="true">download</span>Export insights</button>
            </div>
          </header>
          <div class="customer-insights">
            <div class="insight-item">
              <span class="insight-label">Total Patients</span>
              <span class="insight-value" x-text="totalPatients.toLocaleString()"></span>
            </div>
            <div class="insight-item">
              <span class="insight-label">New This Month</span>
              <span class="insight-value" x-text="newPatients"></span>
            </div>
            <div class="insight-item">
              <span class="insight-label">Repeat Patients</span>
              <span class="insight-value" x-text="repeatRate"></span>
            </div>
            <div class="insight-item">
              <span class="insight-label">Avg. Purchase Value</span>
              <span class="insight-value" x-text="formatCurrency(avgPurchaseValue)"></span>
            </div>
          </div>
        </article>
      </div>

      <article class="report-list-container">
        <header class="report-list-header">
          <div>
            <h2>Generated Reports</h2>
            <span>Access and download your previously generated reports</span>
          </div>
          <button class="add-product-btn" id="scheduleReportButton" type="button" @click="openScheduleReportModal()">
            <span class="material-symbols-rounded">schedule</span>
            Schedule Report
          </button>
        </header>

        <div class="table-controls">
          <div class="control-group">
            <label class="table-search">
              <span class="material-symbols-rounded" aria-hidden="true">search</span>
              <input id="reportSearchInput" type="search" placeholder="Search reports by name or type"
                autocomplete="off" x-model="searchQuery">
            </label>
            <button class="icon-button" id="reportFilterToggle" type="button" aria-haspopup="true" aria-expanded="false"
              aria-controls="reportFilterPanel" title="Filters">
              <span class="material-symbols-rounded" aria-hidden="true">filter_list</span>
            </button>
          </div>
        </div>

        <div class="table-scroll">
          <table class="product-table" id="reportTable" aria-live="polite">
            <thead>
              <tr>
                <th scope="col" data-column="date">Date Generated</th>
                <th scope="col" data-column="name">Report Name</th>
                <th scope="col" data-column="type">Type</th>
                <th scope="col" data-column="period">Period</th>
                <th scope="col" data-column="status">Status</th>
                <th scope="col" data-column="actions">Actions</th>
              </tr>
            </thead>
            <tbody id="reportTableBody">
              <template x-for="report in filteredReports" :key="report.id">
                <tr>
                  <td data-column="date" x-text="report.date"></td>
                  <td data-column="name" x-text="report.name"></td>
                  <td data-column="type" x-text="report.type"></td>
                  <td data-column="period" x-text="report.period"></td>
                  <td data-column="status">
                    <span class="status-badge in-stock" x-text="report.status"></span>
                  </td>
                  <td data-column="actions">
                    <div class="actions">
                      <button type="button" class="action-button" data-action="view" title="View report">
                        <span class="material-symbols-rounded" aria-hidden="true">visibility</span>
                      </button>
                      <button type="button" class="action-button" data-action="download" title="Download">
                        <span class="material-symbols-rounded" aria-hidden="true">download</span>
                      </button>
                      <button type="button" class="action-button" data-action="share" title="Share">
                        <span class="material-symbols-rounded" aria-hidden="true">share</span>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </article>
    </section>
  </main>

  <div class="overlay" id="modalOverlay" hidden></div>

  <section class="modal" id="generateReportModal" role="dialog" aria-modal="true" aria-labelledby="generateReportModalTitle"
    :class="showGenerateReportModal ? '' : 'hidden'">
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="generateReportModalTitle">Generate New Report</h2>
        <button type="button" class="modal-close" @click="showGenerateReportModal = false" aria-label="Close generate report form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="generateReportForm" class="modal-body" @submit.prevent="submitGenerateReport">
        <div class="form-grid">
          <label>
            <span>Report Name</span>
            <input 
              type="text" 
              id="formReportName" 
              name="reportName" 
              placeholder="Enter report name or leave blank to auto-generate" 
              x-model="newReport.name"
              @input="showReportNameSuggestions"
              @blur="hideReportNameSuggestions"
              list="report-name-suggestions"
            >
            <datalist id="report-name-suggestions">
              <template x-for="suggestion in reportNameSuggestions" :key="suggestion">
                <option :value="suggestion" x-text="suggestion"></option>
              </template>
            </datalist>
          </label>
          <label>
            <span>Report Type</span>
            <select id="formReportType" name="reportType" required x-model="newReport.type">
              <option value="">Select report type</option>
              <option value="sales">Sales Report</option>
              <option value="inventory">Inventory Report</option>
              <option value="financial">Financial Report</option>
              <option value="customer">Customer Report</option>
            </select>
          </label>
          <label>
            <span>Start Date</span>
            <input type="date" id="formStartDate" name="startDate" required x-model="newReport.startDate">
          </label>
          <label>
            <span>End Date</span>
            <input type="date" id="formEndDate" name="endDate" required x-model="newReport.endDate">
          </label>
          <label>
            <span>Format</span>
            <select id="formFormat" name="format" required x-model="newReport.format">
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
              <option value="csv">CSV</option>
            </select>
          </label>
          <label>
            <span>Email Report</span>
            <select id="formEmail" name="email" x-model="newReport.email">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </label>
        </div>
        <label class="form-textarea">
          <span>Description</span>
          <textarea id="formDescription" name="description" rows="3"
            placeholder="Add optional notes about this report" x-model="newReport.description"></textarea>
        </label>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary" @click="showGenerateReportModal = false">Cancel</button>
        <button type="submit" form="generateReportForm" class="primary">Generate Report</button>
      </footer>
    </div>
  </section>

  <!-- Schedule Report Modal -->
  <section class="modal" id="scheduleReportModal" role="dialog" aria-modal="true" aria-labelledby="scheduleReportModalTitle"
    :class="showScheduleReportModal ? '' : 'hidden'">
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="scheduleReportModalTitle">Schedule Report</h2>
        <button type="button" class="modal-close" @click="showScheduleReportModal = false" aria-label="Close schedule report form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="scheduleReportForm" class="modal-body" @submit.prevent="submitScheduleReport">
        <div class="form-grid">
          <label>
            <span>Report Name</span>
            <input 
              type="text" 
              id="scheduleReportName" 
              name="reportName" 
              placeholder="Enter report name or leave blank to auto-generate" 
              x-model="scheduledReport.name"
              @input="showReportNameSuggestions"
              @blur="hideReportNameSuggestions"
              list="report-name-suggestions"
            >
          </label>
          <label>
            <span>Report Type</span>
            <select id="scheduleReportType" name="reportType" required x-model="scheduledReport.type">
              <option value="">Select report type</option>
              <option value="sales">Sales Report</option>
              <option value="inventory">Inventory Report</option>
              <option value="financial">Financial Report</option>
              <option value="customer">Customer Report</option>
              <option value="patient">Patient Report</option>
            </select>
          </label>
          <label>
            <span>Schedule Frequency</span>
            <select id="scheduleFrequency" name="frequency" required x-model="scheduledReport.frequency">
              <option value="">Select frequency</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="yearly">Yearly</option>
            </select>
          </label>
          <label>
            <span>Start Date</span>
            <input type="date" id="scheduleStartDate" name="startDate" required x-model="scheduledReport.startDate">
          </label>
          <label>
            <span>End Date</span>
            <input type="date" id="scheduleEndDate" name="endDate" x-model="scheduledReport.endDate">
          </label>
          <label>
            <span>Format</span>
            <select id="scheduleFormat" name="format" required x-model="scheduledReport.format">
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
              <option value="csv">CSV</option>
            </select>
          </label>
          <label>
            <span>Email Recipients</span>
            <input type="text" id="scheduleEmailRecipients" name="emailRecipients" placeholder="Enter email addresses separated by commas" x-model="scheduledReport.emailRecipients">
          </label>
        </div>
        <label class="form-textarea">
          <span>Description</span>
          <textarea id="scheduleDescription" name="description" rows="3"
            placeholder="Add optional notes about this scheduled report" x-model="scheduledReport.description"></textarea>
        </label>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary" @click="showScheduleReportModal = false">Cancel</button>
        <button type="submit" form="scheduleReportForm" class="primary">Schedule Report</button>
      </footer>
    </div>
  </section>

  <!-- Alpine.js Component -->
  <script>
    function reportsSystem() {
      return {
        sidebarOpen: false,
        searchQuery: '',
        reportPeriod: 'week',
        reportType: 'all',
        reportBranch: 'all',
        showGenerateReportModal: false,
        showScheduleReportModal: false,
        
        // Report name suggestions
        reportNameSuggestions: [
          'Monthly Sales Report',
          'Weekly Inventory Summary',
          'Financial Performance Report',
          'Customer Analytics Report',
          'Patient Health Statistics',
          'Daily Sales Summary',
          'Quarterly Financial Report',
          'Annual Business Review',
          'Product Performance Analysis',
          'Branch Comparison Report',
          'Prescription Trends Report',
          'Payment Processing Report',
          'Staff Performance Metrics',
          'Operational Efficiency Report',
          'Compliance and Audit Report'
        ],
        
        // User and pharmacy info
        pharmacyInfo: {
          name: 'Umi Health',
          location: 'Lusaka, Zambia'
        },
        userInfo: {
          name: 'Umi Health',
          role: 'Admin',
          initials: 'UH'
        },
        
        topProducts: [],
        reports: [],
        scheduledReports: [],
        
        // Report objects
        newReport: {
          name: '',
          type: '',
          startDate: '',
          endDate: '',
          format: 'pdf',
          email: 'no',
          description: ''
        },
        scheduledReport: {
          name: '',
          type: '',
          frequency: '',
          startDate: '',
          endDate: '',
          format: 'pdf',
          emailRecipients: '',
          description: ''
        },
        
        // Dashboard metrics
        totalRevenue: 0,
        totalTransactions: 0,
        totalPatients: 0,
        totalPrescriptions: 0,
        
        // Real-time inventory metrics
        totalStockValue: 0,
        lowStockItems: 0,
        expiringItems: 0,
        turnoverRate: '0x',
        
        // Real-time patient metrics
        newPatients: 0,
        repeatRate: '0%',
        avgPurchaseValue: 0,
        
        // Growth rate and branch data
        growthRate: '0%',
        availableBranches: [],
        
        // Data sync and API integration
        loading: false,
        
        init() {
          this.loadPharmacyInfo();
          this.loadReportsFromAPI();
          this.loadScheduledReportsFromAPI();
          this.setupEventListeners();
          this.setupRealtimeSync();
          this.loadRealtimeMetrics();
        },

        loadRealtimeMetrics() {
          // Load real-time metrics from data sync
          if (window.dataSync) {
            const inventory = window.dataSync.get('inventory') || [];
            const patients = window.dataSync.get('patients') || [];
            const sales = window.dataSync.get('sales') || [];
            const branches = window.dataSync.get('branches') || [];
            
            this.updateInventoryMetrics(inventory);
            this.updateCustomerMetrics(patients);
            this.updateDashboardMetrics();
            this.updateGrowthRate(sales);
            this.updateBranchData(branches);
          }
          
          // Load branches from API if available
          this.loadBranches();
          
          // Load current branch info for sidebar
          this.loadCurrentBranchInfo();
        },

        loadCurrentBranchInfo() {
          // Load current branch information and update pharmacy info display
          const currentBranch = localStorage.getItem('umi_current_branch');
          if (currentBranch) {
            try {
              const branch = JSON.parse(currentBranch);
              // Update pharmacy info with branch-specific data
              this.pharmacyInfo = {
                name: branch.name || this.pharmacyInfo.name,
                location: `${branch.address || branch.city || 'Lusaka'}, ${branch.province || branch.country || 'Zambia'}`
              };
            } catch (error) {
              console.error('Error loading current branch info:', error);
            }
          }
          
          // Also check if we have branch data from data sync
          if (window.dataSync && this.availableBranches.length > 0) {
            const currentBranchId = localStorage.getItem('umi_current_branch_id');
            if (currentBranchId) {
              const branch = this.availableBranches.find(b => b.id === currentBranchId);
              if (branch) {
                this.pharmacyInfo = {
                  name: branch.name || this.pharmacyInfo.name,
                  location: `${branch.address || branch.city || 'Lusaka'}, ${branch.province || branch.country || 'Zambia'}`
                };
              }
            }
          }
        },

        loadBranches() {
          // Load branches from API or data sync
          if (window.adminAPI) {
            window.adminAPI.getBranches()
              .then(branches => {
                this.availableBranches = branches;
              })
              .catch(error => {
                console.error('Error loading branches:', error);
                // Fallback to data sync
                if (window.dataSync) {
                  this.availableBranches = window.dataSync.get('branches') || [];
                }
              });
          } else if (window.dataSync) {
            this.availableBranches = window.dataSync.get('branches') || [];
          }
        },

        updateGrowthRate(sales) {
          // Calculate growth rate based on sales data
          if (sales && sales.length > 0) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const currentMonthSales = sales.filter(sale => {
              const saleDate = new Date(sale.date);
              return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            const lastMonth = new Date(currentYear, currentMonth - 1, 1);
            const lastMonthSales = sales.filter(sale => {
              const saleDate = new Date(sale.date);
              return saleDate.getMonth() === lastMonth.getMonth() && saleDate.getFullYear() === lastMonth.getFullYear();
            });
            
            const currentRevenue = currentMonthSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
            const lastRevenue = lastMonthSales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
            
            if (lastRevenue > 0) {
              const growth = ((currentRevenue - lastRevenue) / lastRevenue) * 100;
              this.growthRate = `${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`;
            } else {
              this.growthRate = currentRevenue > 0 ? '+100%' : '0%';
            }
          } else {
            this.growthRate = '0%';
          }
        },

        // Report name suggestions and auto-generation
        showReportNameSuggestions() {
          // Filter suggestions based on input
          const input = this.newReport.name || this.scheduledReport.name || '';
          if (input.length > 0) {
            this.reportNameSuggestions = this.reportNameSuggestions.filter(suggestion =>
              suggestion.toLowerCase().includes(input.toLowerCase())
            );
          }
        },

        hideReportNameSuggestions() {
          // Auto-generate report name if field is left blank
          setTimeout(() => {
            if (!this.newReport.name && this.newReport.type) {
              this.newReport.name = this.generateReportName(this.newReport.type);
            }
            if (!this.scheduledReport.name && this.scheduledReport.type) {
              this.scheduledReport.name = this.generateReportName(this.scheduledReport.type);
            }
          }, 200);
        },

        generateReportName(reportType) {
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-ZM', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          });
          
          const typeNames = {
            'sales': 'Sales Report',
            'inventory': 'Inventory Report',
            'financial': 'Financial Report',
            'customer': 'Customer Report',
            'patient': 'Patient Report'
          };
          
          return `${typeNames[reportType] || 'Report'} - ${dateStr}`;
        },

        // Schedule report functionality
        openScheduleReportModal() {
          this.showScheduleReportModal = true;
          this.resetScheduledReport();
        },

        resetScheduledReport() {
          this.scheduledReport = {
            name: '',
            type: '',
            frequency: '',
            startDate: '',
            endDate: '',
            format: 'pdf',
            emailRecipients: '',
            description: ''
          };
        },

        submitScheduleReport() {
          if (!this.scheduledReport.type || !this.scheduledReport.frequency || !this.scheduledReport.startDate) {
            this.showError('Please fill in all required fields');
            return;
          }

          // Auto-generate name if not provided
          if (!this.scheduledReport.name) {
            this.scheduledReport.name = this.generateReportName(this.scheduledReport.type);
          }

          // Use adminAPI for backend integration
          if (window.adminAPI) {
            const scheduleData = {
              name: this.scheduledReport.name,
              type: this.scheduledReport.type,
              frequency: this.scheduledReport.frequency,
              startDate: this.scheduledReport.startDate,
              endDate: this.scheduledReport.endDate,
              format: this.scheduledReport.format,
              emailRecipients: this.scheduledReport.emailRecipients,
              description: this.scheduledReport.description
            };

            window.adminAPI.scheduleReport(scheduleData)
              .then(response => {
                const scheduledReport = {
                  id: response.id || Date.now(),
                  name: this.scheduledReport.name,
                  type: this.scheduledReport.type,
                  frequency: this.scheduledReport.frequency,
                  startDate: this.scheduledReport.startDate,
                  endDate: this.scheduledReport.endDate,
                  format: this.scheduledReport.format,
                  emailRecipients: this.scheduledReport.emailRecipients,
                  description: this.scheduledReport.description,
                  status: 'Scheduled',
                  createdAt: new Date().toISOString()
                };

                this.scheduledReports.unshift(scheduledReport);
                this.showScheduleReportModal = false;
                this.resetScheduledReport();
                this.showSuccess('Report scheduled successfully!');
                this.saveScheduledReports();
              })
              .catch(error => {
                console.error('Error scheduling report:', error);
                this.showError('Failed to schedule report. Please try again.');
              });
          } else {
            // Fallback to local storage
            const scheduledReport = {
              id: Date.now(),
              name: this.scheduledReport.name,
              type: this.scheduledReport.type,
              frequency: this.scheduledReport.frequency,
              startDate: this.scheduledReport.startDate,
              endDate: this.scheduledReport.endDate,
              format: this.scheduledReport.format,
              emailRecipients: this.scheduledReport.emailRecipients,
              description: this.scheduledReport.description,
              status: 'Scheduled',
              createdAt: new Date().toISOString()
            };

            this.scheduledReports.unshift(scheduledReport);
            this.showScheduleReportModal = false;
            this.resetScheduledReport();
            this.showSuccess('Report scheduled successfully!');
            this.saveScheduledReports();
          }
        },

        loadScheduledReportsFromAPI() {
          // Load scheduled reports from API or localStorage
          if (window.adminAPI) {
            window.adminAPI.getScheduledReports()
              .then(reports => {
                this.scheduledReports = reports;
              })
              .catch(error => {
                console.error('Error loading scheduled reports:', error);
                this.loadSampleScheduledReports();
              });
          } else {
            this.loadSampleScheduledReports();
          }
        },

        loadSampleScheduledReports() {
          // Initialize empty scheduled reports array - real data will be loaded from API
          this.scheduledReports = [];
        },

        saveScheduledReports() {
          // Save scheduled reports to localStorage for persistence
          localStorage.setItem('umi_scheduled_reports', JSON.stringify(this.scheduledReports));
          
          // Trigger data sync
          if (window.dataSync) {
            window.dataSync.set('scheduledReports', this.scheduledReports);
          }
        },

        // Load pharmacy info from localStorage
        loadPharmacyInfo() {
          try {
            // Load from current tenant data
            const currentTenant = localStorage.getItem('umi_current_tenant');
            if (currentTenant) {
              const tenant = JSON.parse(currentTenant);
              this.pharmacyInfo = {
                name: tenant.name || 'Umi Health',
                location: `${tenant.address || tenant.city || 'Lusaka'}, ${tenant.province || tenant.country || 'Zambia'}`
              };
            } else {
              // Fallback to pharmacy settings
              const pharmacySettings = localStorage.getItem('pharmacySettings');
              if (pharmacySettings) {
                const settings = JSON.parse(pharmacySettings);
                this.pharmacyInfo = {
                  name: settings.name || 'Umi Health',
                  location: `${settings.address || settings.city || 'Lusaka'}, ${settings.province || settings.country || 'Zambia'}`
                };
              } else {
                // Try to load from current branch
                const currentBranch = localStorage.getItem('umi_current_branch');
                if (currentBranch) {
                  const branch = JSON.parse(currentBranch);
                  this.pharmacyInfo = {
                    name: branch.name || 'Umi Health',
                    location: `${branch.address || branch.city || 'Lusaka'}, ${branch.province || branch.country || 'Zambia'}`
                  };
                } else {
                  // Default fallback
                  this.pharmacyInfo = {
                    name: 'Umi Health',
                    location: 'Lusaka, Zambia'
                  };
                }
              }
            }
          } catch (error) {
            console.error('Error loading pharmacy info:', error);
            this.pharmacyInfo = {
              name: 'Umi Health',
              location: 'Lusaka, Zambia'
            };
          }
        },
        
        loadReportsFromAPI() {
          this.loading = true;
          
          // Use adminAPI for backend integration
          if (window.adminAPI) {
            window.adminAPI.getReports()
              .then(reports => {
                this.reports = reports.map(r => ({
                  id: r.id,
                  name: r.name,
                  type: r.type,
                  date: r.generatedDate ? new Date(r.generatedDate).toLocaleDateString() : '',
                  status: r.status,
                  size: r.size || '0 KB',
                  amount: r.amount || 0,
                  period: r.period || this.formatPeriod(r.startDate, r.endDate)
                }));
                
                // Update dashboard metrics
                this.updateReportMetrics();
                this.loading = false;
              })
              .catch(error => {
                console.error('Error loading reports:', error);
                this.showError('Failed to load reports. Please try again.');
                this.loading = false;
                // Fallback to mock data
                this.loadSampleReports();
              });
          } else {
            // Fallback to data sync or mock data
            try {
              window.adminDataSync.getData('reports', {
                page: 1,
                pageSize: 50,
                search: this.searchQuery,
                period: this.reportPeriod,
                type: this.reportType
              })
              .then(reports => {
                this.reports = reports.map(r => ({
                  id: r.id,
                  name: r.name,
                  type: r.type,
                  date: r.generatedDate ? new Date(r.generatedDate).toLocaleDateString() : '',
                  status: r.status,
                  size: r.size || '0 KB',
                  amount: r.amount || 0,
                  period: r.period || this.formatPeriod(r.startDate, r.endDate)
                }));
                
                this.updateReportMetrics();
                this.loading = false;
              })
              .catch(error => {
                console.error('Data sync error:', error);
                this.loadSampleReports();
                this.loading = false;
              });
            } catch (error) {
              console.error('Data sync not available:', error);
              this.loadSampleReports();
              this.loading = false;
            }
          }
        },
        
        setupEventListeners() {
          if (window.adminDataSync) {
            window.adminDataSync.on('reports-updated', (reports) => {
              this.reports = reports.map(r => ({
                id: r.id,
                name: r.name,
                type: r.type,
                date: r.generatedDate ? new Date(r.generatedDate).toLocaleDateString() : '',
                status: r.status,
                size: r.size || '0 KB'
              }));
              
              this.updateReportMetrics();
            });

            window.adminDataSync.on('sync-error', (error) => {
              console.error('Sync error:', error);
              this.showWarning('Data synchronization error occurred');
            });
          }

          // Set up real-time data synchronization
          this.setupRealtimeSync();
        },

        setupRealtimeSync() {
          // Set up real-time data synchronization
          if (window.dataSync) {
            // Subscribe to reports changes
            window.dataSync.subscribe('reports', (reports) => {
              this.reports = reports;
              this.updateReportMetrics();
            });

            // Subscribe to scheduled reports changes
            window.dataSync.subscribe('scheduledReports', (scheduledReports) => {
              this.scheduledReports = scheduledReports;
            });

            // Subscribe to sales data for real-time updates
            window.dataSync.subscribe('sales', (sales) => {
              this.updateDashboardMetrics();
              this.updateGrowthRate(sales);
            });

            // Subscribe to inventory data
            window.dataSync.subscribe('inventory', (inventory) => {
              this.updateInventoryMetrics(inventory);
            });

            // Subscribe to patient data
            window.dataSync.subscribe('patients', (patients) => {
              this.updateCustomerMetrics(patients);
            });

            // Subscribe to branch data for multi-branch support
            window.dataSync.subscribe('branches', (branches) => {
              this.updateBranchData(branches);
              this.loadCurrentBranchInfo(); // Update sidebar when branches change
            });

            // Subscribe to current branch changes
            window.dataSync.subscribe('currentBranch', (branch) => {
              if (branch) {
                this.pharmacyInfo = {
                  name: branch.name || this.pharmacyInfo.name,
                  location: `${branch.address || branch.city || 'Lusaka'}, ${branch.province || branch.country || 'Zambia'}`
                };
              }
            });
          }

          // Set up WebSocket connection for real-time updates if available
          this.setupWebSocketConnection();
        },

        setupWebSocketConnection() {
          // WebSocket connection for real-time updates
          if (window.WebSocket) {
            try {
              const wsUrl = `ws://localhost:5000/ws/reports?tenant=${this.getTenantId()}`;
              this.ws = new WebSocket(wsUrl);

              this.ws.onopen = () => {
                console.log('WebSocket connected for real-time reports updates');
              };

              this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleRealtimeUpdate(data);
              };

              this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
              };

              this.ws.onclose = () => {
                console.log('WebSocket connection closed');
                // Attempt to reconnect after 5 seconds
                setTimeout(() => {
                  this.setupWebSocketConnection();
                }, 5000);
              };
            } catch (error) {
              console.error('Failed to establish WebSocket connection:', error);
            }
          }
        },

        handleRealtimeUpdate(data) {
          switch (data.type) {
            case 'report_generated':
              this.reports.unshift(data.report);
              this.showSuccess('New report generated!');
              break;
            case 'report_scheduled':
              this.scheduledReports.unshift(data.scheduledReport);
              this.showSuccess('Report scheduled successfully!');
              break;
            case 'sales_update':
              this.updateDashboardMetrics();
              this.updateGrowthRate(window.dataSync.get('sales') || []);
              break;
            case 'inventory_update':
              this.updateInventoryMetrics(data.inventory);
              break;
            case 'patient_update':
              this.updateCustomerMetrics(data.patients);
              break;
            default:
              console.log('Unknown real-time update type:', data.type);
          }
        },

        getTenantId() {
          const currentTenant = localStorage.getItem('umi_current_tenant');
          return currentTenant ? JSON.parse(currentTenant).id : 'default';
        },

        fetchFromAllBranches() {
          // Fetch data from all branches if multi-branch is enabled
          if (this.canManageBranches()) {
            if (window.adminAPI) {
              window.adminAPI.getBranches()
                .then(branches => {
                  branches.forEach(branch => {
                    this.fetchBranchData(branch.id);
                  });
                })
                .catch(error => {
                  console.error('Error fetching branches:', error);
                });
            }
          }
        },

        fetchBranchData(branchId) {
          // Fetch specific branch data
          if (window.adminAPI) {
            window.adminAPI.getBranchData(branchId)
              .then(data => {
                this.mergeBranchData(data);
              })
              .catch(error => {
                console.error(`Error fetching branch ${branchId} data:`, error);
              });
          }
        },

        mergeBranchData(branchData) {
          // Merge branch data with current data
          if (branchData.sales) {
            this.reports = [...this.reports, ...branchData.sales];
          }
          if (branchData.inventory) {
            this.updateInventoryMetrics(branchData.inventory);
          }
          if (branchData.patients) {
            this.updateCustomerMetrics(branchData.patients);
          }
        },

        updateBranchData(branches) {
          // Update branch-related data
          this.availableBranches = branches;
          this.updateReportMetrics();
        },

        updateDashboardMetrics() {
          // Update dashboard metrics with real-time data
          if (window.dataSync) {
            const sales = window.dataSync.get('sales') || [];
            const patients = window.dataSync.get('patients') || [];
            const prescriptions = window.dataSync.get('prescriptions') || [];

            this.totalRevenue = sales.reduce((total, sale) => total + (sale.amount || 0), 0);
            this.totalTransactions = sales.length;
            this.totalPatients = patients.length;
            this.totalPrescriptions = prescriptions.length;
          } else {
            // Default values when no data sync available
            this.totalRevenue = 0;
            this.totalTransactions = 0;
            this.totalPatients = 0;
            this.totalPrescriptions = 0;
          }
        },
        
        updateReportMetrics() {
          // Calculate metrics from reports data
          this.totalRevenue = this.reports
            .filter(r => r.type === 'sales')
            .reduce((total, r) => total + (r.amount || 0), 0);
          
          this.totalTransactions = this.reports
            .filter(r => r.type === 'sales')
            .length;
          
          this.totalPatients = this.reports
            .filter(r => r.type === 'patients')
            .length;
          
          this.totalPrescriptions = this.reports
            .filter(r => r.type === 'prescriptions')
            .length;
        },
        
        // Notification methods
        showSuccess(message) {
          this.showNotification(message, 'success');
        },

        showError(message) {
          this.showNotification(message, 'error');
        },

        showWarning(message) {
          this.showNotification(message, 'warning');
        },

        showNotification(message, type = 'info') {
          // Create notification element
          const notification = document.createElement('div');
          notification.className = `notification notification-${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);

          // Animate in
          setTimeout(() => {
            notification.classList.add('show');
          }, 100);

          // Remove after 5 seconds
          setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
              if (notification.parentNode) {
                document.body.removeChild(notification);
              }
            }, 300);
          }, 5000);
        },

        get filteredReports() {
          return this.reports.filter(report => {
            const matchesSearch = report.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                                report.type.toLowerCase().includes(this.searchQuery.toLowerCase());
            const matchesType = this.reportType === 'all' || report.type.toLowerCase() === this.reportType.toLowerCase();
            return matchesSearch && matchesType;
          });
        },

        openGenerateReportModal() {
          this.showGenerateReportModal = true;
          this.resetNewReport();
        },

        resetNewReport() {
          this.newReport = {
            name: '',
            type: '',
            startDate: '',
            endDate: '',
            format: 'pdf',
            email: 'no',
            description: ''
          };
        },

        submitGenerateReport() {
          // Auto-generate name if not provided
          if (!this.newReport.name && this.newReport.type) {
            this.newReport.name = this.generateReportName(this.newReport.type);
          }

          if (!this.newReport.name || !this.newReport.type || !this.newReport.startDate || !this.newReport.endDate) {
            this.showError('Please fill in all required fields');
            return;
          }

          // Use adminAPI for backend integration
          if (window.adminAPI) {
            const reportData = {
              name: this.newReport.name,
              type: this.newReport.type,
              startDate: this.newReport.startDate,
              endDate: this.newReport.endDate,
              format: this.newReport.format,
              email: this.newReport.email === 'yes',
              description: this.newReport.description
            };

            window.adminAPI.generateReport(this.newReport.type, {
              name: this.newReport.name,
              startDate: this.newReport.startDate,
              endDate: this.newReport.endDate,
              format: this.newReport.format,
              email: this.newReport.email === 'yes',
              description: this.newReport.description
            })
            .then(response => {
              const report = {
                id: response.id || Date.now(),
                name: this.newReport.name,
                type: this.newReport.type,
                period: `${this.formatDate(this.newReport.startDate)} - ${this.formatDate(this.newReport.endDate)}`,
                status: response.status || 'Processing',
                date: this.formatDate(new Date()),
                amount: response.amount || 0
              };

              this.reports.unshift(report);
              this.showGenerateReportModal = false;
              this.resetNewReport();
              this.showSuccess('Report generated successfully!');
              this.saveReports();
              
              // Refresh reports list
              this.loadReportsFromAPI();
            })
            .catch(error => {
              console.error('Error generating report:', error);
              this.showError('Failed to generate report. Please try again.');
            });
          } else {
            // Fallback to local storage with real data fetching
            const report = {
              id: Date.now(),
              name: this.newReport.name,
              type: this.newReport.type,
              period: `${this.formatDate(this.newReport.startDate)} - ${this.formatDate(this.newReport.endDate)}`,
              status: 'Completed',
              date: this.formatDate(new Date()),
              amount: this.calculateReportAmount(this.newReport.type)
            };

            this.reports.unshift(report);
            this.showGenerateReportModal = false;
            this.resetNewReport();
            this.showSuccess('Report generated successfully!');
            this.saveReports();
          }
        },

        calculateReportAmount(reportType) {
          // Calculate actual report amount based on real data
          if (window.dataSync) {
            switch (reportType) {
              case 'sales':
                const sales = window.dataSync.get('sales') || [];
                return sales.reduce((total, sale) => total + (sale.amount || 0), 0);
              case 'inventory':
                const inventory = window.dataSync.get('inventory') || [];
                return inventory.reduce((total, item) => total + ((item.quantity || 0) * (item.price || 0)), 0);
              case 'financial':
                return this.totalRevenue;
              case 'customer':
              case 'patient':
                const patients = window.dataSync.get('patients') || [];
                return patients.length;
              default:
                return 0;
            }
          }
          return 0;
        },

        saveReports() {
          // Save reports to localStorage for persistence
          localStorage.setItem('umi_reports', JSON.stringify(this.reports));
          
          // Trigger data sync
          if (window.dataSync) {
            window.dataSync.set('reports', this.reports);
          }
        },

        exportReport() {
          console.log('Exporting report...');
          alert('Report exported successfully!');
        },

        formatCurrency(amount) {
          return new Intl.NumberFormat('en-ZM', {
            style: 'currency',
            currency: 'ZMW'
          }).format(amount);
        },

        formatDate(date) {
          return new Date(date).toLocaleDateString('en-ZM', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        },

        logout() {
          if (confirm('Are you sure you want to logout?')) {
            window.location.href = 'index.html';
          }
        },

        canManageBranches() {
          try {
            // Check if user is an admin role
            const currentUser = JSON.parse(localStorage.getItem('umi_current_user') || '{}');
            console.log('Current user:', currentUser); // Debug log
            const isAdmin = currentUser.role === 'super_admin' || currentUser.role === 'tenant_admin' || currentUser.role === 'operations';
            console.log('Is admin:', isAdmin); // Debug log
            
            // Admin users always have access to branches
            if (isAdmin) {
              return true;
            }
            
            // For non-admin users, check subscription plan
            const subscription = JSON.parse(localStorage.getItem('umi_subscription') || '{}');
            console.log('Subscription:', subscription); // Debug log
            const planType = subscription.planType || 'Care';
            
            const tierConfig = {
              'Care': { maxBranches: 1 },
              'Care Plus': { maxBranches: 3 },
              'Care Pro': { maxBranches: 10 }
            };
            
            const hasBranchPermission = tierConfig[planType] ? tierConfig[planType].maxBranches > 1 : false;
            
            // Check if there are actually multiple branches
            const branches = this.availableBranches || [];
            const hasMultipleBranches = branches.length > 1;
            
            return hasBranchPermission || hasMultipleBranches;
          } catch (error) {
            console.error('Error checking branch permissions:', error);
            return false;
          }
        },

        setupEventListeners() {
          // Widget menu toggles
          document.querySelectorAll('[data-menu]').forEach(button => {
            button.addEventListener('click', (e) => {
              e.stopPropagation();
              const menuId = button.getAttribute('aria-controls');
              const menu = document.getElementById(menuId);
              
              // Close all other menus
              document.querySelectorAll('.widget-menu').forEach(m => {
                if (m !== menu) m.hidden = true;
              });
              
              menu.hidden = !menu.hidden;
              button.setAttribute('aria-expanded', !menu.hidden);
            });
          });

          // Close menus when clicking outside
          document.addEventListener('click', () => {
            document.querySelectorAll('.widget-menu').forEach(menu => {
              menu.hidden = true;
            });
            document.querySelectorAll('[data-menu]').forEach(button => {
              button.setAttribute('aria-expanded', 'false');
            });
          });

          // Widget action buttons
          document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', (e) => {
              e.stopPropagation();
              const action = button.getAttribute('data-action');
              this.handleWidgetAction(action);
            });
          });

          // Report action buttons
          document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', (e) => {
              if (button.closest('.actions')) {
                e.stopPropagation();
                const action = button.getAttribute('data-action');
                this.handleReportAction(action, button);
              }
            });
          });
        },

        handleWidgetAction(action) {
          switch(action) {
            case 'refresh-revenue':
              this.refreshRevenueChart();
              break;
            case 'export-revenue':
              this.exportChart('revenue');
              break;
            case 'refresh-category':
              this.refreshCategoryChart();
              break;
            case 'export-category':
              this.exportChart('category');
              break;
            case 'refresh-top-products':
              this.refreshTopProducts();
              break;
            case 'view-all-products':
              this.viewAllProducts();
              break;
            case 'refresh-inventory':
              this.refreshInventoryMetrics();
              break;
            case 'export-inventory':
              this.exportInventoryReport();
              break;
            case 'refresh-customer':
              this.refreshCustomerInsights();
              break;
            case 'export-customer':
              this.exportCustomerInsights();
              break;
          }
        },

        handleReportAction(action, button) {
          const row = button.closest('tr');
          const reportId = parseInt(row.querySelector('[data-column="date"]').textContent);
          
          switch(action) {
            case 'view':
              this.viewReport(reportId);
              break;
            case 'download':
              this.downloadReport(reportId);
              break;
            case 'share':
              this.shareReport(reportId);
              break;
          }
        },

        refreshRevenueChart() {
          // Use adminAPI to get fresh sales data
          if (window.adminAPI) {
            window.adminAPI.getSales({ 
              period: this.reportPeriod,
              type: 'revenue' 
            })
            .then(salesData => {
              this.updateRevenueChart(salesData);
              this.showSuccess('Revenue chart refreshed successfully!');
            })
            .catch(error => {
              console.error('Error refreshing revenue chart:', error);
              this.showError('Failed to refresh revenue chart.');
            });
          } else {
            console.log('Refreshing revenue chart...');
            this.showWarning('Admin API not available - using mock data');
          }
        },

        refreshCategoryChart() {
          console.log('Refreshing category chart...');
          // Implement refresh logic
        },

        refreshTopProducts() {
          // Use adminAPI to get fresh product data
          if (window.adminAPI) {
            window.adminAPI.getInventory({ 
              sortBy: 'sales',
              limit: 10 
            })
            .then(products => {
              this.topProducts = products.map(p => ({
                name: p.name,
                sales: p.sales || 0,
                revenue: p.revenue || 0
              }));
              this.showSuccess('Top products refreshed successfully!');
            })
            .catch(error => {
              console.error('Error refreshing top products:', error);
              this.showError('Failed to refresh top products.');
              this.loadSampleTopProducts();
            });
          } else {
            this.loadSampleTopProducts();
          }
        },

        viewAllProducts() {
          console.log('Viewing all products...');
          // Implement navigation to products page
        },

        refreshInventoryMetrics() {
          // Use adminAPI to get fresh inventory data
          if (window.adminAPI) {
            window.adminAPI.getInventory()
              .then(inventory => {
                // Update inventory metrics
                this.updateInventoryMetrics(inventory);
                this.showSuccess('Inventory metrics refreshed successfully!');
              })
              .catch(error => {
                console.error('Error refreshing inventory metrics:', error);
                this.showError('Failed to refresh inventory metrics.');
              });
          } else {
            console.log('Refreshing inventory metrics...');
            this.showWarning('Admin API not available - using mock data');
          }
        },

        exportInventoryReport() {
          console.log('Exporting inventory report...');
          alert('Inventory report exported successfully!');
        },

        refreshCustomerInsights() {
          // Use adminAPI to get fresh patient data
          if (window.adminAPI) {
            window.adminAPI.getPatients({ 
              period: this.reportPeriod 
            })
            .then(patients => {
              this.updateCustomerMetrics(patients);
              this.showSuccess('Customer insights refreshed successfully!');
            })
            .catch(error => {
              console.error('Error refreshing customer insights:', error);
              this.showError('Failed to refresh customer insights.');
            });
          } else {
            console.log('Refreshing customer insights...');
            this.showWarning('Admin API not available - using mock data');
          }
        },

        exportCustomerInsights() {
          console.log('Exporting customer insights...');
          alert('Customer insights exported successfully!');
        },

        exportChart(chartType) {
          console.log(`Exporting ${chartType} chart...`);
          alert(`${chartType} chart exported successfully!`);
        },

        viewReport(reportId) {
          console.log('Viewing report:', reportId);
          alert('Opening report viewer...');
        },

        downloadReport(reportId) {
          console.log('Downloading report:', reportId);
          
          // Use adminAPI for backend integration
          if (window.adminAPI) {
            window.adminAPI.downloadReport(reportId)
              .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report-${reportId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                this.showSuccess('Report downloaded successfully!');
              })
              .catch(error => {
                console.error('Error downloading report:', error);
                this.showError('Failed to download report. Please try again.');
              });
          } else {
            // Fallback to mock download
            this.showSuccess('Report downloaded successfully!');
          }
        },

        shareReport(reportId) {
          console.log('Sharing report:', reportId);
          alert('Report share link copied to clipboard!');
        },

        loadSampleTopProducts() {
          // Initialize empty top products array - real data will be loaded from API
          this.topProducts = [];
        },

        loadSampleReports() {
          // Initialize empty reports array - real data will be loaded from API
          this.reports = [];
        },

        formatPeriod(startDate, endDate) {
          if (!startDate || !endDate) return '';
          return `${this.formatDate(startDate)} - ${this.formatDate(endDate)}`;
        },

        updateRevenueChart(salesData) {
          // Update the revenue chart with new data
          const chart = Chart.getChart('revenueChart');
          if (chart && salesData) {
            chart.data.labels = salesData.labels || ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            chart.data.datasets[0].data = salesData.data || [12000, 15000, 13500, 18000];
            chart.update();
          }
        },

        updateInventoryMetrics(inventory) {
          // Update inventory metrics with real data
          if (inventory && inventory.length > 0) {
            this.totalStockValue = inventory.reduce((sum, item) => sum + ((item.quantity || 0) * (item.price || 0)), 0);
            this.lowStockItems = inventory.filter(item => item.stockLevel < (item.minStock || 10)).length;
            this.expiringItems = inventory.filter(item => item.daysToExpiry < 30).length;
            
            // Calculate turnover rate
            const totalItems = inventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
            const soldItems = inventory.reduce((sum, item) => sum + (item.sold || 0), 0);
            this.turnoverRate = totalItems > 0 ? `${(soldItems / totalItems).toFixed(1)}x` : '0x';
          } else {
            // Default values when no data
            this.totalStockValue = 0;
            this.lowStockItems = 0;
            this.expiringItems = 0;
            this.turnoverRate = '0x';
          }
        },

        updateCustomerMetrics(patients) {
          // Update customer insights with real data
          if (patients && patients.length > 0) {
            this.totalPatients = patients.length;
            this.newPatients = patients.filter(p => p.isNew || this.isNewPatient(p.createdAt)).length;
            
            const repeatPatients = patients.filter(p => p.visitCount > 1).length;
            this.repeatRate = this.totalPatients > 0 ? `${Math.round((repeatPatients / this.totalPatients) * 100)}%` : '0%';
            
            // Calculate average purchase value from sales data
            if (window.dataSync) {
              const sales = window.dataSync.get('sales') || [];
              const totalSales = sales.reduce((sum, sale) => sum + (sale.amount || 0), 0);
              this.avgPurchaseValue = sales.length > 0 ? totalSales / sales.length : 0;
            }
          } else {
            // Default values when no data
            this.totalPatients = 0;
            this.newPatients = 0;
            this.repeatRate = '0%';
            this.avgPurchaseValue = 0;
          }
        },

        isNewPatient(createdAt) {
          if (!createdAt) return false;
          const createdDate = new Date(createdAt);
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          return createdDate > thirtyDaysAgo;
        },

        init() {
          this.loadSampleTopProducts();
          this.loadSampleReports();
          this.initCharts();
          this.setupEventListeners();
          this.loadReportsFromAPI();
        },

        initCharts() {
          // Revenue Chart - Initialize with empty data, will be populated by real data
          const revenueCtx = document.getElementById('revenueChart').getContext('2d');
          this.revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: 'rgb(0, 0, 0)',
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return 'ZMW ' + value.toLocaleString();
                    }
                  }
                }
              }
            }
          });

          // Category Chart - Initialize with empty data
          const categoryCtx = document.getElementById('categoryChart').getContext('2d');
          this.categoryChart = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
              labels: [],
              datasets: [{
                data: [],
                backgroundColor: [
                  'rgba(0, 0, 0, 0.8)',
                  'rgba(107, 114, 128, 0.8)',
                  'rgba(156, 163, 175, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });

          // Load real data into charts
          this.loadChartData();
        },

        loadChartData() {
          // Load real data into charts
          if (window.dataSync) {
            const sales = window.dataSync.get('sales') || [];
            const inventory = window.dataSync.get('inventory') || [];
            
            // Update revenue chart with real sales data
            this.updateRevenueChartWithData(sales);
            
            // Update category chart with real inventory data
            this.updateCategoryChartWithData(inventory);
          }
        },

        updateRevenueChartWithData(sales) {
          if (!this.revenueChart || !sales.length) return;
          
          // Group sales by period (week/month)
          const groupedSales = this.groupSalesByPeriod(sales);
          
          this.revenueChart.data.labels = Object.keys(groupedSales);
          this.revenueChart.data.datasets[0].data = Object.values(groupedSales);
          this.revenueChart.update();
        },

        updateCategoryChartWithData(inventory) {
          if (!this.categoryChart || !inventory.length) return;
          
          // Group inventory by category
          const groupedInventory = this.groupInventoryByCategory(inventory);
          
          this.categoryChart.data.labels = Object.keys(groupedInventory);
          this.categoryChart.data.datasets[0].data = Object.values(groupedInventory);
          this.categoryChart.update();
        },

        groupSalesByPeriod(sales) {
          const grouped = {};
          sales.forEach(sale => {
            const period = this.getPeriodFromDate(new Date(sale.date));
            grouped[period] = (grouped[period] || 0) + (sale.amount || 0);
          });
          return grouped;
        },

        groupInventoryByCategory(inventory) {
          const grouped = {};
          inventory.forEach(item => {
            const category = item.category || 'Uncategorized';
            grouped[category] = (grouped[category] || 0) + (item.quantity || 0);
          });
          return grouped;
        },

        getPeriodFromDate(date) {
          // Get week or month period from date
          const week = Math.ceil(date.getDate() / 7);
          return `Week ${week}`;
        },
      }
    }
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
