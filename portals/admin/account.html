<!DOCTYPE html>
<html lang="en" x-data="accountSystem()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Account Settings - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="../../shared/css/shared-styles.css">
  <script src="../../shared/js/data-sync.js"></script>
  <script src="../../shared/js/role-based-access.js"></script>
  <script src="../../shared/js/feature-protection.js"></script>
  <script src="js/admin-api.js"></script>
  <style>
    :root {
      --color-primary: #000000;
      --color-accent: #14B8A6;
      --color-success: #22c55e;
      --color-warning: #ef4444;
      --color-text-primary: #000000;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      --color-background: #ffffff;
      --color-surface: #f9fafb;
      --color-border: #e5e7eb;
      --font-primary: 'Inter', sans-serif;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      font-family: 'Nunito', 'Varela Round', sans-serif;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--color-text-primary);
      color: var(--color-accent);
      z-index: 1000;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }

    .pharmacy-info {
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      margin: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 0.85rem;
    }

    .pharmacy-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .pharmacy-location {
      opacity: 0.8;
      font-size: 0.75rem;
    }

    .nav-menu {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-accent);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-accent);
      border-left: 3px solid var(--color-accent);
    }

    .nav-icon {
      font-size: 1.25rem;
    }

    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    /* Header Styles */
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-title-section {
      margin-right: 2rem;
    }

    .page-title-section .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0;
      font-family: 'Inter', sans-serif;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-profile:hover {
      background: var(--color-surface);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--color-text-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.875rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    /* Account Content */
    .account-content {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Settings Grid */
    .settings-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
    }

    /* Settings Navigation */
    .settings-nav {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      padding: 1.5rem;
      height: fit-content;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .settings-nav-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1.5rem;
      font-family: 'Inter', sans-serif;
    }

    .settings-nav-list {
      list-style: none;
    }

    .settings-nav-item {
      margin-bottom: 0.5rem;
    }

    .settings-nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      text-decoration: none;
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .settings-nav-link:hover {
      background: var(--color-surface);
      color: var(--color-text-primary);
    }

    .settings-nav-link.active {
      background: var(--color-primary);
      color: var(--color-accent);
    }

    .settings-nav-icon {
      font-size: 1.125rem;
    }

    /* Settings Content */
    .settings-content {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .settings-section {
      margin-bottom: 2rem;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1.5rem;
      font-family: 'Inter', sans-serif;
    }

    .section-description {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-input {
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--color-background);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .section-title-sub {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 2rem 0 1.5rem 0;
      font-family: 'Inter', sans-serif;
    }

    /* Profile Section */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding: 2rem;
      background: var(--color-surface);
      border-radius: 16px;
      margin-bottom: 2rem;
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      background: var(--color-text-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-accent);
      font-weight: 600;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
    }

    .profile-email {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .profile-role {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.1);
      color: var(--color-text-secondary);
    }

    /* Button Styles */
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background: var(--color-text-secondary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-border);
    }

    .btn-danger {
      background: var(--color-warning);
      color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
    }

    /* Security Section */
    .security-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .security-info {
      flex: 1;
    }

    .security-title {
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .security-description {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .security-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .security-status.enabled {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .security-status.disabled {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    /* Notification Settings */
    .notification-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--color-border);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-info {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .notification-description {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: var(--color-border);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--color-success);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--color-accent);
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    .logout-section {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }

    .logout-button {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
    }

    .logout-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .logout-icon {
      font-size: 1.25rem;
    }

    .profile-icon {
      font-size: 0.75rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .page-title-section {
        display: none;
      }

      .account-content {
        padding: 1rem;
      }

      .settings-grid {
        grid-template-columns: 1fr;
      }

      .settings-nav {
        order: 2;
      }

      .settings-content {
        order: 1;
      }

      .profile-section {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>

    <div class="pharmacy-info">
      <div class="pharmacy-name" x-text="pharmacyInfo.name"></div>
      <div class="pharmacy-location" x-text="pharmacyInfo.location"></div>
    </div>

    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="point-of-sale.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">point_of_sale</span>
        <span>Point of Sale</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory_2</span>
        <span>Inventory</span>
      </a>
      <a href="prescriptions.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">prescriptions</span>
        <span>Prescriptions</span>
      </a>
      <a href="patients.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="sales.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">receipt_long</span>
        <span>Sales</span>
      </a>
      <a href="payments.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">payments</span>
        <span>Payments</span>
      </a>
      <a href="reports.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">analytics</span>
        <span>Reports</span>
      </a>
      <a href="user-management.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">admin_panel_settings</span>
        <span>User Management</span>
      </a>
      <!-- Branch navigation - always visible for all users -->
      <a href="branches.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">business</span>
        <span>Branches</span>
      </a>
      <a href="account.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">settings</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        
        <div class="page-title-section">
          <h1 class="page-title">Account Settings</h1>
        </div>
        
        <div class="search-bar" x-data="{ searchOpenLocal: false }">
          <span class="material-symbols-rounded search-icon">search</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search settings by name or category..."
            x-model="searchQuery"
            @focus="searchOpenLocal = true; searchOpen = true"
            @input="searchOpenLocal = true; searchOpen = true"
            @blur="setTimeout(() => { searchOpenLocal = false; searchOpen = false; }, 200)"
          >
          
          <div class="search-suggestions" :class="searchOpenLocal && searchQuery.length > 0 ? 'show' : ''">
            <template x-for="suggestion in filteredSuggestions" :key="suggestion.id">
              <div class="suggestion-item" @click="selectSuggestion(suggestion)">
                <div class="suggestion-icon">
                  <span class="material-symbols-rounded" x-text="suggestion.icon"></span>
                </div>
                <div class="suggestion-content">
                  <div class="suggestion-title" x-text="suggestion.title"></div>
                  <div class="suggestion-description" x-text="suggestion.description"></div>
                </div>
                <div class="suggestion-type" x-text="suggestion.type"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div class="header-right">
        <!-- Header elements removed per request -->
      </div>
    </header>

    <!-- Account Content -->
    <div class="account-content">
      <div class="settings-grid">
        <!-- Settings Navigation -->
        <div class="settings-nav">
          <h3 class="settings-nav-title">Settings</h3>
          <ul class="settings-nav">
            <li class="settings-nav-item">
              <a href="#" class="settings-nav-link" :class="{ 'active': activeSection === 'profile' }" @click="switchTab('profile')">
                <span class="material-symbols-rounded settings-nav-icon">person</span>
                <span>Profile</span>
              </a>
            </li>
            <li class="settings-nav-item">
              <a href="#" class="settings-nav-link" :class="{ 'active': activeSection === 'security' }" @click="switchTab('security')">
                <span class="material-symbols-rounded settings-nav-icon">security</span>
                <span>Security</span>
              </a>
            </li>
            <li class="settings-nav-item">
              <a href="#" class="settings-nav-link" :class="{ 'active': activeSection === 'notifications' }" @click="switchTab('notifications')">
                <span class="material-symbols-rounded settings-nav-icon">notifications</span>
                <span>Notifications</span>
              </a>
            </li>
            <li class="settings-nav-item">
              <a href="#" class="settings-nav-link" :class="{ 'active': activeSection === 'pharmacy' }" @click="switchTab('pharmacy')">
                <span class="material-symbols-rounded settings-nav-icon">business</span>
                <span>Pharmacy Settings</span>
              </a>
            </li>
            <li class="settings-nav-item">
              <a href="#" class="settings-nav-link" :class="{ 'active': activeSection === 'billing' }" @click="switchTab('billing')">
                <span class="material-symbols-rounded settings-nav-icon">payments</span>
                <span>Billing</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
          <!-- Profile Section -->
          <div x-show="activeSection === 'profile'">
            <div class="profile-section">
              <div class="profile-avatar-large" x-text="userInfo.initials"></div>
              <div class="profile-info">
                <div class="profile-name" x-text="userInfo.name"></div>
                <div class="profile-email" x-text="userInfo.email"></div>
                <span class="profile-role">
                  <span class="material-symbols-rounded profile-icon">person</span>
                  <span x-text="userInfo.role"></span>
                </span>
              </div>
            </div>

            <div class="settings-section">
              <h2 class="section-title">Personal Information</h2>
              <p class="section-description">Update your personal information and contact details.</p>
              
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="firstName">First Name</label>
                  <input type="text" id="firstName" class="form-input" x-model="profile.firstName" placeholder="Enter first name">
                </div>
                <div class="form-group">
                  <label class="form-label" for="lastName">Last Name</label>
                  <input type="text" id="lastName" class="form-input" x-model="profile.lastName" placeholder="Enter last name">
                </div>
                <div class="form-group">
                  <label class="form-label" for="email">Email Address</label>
                  <input type="email" id="email" class="form-input" x-model="profile.email" placeholder="Enter email address">
                </div>
                <div class="form-group">
                  <label class="form-label" for="phone">Phone Number</label>
                  <input type="tel" id="phone" class="form-input" x-model="profile.phone" placeholder="Enter phone number">
                </div>
                <div class="form-group full-width">
                  <label class="form-label" for="bio">Bio</label>
                  <textarea id="bio" class="form-input form-textarea" x-model="profile.bio" placeholder="Enter your bio"></textarea>
                </div>
              </div>

              <div class="button-group">
                <button class="btn btn-secondary">Cancel</button>
                <button class="btn btn-primary" @click="saveProfile">
                  <span class="material-symbols-rounded">save</span>
                  <span>Save Changes</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Security Section -->
          <div x-show="activeSection === 'security'">
            <div class="settings-section">
              <h2 class="section-title">Security Settings</h2>
              <p class="section-description">Manage your password and security preferences.</p>
              
              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Password</div>
                  <div class="security-description" x-text="'Last changed ' + (passwordInfo.lastChanged || 'Never')"></div>
                </div>
                <button class="btn btn-secondary" @click="showPasswordModal = true">Change Password</button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Two-Factor Authentication</div>
                  <div class="security-description" x-text="twoFactorEnabled ? 'Extra security is enabled for your account' : 'Add an extra layer of security to your account'"></div>
                </div>
                <div>
                  <span class="security-status" :class="twoFactorEnabled ? 'active' : 'disabled'" x-text="twoFactorEnabled ? 'Enabled' : 'Disabled'"></span>
                  <button class="btn btn-secondary btn-sm two-factor-btn" @click="showTwoFactorModal = true" :title="twoFactorEnabled ? 'Manage two-factor authentication settings' : 'Enable two-factor authentication'" x-text="twoFactorEnabled ? 'Manage' : 'Enable'"></button>
                </div>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Login Sessions</div>
                  <div class="security-description" x-text="activeSessions.length + ' active session(s)'"></div>
                </div>
                <button class="btn btn-secondary" @click="showSessionsModal = true">View Sessions</button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">API Keys</div>
                  <div class="security-description">Manage your API access keys</div>
                </div>
                <button class="btn btn-secondary">Manage Keys</button>
              </div>
            </div>
          </div>

          <!-- Change Password Modal -->
          <div class="modal-overlay" :class="{ 'show': showPasswordModal }" @click="showPasswordModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <p class="modal-subtitle">Update your account password for security</p>
              </div>
              
              <div class="modal-body">
                <div class="form-group">
                  <label class="form-label" for="currentPassword">Current Password</label>
                  <input type="password" id="currentPassword" class="form-input" x-model="passwordForm.currentPassword" placeholder="Enter current password">
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="newPassword">New Password</label>
                  <input type="password" id="newPassword" class="form-input" x-model="passwordForm.newPassword" placeholder="Enter new password">
                  <div class="password-requirements">
                    <small x-show="passwordForm.newPassword">
                      Password must contain:
                      <div :class="passwordRequirements.hasMinLength ? 'text-success' : 'text-muted'">• At least 8 characters</div>
                      <div :class="passwordRequirements.hasLetter ? 'text-success' : 'text-muted'">• At least one letter</div>
                      <div :class="passwordRequirements.hasNumber ? 'text-success' : 'text-muted'">• At least one number</div>
                    </small>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="confirmPassword">Confirm New Password</label>
                  <input type="password" id="confirmPassword" class="form-input" x-model="passwordForm.confirmPassword" placeholder="Confirm new password">
                  <div class="field-error" x-show="passwordForm.confirmPassword && passwordForm.newPassword !== passwordForm.confirmPassword">
                    Passwords do not match
                  </div>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="cancelPasswordChange()">Cancel</button>
                <button class="btn btn-primary" @click="changePassword()" :disabled="!isPasswordFormValid()">
                  <span class="material-symbols-rounded">lock</span>
                  Change Password
                </button>
              </div>
            </div>
          </div>

          <!-- Sessions Modal -->
          <div class="modal-overlay" :class="{ 'show': showSessionsModal }" @click="showSessionsModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Active Login Sessions</h3>
                <p class="modal-subtitle">Manage your active login sessions across devices</p>
              </div>
              
              <div class="modal-body">
                <div class="sessions-list">
                  <template x-for="session in activeSessions" :key="session.id">
                    <div class="session-item">
                      <div class="session-info">
                        <div class="session-device" x-text="session.device"></div>
                        <div class="session-details">
                          <span x-text="session.location"></span> • 
                          <span x-text="session.lastActive"></span>
                        </div>
                      </div>
                      <div class="session-actions">
                        <span class="session-status" :class="session.current ? 'current' : ''" x-text="session.current ? 'Current' : ''"></span>
                        <button class="btn btn-danger btn-sm" x-show="!session.current" @click="revokeSession(session.id)">
                          Revoke
                        </button>
                      </div>
                    </div>
                  </template>
                </div>
                
                <div class="sessions-footer">
                  <button class="btn btn-danger" @click="revokeAllSessions()" x-show="activeSessions.length > 1">
                    Revoke All Other Sessions
                  </button>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="showSessionsModal = false">Close</button>
              </div>
            </div>
          </div>

          <!-- Two-Factor Authentication Modal -->
          <div class="modal-overlay" :class="{ 'show': showTwoFactorModal }" @click="showTwoFactorModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Two-Factor Authentication</h3>
                <p class="modal-subtitle" x-text="twoFactorEnabled ? 'Manage your 2FA settings' : 'Set up two-factor authentication for enhanced security'"></p>
              </div>
              
              <div class="modal-body">
                <!-- Introduction Step -->
                <div x-show="twoFactorSetup.step === 'intro'">
                  <div class="two-factor-intro">
                    <h4>Choose your 2FA method:</h4>
                    <div class="two-factor-methods">
                      
                      <div class="method-card" :class="{ selected: twoFactorSetup.method === 'sms' }" @click="twoFactorSetup.method = 'sms'">
                        <div class="method-icon">
                          <span class="material-symbols-rounded">sms</span>
                        </div>
                        <div class="method-info">
                          <div class="method-name">SMS</div>
                          <div class="method-description">Receive codes via text message</div>
                        </div>
                      </div>
                      
                      <div class="method-card" :class="{ selected: twoFactorSetup.method === 'email' }" @click="twoFactorSetup.method = 'email'">
                        <div class="method-icon">
                          <span class="material-symbols-rounded">email</span>
                        </div>
                        <div class="method-info">
                          <div class="method-name">Email</div>
                          <div class="method-description">Receive codes via email</div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="form-group" x-show="twoFactorSetup.method === 'sms'">
                      <label class="form-label">Phone Number</label>
                      <input type="tel" class="form-input" x-model="twoFactorSetup.phoneNumber" placeholder="+260123456789">
                    </div>
                  </div>
                </div>
                
                <!-- Setup Step -->
                <div x-show="twoFactorSetup.step === 'setup'">
                  <div class="two-factor-setup">
                    <div x-show="twoFactorSetup.method === 'app'">
                      <h4>Set up your authenticator app:</h4>
                      <ol>
                        <li>Open your authenticator app (Google Authenticator, Authy, etc.)</li>
                        <li>Scan the QR code below or enter the secret manually</li>
                        <li>Enter the 6-digit code to verify</li>
                      </ol>
                      <div class="qr-code-placeholder">
                        <div class="qr-code">
                          <span class="material-symbols-rounded">qr_code_2</span>
                          <p>QR Code would appear here</p>
                        </div>
                      </div>
                    </div>
                    
                    <div x-show="twoFactorSetup.method === 'sms'">
                      <h4>Verify your phone number:</h4>
                      <p>We'll send a verification code to <strong x-text="twoFactorSetup.phoneNumber"></strong></p>
                    </div>
                    
                    <div x-show="twoFactorSetup.method === 'email'">
                      <h4>Verify your email:</h4>
                      <p>We'll send a verification code to <strong x-text="userInfo.email"></strong></p>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Verification Code</label>
                      <input type="text" class="form-input" x-model="twoFactorSetup.verificationCode" placeholder="Enter 6-digit code" maxlength="6">
                    </div>
                  </div>
                </div>
                
                <!-- Complete Step -->
                <div x-show="twoFactorSetup.step === 'complete'">
                  <div class="two-factor-complete">
                    <div class="success-icon">
                      <span class="material-symbols-rounded">check_circle</span>
                    </div>
                    <h4>Two-Factor Authentication Enabled!</h4>
                    <p>Your account is now protected with an extra layer of security.</p>
                    
                    <div class="backup-codes">
                      <h5>Backup Codes</h5>
                      <p>Save these backup codes in a safe place. You can use them to access your account if you lose your 2FA device.</p>
                      <div class="backup-codes-list">
                        <template x-for="(code, index) in twoFactorSetup.backupCodes" :key="index">
                          <div class="backup-code" x-text="code"></div>
                        </template>
                      </div>
                      <button class="btn btn-secondary btn-sm" @click="downloadBackupCodes()">
                        <span class="material-symbols-rounded">download</span>
                        Download Codes
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="cancelTwoFactorSetup()">Cancel</button>
                <button class="btn btn-primary" @click="nextTwoFactorStep()" x-show="twoFactorSetup.step !== 'complete'">
                  <span x-show="twoFactorSetup.step === 'intro'">Continue</span>
                  <span x-show="twoFactorSetup.step === 'setup'">Enable 2FA</span>
                </button>
                <button class="btn btn-primary" @click="showTwoFactorModal = false" x-show="twoFactorSetup.step === 'complete'">
                  Done
                </button>
              </div>
            </div>
          </div>

          <!-- Notifications Section -->
          <div x-show="activeSection === 'notifications'">
            <div class="settings-section">
              <h2 class="section-title">Notification Preferences</h2>
              <p class="section-description">Choose how you want to be notified about important updates.</p>
              
              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-title">Email Notifications</div>
                  <div class="notification-description">Receive notifications via email</div>
                </div>
                <div class="toggle-switch" :class="notifications.email ? 'active' : ''" @click="notifications.email = !notifications.email">
                  <div class="toggle-slider"></div>
                </div>
              </div>

              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-title">Push Notifications</div>
                  <div class="notification-description">Receive browser push notifications</div>
                </div>
                <div class="toggle-switch" :class="notifications.push ? 'active' : ''" @click="notifications.push = !notifications.push">
                  <div class="toggle-slider"></div>
                </div>
              </div>

              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-title">Sales Alerts</div>
                  <div class="notification-description">Get notified about new sales transactions</div>
                </div>
                <div class="toggle-switch" :class="notifications.sales ? 'active' : ''" @click="notifications.sales = !notifications.sales">
                  <div class="toggle-slider"></div>
                </div>
              </div>

              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-title">Inventory Alerts</div>
                  <div class="notification-description">Get notified about low stock levels</div>
                </div>
                <div class="toggle-switch" :class="notifications.inventory ? 'active' : ''" @click="notifications.inventory = !notifications.inventory">
                  <div class="toggle-slider"></div>
                </div>
              </div>

              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-title">Prescription Alerts</div>
                  <div class="notification-description">Get notified about new prescriptions</div>
                </div>
                <div class="toggle-switch" :class="notifications.prescriptions ? 'active' : ''" @click="notifications.prescriptions = !notifications.prescriptions">
                  <div class="toggle-slider"></div>
                </div>
              </div>

              <div class="button-group">
                <button class="btn btn-primary" @click="saveNotifications">
                  <span class="material-symbols-rounded">save</span>
                  <span>Save Preferences</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Pharmacy Settings Section -->
          <div x-show="activeSection === 'pharmacy'">
            <div class="settings-section">
              <h2 class="section-title">Pharmacy Settings</h2>
              <p class="section-description">Configure your pharmacy's business information and preferences. These settings will be used across all documents including receipts, reports, and payments.</p>
              
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="pharmacyName">Pharmacy Name</label>
                  <input type="text" id="pharmacyName" class="form-input" x-model="pharmacySettings.name" placeholder="Enter pharmacy name">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyPhone">Phone Number</label>
                  <input type="tel" id="pharmacyPhone" class="form-input" x-model="pharmacySettings.phone" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyEmail">Email Address</label>
                  <input type="email" id="pharmacyEmail" class="form-input" x-model="pharmacySettings.email" placeholder="Enter email address">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyWebsite">Website</label>
                  <input type="url" id="pharmacyWebsite" class="form-input" x-model="pharmacySettings.website" placeholder="Enter website URL">
                </div>
                <div class="form-group full-width">
                  <label class="form-label" for="pharmacyAddress">Address</label>
                  <input type="text" id="pharmacyAddress" class="form-input" x-model="pharmacySettings.address" placeholder="Enter street address">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyCity">City</label>
                  <input type="text" id="pharmacyCity" class="form-input" x-model="pharmacySettings.city" placeholder="Enter city">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyProvince">Province</label>
                  <input type="text" id="pharmacyProvince" class="form-input" x-model="pharmacySettings.province" placeholder="Enter province">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pharmacyPostalCode">Postal Code</label>
                  <input type="text" id="pharmacyPostalCode" class="form-input" x-model="pharmacySettings.postalCode" placeholder="Enter postal code">
                </div>
              </div>

              <h3 class="section-title section-title-sub">Receipt Settings</h3>
              <p class="section-description">Configure how receipts and invoices appear across the system.</p>
              
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="receiptHeader">Receipt Header</label>
                  <input type="text" id="receiptHeader" class="form-input" x-model="pharmacySettings.receiptHeader" placeholder="Enter receipt header text">
                </div>
                <div class="form-group">
                  <label class="form-label" for="receiptFooter">Receipt Footer</label>
                  <input type="text" id="receiptFooter" class="form-input" x-model="pharmacySettings.receiptFooter" placeholder="Enter receipt footer text">
                </div>
                <div class="form-group">
                  <label class="form-label" for="taxRate">Tax Rate (%)</label>
                  <input type="number" id="taxRate" class="form-input" x-model="pharmacySettings.taxRate" min="0" max="100" step="0.1" placeholder="Enter tax rate">
                </div>
                <div class="form-group">
                  <label class="form-label" for="currency">Currency</label>
                  <input type="text" id="currency" class="form-input" x-model="pharmacySettings.currency" maxlength="3" placeholder="e.g., ZMW">
                </div>
              </div>

              <h3 class="section-title section-title-sub">Report Settings</h3>
              <p class="section-description">Configure report generation settings.</p>
              
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="reportSignature">Report Signature</label>
                  <input type="text" id="reportSignature" class="form-input" x-model="pharmacySettings.reportSignature" placeholder="Enter signature title">
                </div>
                <div class="form-group">
                  <label class="form-label" for="invoicePrefix">Invoice Prefix</label>
                  <input type="text" id="invoicePrefix" class="form-input" x-model="pharmacySettings.invoicePrefix" maxlength="10" placeholder="e.g., INV">
                </div>
                <div class="form-group">
                  <label class="form-label" for="receiptPrefix">Receipt Prefix</label>
                  <input type="text" id="receiptPrefix" class="form-input" x-model="pharmacySettings.receiptPrefix" maxlength="10" placeholder="e.g., RCP">
                </div>
                <div class="form-group">
                  <label class="form-label" for="paymentTerms">Payment Terms</label>
                  <input type="text" id="paymentTerms" class="form-input" x-model="pharmacySettings.paymentTerms" placeholder="Enter payment terms">
                </div>
              </div>

              <div class="button-group">
                <button class="btn btn-secondary">Cancel</button>
                <button class="btn btn-primary" @click="savePharmacySettings">
                  <span class="material-symbols-rounded">save</span>
                  <span>Save Settings</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Billing Section -->
          <div x-show="activeSection === 'billing'">
            <div class="settings-section">
              <h2 class="section-title">Billing & Subscription</h2>
              <p class="section-description">Manage your subscription plan and payment methods.</p>
              
              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Current Plan</div>
                  <div class="security-description" x-text="subscription.planType + ' Plan' + (subscription.isTrial ? ' - Trial' : '')"></div>
                  <div class="security-description" x-show="subscription.isTrial && subscription.trialDaysRemaining > 0" x-text="subscription.trialDaysRemaining + ' days remaining in trial'"></div>
                </div>
                <span class="security-status" :class="subscription.status.toLowerCase()" x-text="subscription.status"></span>
              </div>

              <div class="security-item" x-show="subscription.isTrial">
                <div class="security-info">
                  <div class="security-title">Trial Period</div>
                  <div class="security-description" x-text="'Started: ' + formatDate(subscription.trialStart) + ' | Ends: ' + formatDate(subscription.trialEnd)"></div>
                </div>
                <button class="btn btn-primary" @click="showUpgradeModal = true" x-show="subscription.isTrial">
                  <span class="material-symbols-rounded">upgrade</span>
                  Upgrade Now
                </button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Next Billing Date</div>
                  <div class="security-description" x-text="formatDate(subscription.nextBilling)"></div>
                </div>
                <button class="btn btn-secondary" @click="showInvoicesModal = true">View Invoices</button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Usage Statistics</div>
                  <div class="security-description" x-text="'Current month: ' + usageStats.currentMonthUsage + ' transactions'"></div>
                </div>
                <button class="btn btn-secondary" @click="showUsageModal = true">View Details</button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Subscription Management</div>
                  <div class="security-description">Cancel your subscription and account access</div>
                </div>
                <button class="btn btn-danger" @click="showCancelConfirmModal = true">Cancel Subscription</button>
              </div>

              <div class="security-item">
                <div class="security-info">
                  <div class="security-title">Available Plans</div>
                  <div class="plan-options">
                    <div class="plan-option" :class="{ selected: subscription.planType === 'Care' }" @click="upgradePlan('Care')">
                      <div class="plan-name">Care</div>
                      <div class="plan-features">1 Branch, 6 Users, Basic Features</div>
                    </div>
                    <div class="plan-option" :class="{ selected: subscription.planType === 'Care Plus' }" @click="upgradePlan('Care Plus')">
                      <div class="plan-name">Care Plus</div>
                      <div class="plan-features">3 Branches, 16 Users, Advanced Features</div>
                    </div>
                    <div class="plan-option" :class="{ selected: subscription.planType === 'Care Pro' }" @click="upgradePlan('Care Pro')">
                      <div class="plan-name">Care Pro</div>
                      <div class="plan-features">10 Branches, 50+ Users, Premium Features</div>
                    </div>
                  </div>
                </div>
                <button class="btn btn-primary" @click="showUpgradeModal = true" x-show="subscription.planType !== 'Care Pro'">
                  <span class="material-symbols-rounded">upgrade</span>
                  Upgrade Plan
                </button>
            </div>
          </div>

          <!-- Upgrade Modal -->
          <div class="modal-overlay" :class="{ 'show': showUpgradeModal }" @click="showUpgradeModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Upgrade Subscription</h3>
                <p class="modal-subtitle">Choose the perfect plan for your pharmacy needs</p>
              </div>
              
              <div class="modal-body">
                <div class="upgrade-plans">
                  <div class="plan-card" :class="{ selected: selectedUpgradePlan === 'Care' && subscription.planType !== 'Care' }" @click="selectUpgradePlan('Care')">
                    <div class="plan-name">Care</div>
                    <div class="plan-features">1 Branch, 6 Users, Basic Features</div>
                  </div>
                  
                  <div class="plan-card" :class="{ selected: selectedUpgradePlan === 'Care Plus' && subscription.planType !== 'Care Plus' }" @click="selectUpgradePlan('Care Plus')">
                    <div class="plan-name">Care Plus</div>
                    <div class="plan-features">3 Branches, 16 Users, Advanced Features</div>
                  </div>
                  
                  <div class="plan-card" :class="{ selected: selectedUpgradePlan === 'Care Pro' && subscription.planType !== 'Care Pro' }" @click="selectUpgradePlan('Care Pro')">
                    <div class="plan-name">Care Pro</div>
                    <div class="plan-features">10 Branches, 50+ Users, Premium Features</div>
                  </div>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="cancelUpgrade()">Cancel</button>
                <button class="btn btn-primary" @click="confirmUpgrade()" :disabled="!selectedUpgradePlan || selectedUpgradePlan === subscription.planType || upgradeRequestPending">
                  <span class="material-symbols-rounded" x-show="!upgradeRequestPending">upgrade</span>
                  <span class="material-symbols-rounded" x-show="upgradeRequestPending" style="animation: spin 1s linear infinite;">refresh</span>
                  <span x-show="!upgradeRequestPending">Confirm Upgrade to <span x-text="selectedUpgradePlan"></span></span>
                  <span x-show="upgradeRequestPending">Processing...</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Invoices Modal -->
          <div class="modal-overlay" :class="{ 'show': showInvoicesModal }" @click="showInvoicesModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Billing Invoices</h3>
                <p class="modal-subtitle">View and download your billing history</p>
              </div>
              
              <div class="modal-body">
                <div class="invoices-list">
                  <template x-for="invoice in invoices" :key="invoice.id">
                    <div class="invoice-item">
                      <div class="invoice-info">
                        <div>
                          <div class="invoice-number" x-text="'Invoice #' + invoice.number"></div>
                          <div class="invoice-description" x-text="invoice.description || 'Monthly subscription fee'"></div>
                        </div>
                        <div class="invoice-details">
                          <div class="invoice-date" x-text="formatDate(invoice.date)"></div>
                          <div class="invoice-amount" x-text="'ZMW ' + invoice.amount"></div>
                        </div>
                      </div>
                      <div class="invoice-status" :class="invoice.status.toLowerCase()" x-text="invoice.status"></div>
                      <div class="invoice-actions">
                        <button class="btn btn-secondary btn-sm" @click="downloadInvoice(invoice.id)">
                          <span class="material-symbols-rounded">download</span>
                          Download
                        </button>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="showInvoicesModal = false">Close</button>
              </div>
            </div>
          </div>

          <!-- Usage Statistics Modal -->
          <div class="modal-overlay" :class="{ 'show': showUsageModal }" @click="showUsageModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Usage Statistics</h3>
                <p class="modal-subtitle">Your account usage and activity metrics</p>
              </div>
              
              <div class="modal-body">
                <div class="usage-stats-grid">
                  <div class="stat-card">
                    <div class="stat-icon">
                      <span class="material-symbols-rounded">shopping_cart</span>
                    </div>
                    <div class="stat-info">
                      <div class="stat-value" x-text="usageStats.currentMonthUsage"></div>
                      <div class="stat-label">Current Month Transactions</div>
                    </div>
                  </div>
                  
                  <div class="stat-card">
                    <div class="stat-icon">
                      <span class="material-symbols-rounded">medication</span>
                    </div>
                    <div class="stat-info">
                      <div class="stat-value" x-text="usageStats.totalPrescriptions"></div>
                      <div class="stat-label">Total Prescriptions</div>
                    </div>
                  </div>
                  
                  <div class="stat-card">
                    <div class="stat-icon">
                      <span class="material-symbols-rounded">inventory</span>
                    </div>
                    <div class="stat-info">
                      <div class="stat-value" x-text="usageStats.inventoryItems"></div>
                      <div class="stat-label">Inventory Items</div>
                    </div>
                  </div>
                  
                  <div class="stat-card">
                    <div class="stat-icon">
                      <span class="material-symbols-rounded">people</span>
                    </div>
                    <div class="stat-info">
                      <div class="stat-value" x-text="usageStats.activeUsers"></div>
                      <div class="stat-label">Active Users</div>
                    </div>
                  </div>
                </div>
                
                <div class="usage-chart">
                  <h4>Monthly Activity</h4>
                  <div class="chart-placeholder">
                    <p>Chart showing monthly transaction trends</p>
                  </div>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="showUsageModal = false">Close</button>
              </div>
            </div>
          </div>

          <!-- Cancel Subscription Confirmation Modal -->
          <div class="modal-overlay" :class="{ 'show': showCancelConfirmModal }" @click="showCancelConfirmModal = false">
            <div class="modal" @click.stop>
              <div class="modal-header">
                <h3 class="modal-title">Cancel Subscription</h3>
                <p class="modal-subtitle">This action will permanently cancel your subscription</p>
              </div>
              
              <div class="modal-body">
                <div class="warning-box">
                  <div class="warning-icon">
                    <span class="material-symbols-rounded">warning</span>
                  </div>
                  <div class="warning-content">
                    <h4>Important Notice</h4>
                    <ul>
                      <li>Your account will become read-only immediately</li>
                      <li>You will be automatically logged out in 5 minutes</li>
                      <li>Data access will be limited to viewing only</li>
                      <li>Account reactivation requires admin approval</li>
                    </ul>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="cancelReason">Reason for cancellation</label>
                  <textarea id="cancelReason" class="form-input" x-model="cancelForm.reason" placeholder="Please tell us why you're cancelling..."></textarea>
                </div>
                
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" x-model="cancelForm.confirmTerms">
                    <span class="checkmark"></span>
                    I understand that this action cannot be undone and my account will become read-only
                  </label>
                </div>
              </div>
              
              <div class="modal-footer">
                <button class="btn btn-secondary" @click="showCancelConfirmModal = false">Keep Subscription</button>
                <button class="btn btn-danger" @click="confirmCancelSubscription()" :disabled="!cancelForm.confirmTerms">
                  <span class="material-symbols-rounded">cancel</span>
                  Cancel Subscription
                </button>
              </div>
            </div>
          </div>

          <!-- Upgrade Modal Styles -->
          <style>
            .modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              display: none;
              align-items: center;
              justify-content: center;
              z-index: 9999;
              opacity: 0;
              transition: opacity 0.3s ease;
            }
            
            .modal-overlay.show {
              display: flex;
              opacity: 1;
            }
            
            .modal {
              background: white;
              border-radius: 12px;
              padding: 24px;
              max-width: 600px;
              width: 90%;
              box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }
            
            .modal-header {
              text-align: center;
              margin-bottom: 20px;
            }
            
            .modal-title {
              margin: 0 0 8px 0;
              color: #dc2626;
            }
            
            .modal-subtitle {
              color: #6b7280;
              margin-bottom: 20px;
            }
            
            .modal-body {
              margin-bottom: 20px;
            }
            
            .upgrade-plans {
              display: grid;
              grid-template-columns: 1fr;
              gap: 16px;
              margin-bottom: 20px;
            }
            
            .plan-card {
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              padding: 16px;
              cursor: pointer;
              transition: all 0.2s ease;
            }
            
            .plan-card:hover {
              border-color: #2563eb;
              transform: translateY(-2px);
            }
            
            .plan-card.selected {
              border-color: #2563eb;
              background: #eff6ff;
            }
            
            .plan-name {
              font-weight: 600;
              margin-bottom: 4px;
            }
            
            .plan-price {
              font-size: 1.25rem;
              font-weight: 700;
              color: #2563eb;
              margin-bottom: 4px;
            }
            
            .plan-features {
              font-size: 0.875rem;
              color: #6b7280;
            }
            
            .modal-footer {
              display: flex;
              gap: 12px;
              justify-content: flex-end;
            }
            
            @keyframes spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
            
            /* Password Modal Styles */
            .password-requirements {
              margin-top: 0.5rem;
            }
            
            .text-success {
              color: #22c55e;
            }
            
            .text-muted {
              color: #6b7280;
            }
            
            .field-error {
              color: #ef4444;
              font-size: 0.75rem;
              margin-top: 0.25rem;
            }
            
            /* Sessions Modal Styles */
            .sessions-list {
              max-height: 300px;
              overflow-y: auto;
              margin-bottom: 1rem;
            }
            
            .session-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 1rem;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              margin-bottom: 0.5rem;
            }
            
            .session-info {
              flex: 1;
            }
            
            .session-device {
              font-weight: 600;
              margin-bottom: 0.25rem;
            }
            
            .session-details {
              font-size: 0.875rem;
              color: #6b7280;
            }
            
            .session-actions {
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            
            .session-status {
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              font-size: 0.75rem;
              font-weight: 600;
            }
            
            .session-status.current {
              background: #dcfce7;
              color: #166534;
            }
            
            .btn-sm {
              padding: 0.5rem 0.75rem;
              font-size: 0.75rem;
            }
            
            .sessions-footer {
              padding-top: 1rem;
              border-top: 1px solid #e5e7eb;
            }
            
            /* Invoices Modal Styles */
            .invoices-list {
              max-height: 400px;
              overflow-y: auto;
            }
            
            .invoice-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 1rem;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              margin-bottom: 0.5rem;
            }
            
            .invoice-info {
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              flex: 1;
            }
            
            .invoice-number {
              font-weight: 600;
              font-size: 0.95rem;
            }
            
            .invoice-description {
              font-size: 0.8rem;
              color: #6b7280;
              margin-top: 0.25rem;
            }
            
            .invoice-details {
              text-align: right;
            }
            
            .invoice-date {
              color: #6b7280;
              font-size: 0.875rem;
            }
            
            .invoice-amount {
              font-weight: 600;
              color: #059669;
              font-size: 0.95rem;
            }
            
            .invoice-status {
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              font-size: 0.75rem;
              font-weight: 600;
            }
            
            .invoice-status.paid {
              background: #dcfce7;
              color: #166534;
            }
            
            .invoice-status.pending {
              background: #fef3c7;
              color: #92400e;
            }
            
            /* Usage Statistics Modal Styles */
            .usage-stats-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 1rem;
              margin-bottom: 2rem;
            }
            
            .stat-card {
              display: flex;
              align-items: center;
              gap: 1rem;
              padding: 1rem;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
            }
            
            .stat-icon {
              width: 48px;
              height: 48px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: #f3f4f6;
              border-radius: 8px;
            }
            
            .stat-icon .material-symbols-rounded {
              font-size: 24px;
              color: #6b7280;
            }
            
            .stat-value {
              font-size: 1.5rem;
              font-weight: 700;
              color: #111827;
            }
            
            .stat-label {
              font-size: 0.875rem;
              color: #6b7280;
            }
            
            .usage-chart {
              padding: 1rem;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
            }
            
            .chart-placeholder {
              height: 200px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: #f9fafb;
              border-radius: 4px;
              color: #6b7280;
            }
            
            /* Cancellation Modal Styles */
            .warning-box {
              display: flex;
              gap: 1rem;
              padding: 1rem;
              background: #fef2f2;
              border: 1px solid #fecaca;
              border-radius: 8px;
              margin-bottom: 1.5rem;
            }
            
            .warning-icon {
              color: #dc2626;
            }
            
            .warning-icon .material-symbols-rounded {
              font-size: 24px;
            }
            
            .warning-content h4 {
              color: #dc2626;
              margin-bottom: 0.5rem;
            }
            
            .warning-content ul {
              margin: 0;
              padding-left: 1.5rem;
            }
            
            .warning-content li {
              margin-bottom: 0.25rem;
              color: #7f1d1d;
            }
            
            .checkbox-label {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              cursor: pointer;
            }
            
            .checkbox-label input[type="checkbox"] {
              width: auto;
            }
            
            /* Two-Factor Authentication Modal Styles */
            .two-factor-intro h4 {
              margin-bottom: 1rem;
              color: #374151;
            }
            
            .two-factor-methods {
              display: flex;
              flex-direction: column;
              gap: 0.75rem;
              margin-bottom: 1rem;
            }
            
            .method-card {
              display: flex;
              align-items: center;
              padding: 1rem;
              border: 2px solid #e5e7eb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.2s ease;
            }
            
            .method-card:hover {
              border-color: #d1d5db;
              background: #f9fafb;
            }
            
            .method-card.selected {
              border-color: #3b82f6;
              background: #eff6ff;
            }
            
            .method-icon {
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
              background: #f3f4f6;
              border-radius: 8px;
              margin-right: 1rem;
            }
            
            .method-card.selected .method-icon {
              background: #dbeafe;
              color: #3b82f6;
            }
            
            .method-info {
              flex: 1;
            }
            
            .method-name {
              font-weight: 600;
              color: #374151;
              margin-bottom: 0.25rem;
            }
            
            .method-description {
              font-size: 0.875rem;
              color: #6b7280;
            }
            
            .qr-code-placeholder {
              display: flex;
              justify-content: center;
              margin: 1.5rem 0;
            }
            
            .qr-code {
              width: 200px;
              height: 200px;
              border: 2px dashed #d1d5db;
              border-radius: 8px;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              color: #6b7280;
            }
            
            .qr-code .material-symbols-rounded {
              font-size: 48px;
              margin-bottom: 0.5rem;
            }
            
            .two-factor-complete {
              text-align: center;
            }
            
            .success-icon {
              color: #22c55e;
              font-size: 48px;
              margin-bottom: 1rem;
            }
            
            .backup-codes {
              margin-top: 2rem;
              text-align: left;
            }
            
            .backup-codes h5 {
              margin-bottom: 0.5rem;
              color: #374151;
            }
            
            .backup-codes p {
              color: #6b7280;
              font-size: 0.875rem;
              margin-bottom: 1rem;
            }
            
            .backup-codes-list {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 0.5rem;
              margin-bottom: 1rem;
            }
            
            .backup-code {
              padding: 0.5rem;
              background: #f3f4f6;
              border: 1px solid #e5e7eb;
              border-radius: 4px;
              font-family: monospace;
              font-size: 0.875rem;
              text-align: center;
            }
            
            .two-factor-btn {
              margin-left: 8px;
            }
          </style>
        </div>
      </div>
    </div>

    <!-- Alpine.js Component -->
    <script>
      function accountSystem() {
        return {
          sidebarOpen: false,
          activeSection: localStorage.getItem('umi_active_tab') || 'profile',
          pharmacyInfo: {
            name: '',
            location: ''
          },
          subscription: {
            planType: '',
            status: '',
            nextBilling: null,
            trialStart: null,
            trialEnd: null,
            isTrial: false,
            trialDaysRemaining: 0,
            accountCreated: null,
            lastBillingDate: null
          },
          showUpgradeModal: false,
          selectedUpgradePlan: null,
          upgradeRequestPending: false,
          searchQuery: '',
          searchOpen: false,
          // Password modal data
          showPasswordModal: false,
          passwordForm: {
            currentPassword: '',
            newPassword: '',
            confirmPassword: ''
          },
          passwordRequirements: {
            hasMinLength: false,
            hasLetter: false,
            hasNumber: false
          },
          passwordInfo: {
            lastChanged: null
          },
          // Sessions modal data
          showSessionsModal: false,
          activeSessions: [],
          // Invoices modal data
          showInvoicesModal: false,
          invoices: [],
          // Usage statistics modal data
          showUsageModal: false,
          usageStats: {
            currentMonthUsage: 0,
            totalPrescriptions: 0,
            inventoryItems: 0,
            activeUsers: 0
          },
          // Two-Factor Authentication data
          twoFactorEnabled: false,
          showTwoFactorModal: false,
          twoFactorSetup: {
            step: 'intro', // intro, setup, verify, complete
            method: 'app', // app, sms, email
            phoneNumber: '',
            backupCodes: [],
            verificationCode: '',
            qrCode: null
          },
          // Cancellation modal data
          showCancelConfirmModal: false,
          cancelForm: {
            reason: '',
            confirmTerms: false
          },
          readOnlyMode: false,
          suggestions: [
            { id: 'profile', title: 'Profile Settings', description: 'Update your personal information', icon: 'person', type: 'settings' },
            { id: 'security', title: 'Security Settings', description: 'Manage password and security', icon: 'security', type: 'settings' },
            { id: 'notifications', title: 'Notifications', description: 'Configure notification preferences', icon: 'notifications', type: 'settings' },
            { id: 'pharmacy', title: 'Pharmacy Settings', description: 'Update pharmacy information', icon: 'business', type: 'settings' },
            { id: 'billing', title: 'Billing & Subscription', description: 'Manage subscription and payments', icon: 'payments', type: 'settings' }
          ],
          userInfo: {
            name: '',
            role: '',
            initials: '',
            email: ''
          },
          profile: {
            firstName: '',
            lastName: '',
            email: '',
            phone: '',
            bio: ''
          },
          notifications: {
            email: true,
            push: false,
            sales: true,
            inventory: true,
            prescriptions: true
          },
          pharmacySettings: {
            name: '',
            phone: '',
            email: '',
            website: '',
            address: '',
            city: '',
            province: '',
            postalCode: '',
            // Receipt settings
            receiptHeader: '',
            receiptFooter: '',
            taxRate: 0,
            currency: '',
            // Report settings
            reportLogo: '',
            reportSignature: '',
            // Payment settings
            paymentTerms: '',
            invoicePrefix: '',
            receiptPrefix: ''
          },
          
          // Data sync and API integration
          loading: false,
          
          init() {
            this.checkReadOnlyMode();
            this.initializeAccountCreation();
            this.loadAccountFromAPI();
            this.loadInvoices();
            this.loadUsageStats();
            this.setupEventListeners();
          },
          
          loadAccountFromAPI() {
            this.loading = true;
            
            // First try to load from localStorage (registration data)
            this.loadFromLocalStorage();
            
            // Then try to load from data sync if available
            if (!window.adminDataSync) {
              console.warn('Data sync not available, using localStorage/default values');
              this.loading = false;
              return;
            }
            
            try {
              // Load user profile from data sync (will override localStorage if available)
              window.adminDataSync.getData('userProfile', {})
              .then(profile => {
                this.profile = {
                  firstName: profile.firstName || this.profile.firstName,
                  lastName: profile.lastName || this.profile.lastName,
                  email: profile.email || this.profile.email,
                  phone: profile.phone || this.profile.phone,
                  bio: profile.bio || this.profile.bio
                };
                
                this.userInfo = {
                  name: `${profile.firstName || this.profile.firstName} ${profile.lastName || this.profile.lastName}`,
                  role: profile.role || 'Admin',
                  initials: `${(profile.firstName || this.profile.firstName)?.[0] || 'U'}${(profile.lastName || this.profile.lastName)?.[0] || 'H'}`,
                  email: profile.email || this.profile.email
                };
              })
              .catch(error => {
                console.error('Error loading user profile from data sync:', error);
                // Keep localStorage values if data sync fails
              });
            
              // Load pharmacy settings from data sync (will override localStorage if available)
              window.adminDataSync.getData('pharmacySettings', {})
              .then(settings => {
                this.pharmacySettings = {
                  name: settings.name || this.pharmacySettings.name,
                  phone: settings.phone || this.pharmacySettings.phone,
                  email: settings.email || this.pharmacySettings.email,
                  website: settings.website || this.pharmacySettings.website,
                  address: settings.address || this.pharmacySettings.address,
                  city: settings.city || this.pharmacySettings.city,
                  province: settings.province || this.pharmacySettings.province,
                  postalCode: settings.postalCode || this.pharmacySettings.postalCode,
                  receiptHeader: settings.receiptHeader || this.pharmacySettings.receiptHeader,
                  receiptFooter: settings.receiptFooter || this.pharmacySettings.receiptFooter,
                  taxRate: settings.taxRate || this.pharmacySettings.taxRate,
                  currency: settings.currency || this.pharmacySettings.currency,
                  reportLogo: settings.reportLogo || this.pharmacySettings.reportLogo,
                  reportSignature: settings.reportSignature || this.pharmacySettings.reportSignature,
                  paymentTerms: settings.paymentTerms || this.pharmacySettings.paymentTerms,
                  invoicePrefix: settings.invoicePrefix || this.pharmacySettings.invoicePrefix,
                  receiptPrefix: settings.receiptPrefix || this.pharmacySettings.receiptPrefix
                };
                
                this.pharmacyInfo = {
                  name: settings.name || this.pharmacyInfo.name,
                  location: `${settings.city || this.pharmacySettings.city}, ${settings.province || this.pharmacySettings.province}`
                };
              })
              .catch(error => {
                console.error('Error loading pharmacy settings from data sync:', error);
                // Keep localStorage values if data sync fails
              });
            
            // Load notification settings from data sync
            window.adminDataSync.getData('notificationSettings', {})
            .then(notifications => {
              this.notifications = {
                email: notifications.email !== false,
                push: notifications.push || false,
                sales: notifications.sales !== false,
                inventory: notifications.inventory !== false,
                prescriptions: notifications.prescriptions !== false
              };
            })
            .catch(error => {
              console.error('Error loading notification settings from data sync:', error);
              // Keep default values if data sync fails
            });
            } catch (error) {
              console.error('Data sync not available:', error);
              this.showError('Data sync services are not available. Using locally stored data.');
            }
            
            this.loading = false;
          },
          
          loadFromLocalStorage() {
            try {
              // Load user data from localStorage
              const currentUser = localStorage.getItem('umi_current_user');
              const userProfile = localStorage.getItem('umi_user_profile');
              const currentTenant = localStorage.getItem('umi_current_tenant');
              const currentSubscription = localStorage.getItem('umi_current_subscription');
              const notificationSettings = localStorage.getItem('umi_notification_settings');
              
              if (currentUser) {
                const user = JSON.parse(currentUser);
                // Split name into first and last name
                const nameParts = user.name ? user.name.split(' ') : ['', ''];
                
                // Load from complete profile if available, otherwise use basic user data
                let profileData = {
                  firstName: nameParts[0] || '',
                  lastName: nameParts.slice(1).join(' ') || '',
                  email: user.email || '',
                  phone: user.phone || '',
                  bio: user.bio || ''
                };
                
                // Override with complete profile data if available
                if (userProfile) {
                  const completeProfile = JSON.parse(userProfile);
                  profileData = { ...profileData, ...completeProfile };
                }
                
                this.profile = profileData;
                
                this.userInfo = {
                  name: user.name || `${profileData.firstName} ${profileData.lastName}`,
                  role: user.role || 'Admin',
                  initials: nameParts.map(part => part[0]).join('').toUpperCase() || 'UH',
                  email: user.email || profileData.email
                };
              }
              
              if (currentTenant) {
                const tenant = JSON.parse(currentTenant);
                
                // Load complete pharmacy settings if available
                const pharmacySettings = localStorage.getItem('umi_pharmacy_settings');
                let completeSettings = {};
                
                if (pharmacySettings) {
                  try {
                    completeSettings = JSON.parse(pharmacySettings);
                  } catch (e) {
                    console.warn('Failed to parse pharmacy settings:', e);
                  }
                }
                
                this.pharmacySettings = {
                  name: completeSettings.name || tenant.name || '',
                  phone: completeSettings.phone || tenant.phone || '',
                  email: completeSettings.email || tenant.email || '',
                  website: completeSettings.website || '',
                  address: completeSettings.address || tenant.address || '',
                  city: completeSettings.city || tenant.city || '',
                  province: completeSettings.province || tenant.province || '',
                  postalCode: completeSettings.postalCode || tenant.postalCode || '',
                  receiptHeader: completeSettings.receiptHeader || tenant.name || 'Umi Health Pharmacy',
                  receiptFooter: completeSettings.receiptFooter || 'Thank you for your business!',
                  taxRate: completeSettings.taxRate || 16,
                  currency: completeSettings.currency || 'ZMW',
                  reportLogo: completeSettings.reportLogo || '',
                  reportSignature: completeSettings.reportSignature || 'Pharmacy Manager',
                  paymentTerms: completeSettings.paymentTerms || 'Payment due upon receipt',
                  invoicePrefix: completeSettings.invoicePrefix || 'INV',
                  receiptPrefix: completeSettings.receiptPrefix || 'RCP'
                };
                
                this.pharmacyInfo = {
                  name: this.pharmacySettings.name,
                  location: `${this.pharmacySettings.city || 'Lusaka'}, ${this.pharmacySettings.province || 'Zambia'}`
                };
              }
              
              if (currentSubscription) {
                const subscription = JSON.parse(currentSubscription);
                this.subscription = {
                  planType: subscription.plan || 'Care',
                  status: subscription.status || 'Active',
                  nextBilling: subscription.nextBilling || this.calculateNextBilling(subscription.accountCreated, subscription.trialStart, subscription.isTrial),
                  trialStart: subscription.trialStart || null,
                  trialEnd: subscription.trialEnd || null,
                  isTrial: subscription.isTrial || false,
                  trialDaysRemaining: subscription.trialDaysRemaining || 0,
                  accountCreated: subscription.accountCreated || null,
                  lastBillingDate: subscription.lastBillingDate || null
                };
                
                // Check trial status
                this.checkTrialStatus();
                
                // Update next billing if needed
                this.updateNextBilling();
              }
              
              if (notificationSettings) {
                this.notifications = JSON.parse(notificationSettings);
              }
              
              // Load password info
              const passwordLastChanged = localStorage.getItem('umi_password_last_changed');
              if (passwordLastChanged) {
                this.passwordInfo.lastChanged = new Date(passwordLastChanged).toLocaleDateString();
              }
              
              // Load two-factor authentication settings
              const twoFactorEnabled = localStorage.getItem('umi_two_factor_enabled');
              if (twoFactorEnabled === 'true') {
                this.twoFactorEnabled = true;
                const twoFactorMethod = localStorage.getItem('umi_two_factor_method') || 'app';
                const backupCodes = localStorage.getItem('umi_two_factor_backup_codes');
                
                this.twoFactorSetup.method = twoFactorMethod;
                if (backupCodes) {
                  try {
                    this.twoFactorSetup.backupCodes = JSON.parse(backupCodes);
                  } catch (e) {
                    console.warn('Failed to parse backup codes:', e);
                  }
                }
              }
              
              console.log('Loaded data from localStorage successfully');
            } catch (error) {
              console.error('Error loading data from localStorage:', error);
              this.showError('Failed to load saved data. Using default values.');
            }
          },
          
          setupEventListeners() {
            // Add any event listeners here
            this.loadActiveSessions();
          },
          
          // Tab navigation functions
          switchTab(tabName) {
            this.activeSection = tabName;
            localStorage.setItem('umi_active_tab', tabName);
          },
          
          // Password functions
          isPasswordFormValid() {
            return this.passwordForm.currentPassword &&
                   this.passwordForm.newPassword &&
                   this.passwordForm.confirmPassword &&
                   this.passwordForm.newPassword === this.passwordForm.confirmPassword &&
                   this.passwordRequirements.hasMinLength &&
                   this.passwordRequirements.hasLetter &&
                   this.passwordRequirements.hasNumber;
          },
          
          validatePassword() {
            const password = this.passwordForm.newPassword;
            this.passwordRequirements.hasMinLength = password.length >= 8;
            this.passwordRequirements.hasLetter = /[a-zA-Z]/.test(password);
            this.passwordRequirements.hasNumber = /[0-9]/.test(password);
          },
          
          async changePassword() {
            if (!this.isPasswordFormValid()) {
              this.showError('Please fill in all password requirements');
              return;
            }
            
            try {
              // Show loading state
              const changeButton = document.querySelector('.modal-footer .btn-primary');
              const originalButtonText = changeButton.innerHTML;
              changeButton.innerHTML = '<span class="material-symbols-rounded" style="animation: spin 1s linear infinite;">refresh</span> Changing...';
              changeButton.disabled = true;
              
              if (!window.adminAPI) {
                // Fallback to localStorage only
                this.showError('API services are not available. Password change simulated locally only.');
                this.cancelPasswordChange();
                this.passwordInfo.lastChanged = new Date().toLocaleDateString();
                localStorage.setItem('umi_password_last_changed', new Date().toISOString());
                return;
              }
              
              const response = await window.adminAPI.changePassword({
                currentPassword: this.passwordForm.currentPassword,
                newPassword: this.passwordForm.newPassword,
                confirmPassword: this.passwordForm.confirmPassword
              });
              
              if (response && response.success) {
                this.showSuccess('Password changed successfully and updated across all sessions');
                this.cancelPasswordChange();
                this.passwordInfo.lastChanged = new Date().toLocaleDateString();
                
                // Save to localStorage
                localStorage.setItem('umi_password_last_changed', new Date().toISOString());
                
                // Broadcast security update
                this.broadcastSecurityUpdate('password_changed');
                
                // Optionally revoke all other sessions for security
                if (response.revokeOtherSessions) {
                  await this.revokeAllOtherSessions();
                }
              } else {
                this.showError('Password change failed: ' + (response?.message || 'Unknown error occurred'));
              }
            } catch (error) {
              console.error('Password change error:', error);
              if (error.message.includes('401')) {
                this.showError('Current password is incorrect. Please try again.');
              } else if (error.message.includes('400')) {
                this.showError('Invalid password format. Please ensure it meets all requirements.');
              } else if (error.message.includes('403')) {
                this.showError('Access denied. You do not have permission to change password.');
              } else {
                this.showError('Password change failed. Please check your connection and try again.');
              }
            } finally {
              // Restore button state
              const changeButton = document.querySelector('.modal-footer .btn-primary');
              if (changeButton) {
                changeButton.innerHTML = originalButtonText;
                changeButton.disabled = false;
              }
            }
          },
          
          cancelPasswordChange() {
            this.showPasswordModal = false;
            this.passwordForm = {
              currentPassword: '',
              newPassword: '',
              confirmPassword: ''
            };
            this.passwordRequirements = {
              hasMinLength: false,
              hasLetter: false,
              hasNumber: false
            };
          },
          
          // Two-Factor Authentication functions
          nextTwoFactorStep() {
            if (this.twoFactorSetup.step === 'intro') {
              // Validate method selection
              if (this.twoFactorSetup.method === 'sms' && !this.twoFactorSetup.phoneNumber) {
                this.showError('Please enter your phone number');
                return;
              }
              this.twoFactorSetup.step = 'setup';
              this.sendVerificationCode();
            } else if (this.twoFactorSetup.step === 'setup') {
              // Validate verification code
              if (!this.twoFactorSetup.verificationCode || this.twoFactorSetup.verificationCode.length !== 6) {
                this.showError('Please enter a valid 6-digit verification code');
                return;
              }
              this.verifyTwoFactorCode();
            }
          },
          
          cancelTwoFactorSetup() {
            this.showTwoFactorModal = false;
            this.resetTwoFactorSetup();
          },
          
          resetTwoFactorSetup() {
            this.twoFactorSetup = {
              step: 'intro',
              method: 'app',
              phoneNumber: '',
              backupCodes: [],
              verificationCode: '',
              qrCode: null
            };
          },
          
          sendVerificationCode() {
            try {
              // Simulate sending verification code
              if (this.twoFactorSetup.method === 'sms') {
                console.log('Sending SMS code to:', this.twoFactorSetup.phoneNumber);
              } else if (this.twoFactorSetup.method === 'email') {
                console.log('Sending email code to:', this.userInfo.email);
              } else {
                console.log('Generating QR code for authenticator app');
              }
              
              this.showSuccess(`Verification code sent via ${this.twoFactorSetup.method === 'app' ? 'authenticator app' : this.twoFactorSetup.method}`);
            } catch (error) {
              console.error('Error sending verification code:', error);
              this.showError('Failed to send verification code. Please try again.');
            }
          },
          
          verifyTwoFactorCode() {
            try {
              // Simulate verification (in real app, this would call the API)
              if (this.twoFactorSetup.verificationCode === '123456' || this.twoFactorSetup.verificationCode.length === 6) {
                this.enableTwoFactorAuth();
              } else {
                this.showError('Invalid verification code. Please try again.');
              }
            } catch (error) {
              console.error('Error verifying code:', error);
              this.showError('Failed to verify code. Please try again.');
            }
          },
          
          enableTwoFactorAuth() {
            try {
              // Generate backup codes
              this.twoFactorSetup.backupCodes = this.generateBackupCodes();
              
              // Enable 2FA
              this.twoFactorEnabled = true;
              this.twoFactorSetup.step = 'complete';
              
              // Save to localStorage
              localStorage.setItem('umi_two_factor_enabled', 'true');
              localStorage.setItem('umi_two_factor_method', this.twoFactorSetup.method);
              localStorage.setItem('umi_two_factor_backup_codes', JSON.stringify(this.twoFactorSetup.backupCodes));
              
              this.showSuccess('Two-factor authentication enabled successfully!');
              
              // Broadcast security update
              this.broadcastSecurityUpdate('2fa_enabled', { method: this.twoFactorSetup.method });
            } catch (error) {
              console.error('Error enabling 2FA:', error);
              this.showError('Failed to enable two-factor authentication');
            }
          },
          
          disableTwoFactorAuth() {
            try {
              this.twoFactorEnabled = false;
              localStorage.removeItem('umi_two_factor_enabled');
              localStorage.removeItem('umi_two_factor_method');
              localStorage.removeItem('umi_two_factor_backup_codes');
              
              this.showSuccess('Two-factor authentication disabled');
              this.broadcastSecurityUpdate('2fa_disabled');
            } catch (error) {
              console.error('Error disabling 2FA:', error);
              this.showError('Failed to disable two-factor authentication');
            }
          },
          
          generateBackupCodes() {
            const codes = [];
            for (let i = 0; i < 10; i++) {
              codes.push(Math.random().toString(36).substring(2, 10).toUpperCase());
            }
            return codes;
          },
          
          downloadBackupCodes() {
            try {
              const codesText = `Two-Factor Authentication Backup Codes\n\n${this.twoFactorSetup.backupCodes.join('\n')}\n\nKeep these codes in a safe place. Each code can only be used once.\n\nGenerated: ${new Date().toLocaleString()}`;
              
              const blob = new Blob([codesText], { type: 'text/plain' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = '2fa-backup-codes.txt';
              a.click();
              window.URL.revokeObjectURL(url);
              
              this.showSuccess('Backup codes downloaded successfully');
            } catch (error) {
              console.error('Error downloading backup codes:', error);
              this.showError('Failed to download backup codes');
            }
          },
          
          // Sessions functions
          async loadActiveSessions() {
            try {
              // Try to load from API first
              if (window.adminAPI) {
                try {
                  const response = await window.adminAPI.getActiveSessions();
                  if (response && response.success && response.sessions) {
                    this.activeSessions = response.sessions.map(session => ({
                      ...session,
                      lastActive: this.formatSessionTime(session.lastActive),
                      device: session.device || session.userAgent || 'Unknown Device',
                      location: session.location || 'Unknown Location',
                      current: session.current || false
                    }));
                    this.saveSessionsToStorage();
                    return;
                  }
                } catch (apiError) {
                  console.warn('API sessions load failed, using localStorage:', apiError);
                }
              }
              
              // Fallback to localStorage
              const storedSessions = localStorage.getItem('umi_active_sessions');
              if (storedSessions) {
                this.activeSessions = JSON.parse(storedSessions);
              } else {
                // Create default current session
                this.activeSessions = [{
                  id: 'current_' + Date.now(),
                  device: this.getCurrentDeviceInfo(),
                  location: 'Lusaka, Zambia',
                  lastActive: 'Just now',
                  current: true,
                  ipAddress: '127.0.0.1',
                  userAgent: navigator.userAgent,
                  sessionId: this.generateSessionId()
                }];
                this.saveSessionsToStorage();
              }
            } catch (error) {
              console.error('Error loading sessions:', error);
              this.activeSessions = [];
              this.showError('Failed to load session information');
            }
          },
          
          async init() {
            this.loading = true;
            
            try {
              // Setup real-time listeners first
              this.setupRealtimeListeners();
              
              // Load data from localStorage first (for immediate display)
              this.loadFromLocalStorage();
              
              // Then try to sync with API/database
              await this.loadAccountFromAPI();
              
              // Load additional data
              await this.loadActiveSessions();
              this.loadInvoices();
              this.loadUsageStats();
              
              // Initialize subscription
              this.initializeAccountCreation();
              this.checkTrialStatus();
              this.checkReadOnlyMode();
              
            } catch (error) {
              console.error('Initialization error:', error);
              this.showError('Failed to load account data. Please refresh the page.');
            } finally {
              this.loading = false;
            }
          },
          
          generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          },
          
          formatSessionTime(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
          },
          
          saveSessionsToStorage() {
            try {
              localStorage.setItem('umi_active_sessions', JSON.stringify(this.activeSessions));
            } catch (error) {
              console.error('Error saving sessions:', error);
            }
          },
          
          async revokeSession(sessionId) {
            try {
              // Show loading state
              const revokeButton = event.target;
              const originalText = revokeButton.innerHTML;
              revokeButton.innerHTML = '<span class="material-symbols-rounded" style="animation: spin 1s linear infinite;">refresh</span> Revoking...';
              revokeButton.disabled = true;
              
              if (!window.adminAPI) {
                // Remove from localStorage only
                this.activeSessions = this.activeSessions.filter(s => s.id !== sessionId);
                this.saveSessionsToStorage();
                this.showSuccess('Session revoked successfully (local only)');
                return;
              }
              
              const response = await window.adminAPI.revokeSession(sessionId);
              if (response && response.success) {
                this.activeSessions = this.activeSessions.filter(s => s.id !== sessionId);
                this.saveSessionsToStorage();
                this.showSuccess('Session revoked successfully across all devices');
                
                // Broadcast session update
                this.broadcastSecurityUpdate('session_revoked', { sessionId });
              } else {
                this.showError('Failed to revoke session: ' + (response?.message || 'Unknown error'));
              }
            } catch (error) {
              console.error('Revoke session error:', error);
              this.showError('Failed to revoke session. Please try again.');
            } finally {
              // Restore button state if it still exists
              if (event.target) {
                event.target.innerHTML = originalText;
                event.target.disabled = false;
              }
            }
          },
          
          async revokeAllSessions() {
            try {
              if (!window.adminAPI) {
                // Keep only current session
                this.activeSessions = this.activeSessions.filter(s => s.current);
                this.saveSessionsToStorage();
                this.showSuccess('All other sessions revoked successfully (local only)');
                return;
              }
              
              const response = await window.adminAPI.revokeAllSessions();
              if (response && response.success) {
                this.activeSessions = this.activeSessions.filter(s => s.current);
                this.saveSessionsToStorage();
                this.showSuccess('All other sessions revoked successfully across all devices');
                
                // Broadcast security update
                this.broadcastSecurityUpdate('all_sessions_revoked');
              } else {
                this.showError('Failed to revoke sessions: ' + (response?.message || 'Unknown error'));
              }
            } catch (error) {
              console.error('Revoke all sessions error:', error);
              this.showError('Failed to revoke sessions. Please try again.');
            }
          },
          
          // Invoices functions
          loadInvoices() {
            try {
              // Load invoices from localStorage only
              const storedInvoices = localStorage.getItem('umi_invoices');
              if (storedInvoices) {
                this.invoices = JSON.parse(storedInvoices);
              } else {
                // Start with empty array - no fake data
                this.invoices = [];
                this.saveInvoicesToStorage();
              }
            } catch (error) {
              console.error('Error loading invoices:', error);
              this.invoices = [];
            }
          },
          
          saveInvoicesToStorage() {
            try {
              localStorage.setItem('umi_invoices', JSON.stringify(this.invoices));
            } catch (error) {
              console.error('Error saving invoices:', error);
            }
          },
          
          generateInvoiceNumber() {
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const invoicePrefix = this.pharmacySettings.invoicePrefix || 'INV';
            const existingInvoices = this.invoices.filter(inv => 
              inv.number.includes(`${invoicePrefix}-${year}${month}`)
            );
            const nextNumber = existingInvoices.length + 1;
            return `${invoicePrefix}-${year}${month}-${String(nextNumber).padStart(4, '0')}`;
          },
          
          createNewInvoice(description, amount) {
            const newInvoice = {
              id: 'inv_' + Date.now(),
              number: this.generateInvoiceNumber(),
              date: new Date().toISOString().split('T')[0],
              amount: amount.toFixed(2),
              status: 'pending',
              description: description
            };
            this.invoices.unshift(newInvoice);
            this.saveInvoicesToStorage();
            return newInvoice;
          },
          
          downloadInvoice(invoiceId) {
            try {
              const invoice = this.invoices.find(inv => inv.id === invoiceId);
              if (invoice) {
                // Generate PDF invoice
                this.generatePDFInvoice(invoice);
              }
            } catch (error) {
              console.error('Error downloading invoice:', error);
              this.showError('Failed to download invoice');
            }
          },
          
          generatePDFInvoice(invoice) {
            try {
              // Create PDF content using jsPDF library
              const { jsPDF } = window.jspdf;
              if (jsPDF) {
                const doc = new jsPDF();
                
                // Add header
                doc.setFontSize(20);
                doc.text('INVOICE', 105, 20, { align: 'center' });
                
                // Add invoice details
                doc.setFontSize(12);
                doc.text(`Invoice Number: ${invoice.number}`, 20, 40);
                doc.text(`Date: ${invoice.date}`, 20, 50);
                doc.text(`Amount: ZMW ${invoice.amount}`, 20, 60);
                doc.text(`Status: ${invoice.status.toUpperCase()}`, 20, 70);
                
                // Add description
                doc.setFontSize(11);
                doc.text(`Description: ${invoice.description || 'Monthly subscription fee'}`, 20, 85);
                
                // Add footer
                doc.setFontSize(10);
                doc.text('Thank you for your business!', 20, 110);
                doc.text('Umi Health Pharmacy', 20, 120);
                doc.text('Lusaka, Zambia', 20, 130);
                
                // Save the PDF
                doc.save(`invoice_${invoice.number}.pdf`);
                this.showSuccess('Invoice PDF downloaded successfully');
              } else {
                // Fallback to text file if jsPDF is not available
                const invoiceText = `
Invoice: ${invoice.number}
Date: ${invoice.date}
Amount: ZMW ${invoice.amount}
Status: ${invoice.status}
Description: ${invoice.description || 'Monthly subscription fee'}

Thank you for your business!
Umi Health Pharmacy
Lusaka, Zambia
                `.trim();
                
                const blob = new Blob([invoiceText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${invoice.number}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                this.showSuccess('Invoice downloaded as text file (PDF library not available)');
              }
            } catch (error) {
              console.error('Error generating PDF:', error);
              this.showError('Failed to generate PDF invoice');
            }
          },
          
          // Usage statistics functions
          loadUsageStats() {
            try {
              // Load usage stats from localStorage only
              const storedStats = localStorage.getItem('umi_usage_stats');
              if (storedStats) {
                this.usageStats = JSON.parse(storedStats);
              } else {
                // Start with zero values - no fake data
                this.usageStats = {
                  currentMonthUsage: 0,
                  totalPrescriptions: 0,
                  inventoryItems: 0,
                  activeUsers: 0
                };
                this.saveUsageStatsToStorage();
              }
            } catch (error) {
              console.error('Error loading usage stats:', error);
              this.usageStats = {
                currentMonthUsage: 0,
                totalPrescriptions: 0,
                inventoryItems: 0,
                activeUsers: 0
              };
            }
          },
          
          saveUsageStatsToStorage() {
            try {
              localStorage.setItem('umi_usage_stats', JSON.stringify(this.usageStats));
            } catch (error) {
              console.error('Error saving usage stats:', error);
            }
          },
          
          // Cancellation functions
          async confirmCancelSubscription() {
            if (!this.cancelForm.confirmTerms) {
              this.showError('Please confirm that you understand the consequences');
              return;
            }
            
            try {
              if (!window.adminAPI) {
                this.showError('API services are not available. Please try again later.');
                return;
              }
              
              const response = await window.adminAPI.cancelSubscription({
                reason: this.cancelForm.reason,
                userId: this.userInfo.email,
                timestamp: new Date().toISOString()
              });
              
              if (response.success) {
                this.showSuccess('Subscription cancelled. Your account will become read-only and you will be logged out in 5 minutes.');
                this.showCancelConfirmModal = false;
                this.enableReadOnlyMode();
                this.scheduleAutoLogout();
              } else {
                this.showError('Failed to cancel subscription: ' + response.message);
              }
            } catch (error) {
              console.error('Cancel subscription error:', error);
              this.showError('Failed to cancel subscription. Please try again.');
            }
          },
          
          enableReadOnlyMode() {
            this.readOnlyMode = true;
            // Disable all form inputs
            const inputs = document.querySelectorAll('input, textarea, button:not(.btn-secondary)');
            inputs.forEach(input => {
              if (!input.classList.contains('btn-secondary')) {
                input.disabled = true;
              }
            });
            // Save read-only state
            localStorage.setItem('umi_read_only_mode', 'true');
            localStorage.setItem('umi_read_only_timestamp', new Date().toISOString());
          },
          
          scheduleAutoLogout() {
            // Schedule logout after 5 minutes
            setTimeout(() => {
              this.performAutoLogout();
            }, 5 * 60 * 1000); // 5 minutes in milliseconds
          },
          
          performAutoLogout() {
            // Clear all auth data
            localStorage.removeItem('umi_access_token');
            localStorage.removeItem('umi_refresh_token');
            localStorage.removeItem('umi_current_user');
            localStorage.removeItem('umi_current_tenant');
            localStorage.removeItem('umi_current_subscription');
            
            // Redirect to login page
            window.location.href = '/public/login.html';
          },
          
          calculateNextBilling(accountCreated, trialStart, isTrial) {
            const now = new Date();
            let baseDate;
            
            if (isTrial && trialStart) {
              // For trials, next billing is trial end date
              baseDate = new Date(trialStart);
              baseDate.setDate(baseDate.getDate() + 14); // 14 days trial
            } else if (accountCreated) {
              // For regular accounts, calculate from account creation or last billing
              baseDate = new Date(accountCreated);
              
              // Find the next billing date (monthly cycle)
              while (baseDate <= now) {
                baseDate.setMonth(baseDate.getMonth() + 1);
              }
            } else {
              // Default to 30 days from now if no dates available
              baseDate = new Date(now);
              baseDate.setDate(baseDate.getDate() + 30);
            }
            
            return baseDate.toISOString().split('T')[0];
          },
          
          updateNextBilling() {
            const now = new Date();
            let nextBillingDate;
            
            if (this.subscription.isTrial && this.subscription.trialEnd) {
              // Trial period - next billing is trial end
              nextBillingDate = new Date(this.subscription.trialEnd);
            } else if (this.subscription.lastBillingDate) {
              // Regular billing - add one month to last billing date
              nextBillingDate = new Date(this.subscription.lastBillingDate);
              nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);
            } else if (this.subscription.accountCreated) {
              // Calculate from account creation date
              nextBillingDate = new Date(this.subscription.accountCreated);
              
              // Find the next monthly billing date
              while (nextBillingDate <= now) {
                nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);
              }
            } else {
              // Default fallback
              nextBillingDate = new Date(now);
              nextBillingDate.setDate(nextBillingDate.getDate() + 30);
            }
            
            this.subscription.nextBilling = nextBillingDate.toISOString().split('T')[0];
            this.saveSubscriptionToStorage();
          },
          
          initializeAccountCreation() {
            if (!this.subscription.accountCreated) {
              // Set account creation date if not exists
              const user = localStorage.getItem('umi_current_user');
              if (user) {
                const userData = JSON.parse(user);
                // Use user creation date or current date as fallback
                this.subscription.accountCreated = userData.createdAt || new Date().toISOString();
              } else {
                this.subscription.accountCreated = new Date().toISOString();
              }
              
              // Set initial billing date
              this.updateNextBilling();
              this.saveSubscriptionToStorage();
            }
          },
          
          checkTrialStatus() {
            if (this.subscription.isTrial && this.subscription.trialEnd) {
              const now = new Date();
              const trialEndDate = new Date(this.subscription.trialEnd);
              const daysRemaining = Math.ceil((trialEndDate - now) / (1000 * 60 * 60 * 24));
              
              this.subscription.trialDaysRemaining = Math.max(0, daysRemaining);
              
              // If trial has expired
              if (daysRemaining <= 0) {
                this.expireTrial();
              } else if (daysRemaining <= 3) {
                // Show warning if trial is about to expire
                this.showWarning(`Trial expires in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}. Upgrade to continue using the service.`);
              }
            }
          },
          
          startTrial(planType) {
            const startDate = new Date();
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 14); // 2 weeks trial
            
            this.subscription = {
              ...this.subscription,
              planType: planType,
              status: 'Trial',
              isTrial: true,
              trialStart: startDate.toISOString(),
              trialEnd: endDate.toISOString(),
              trialDaysRemaining: 14,
              nextBilling: endDate.toISOString().split('T')[0]
            };
            
            // Save to localStorage
            this.saveSubscriptionToStorage();
            this.showSuccess(`Trial started for ${planType} plan. You have 14 days to evaluate the service.`);
          },
          
          expireTrial() {
            this.subscription = {
              ...this.subscription,
              status: 'Expired',
              isTrial: false,
              trialDaysRemaining: 0
            };
            
            // Enable read-only mode for expired trials
            this.enableReadOnlyMode();
            this.scheduleAutoLogout();
            
            // Save to localStorage
            this.saveSubscriptionToStorage();
            this.showError('Trial period has expired. Your account is now in read-only mode. Please upgrade to continue using the service.');
          },
          
          saveSubscriptionToStorage() {
            try {
              const subscriptionData = {
                plan: this.subscription.planType,
                status: this.subscription.status,
                nextBilling: this.subscription.nextBilling,
                trialStart: this.subscription.trialStart,
                trialEnd: this.subscription.trialEnd,
                isTrial: this.subscription.isTrial,
                trialDaysRemaining: this.subscription.trialDaysRemaining
              };
              localStorage.setItem('umi_current_subscription', JSON.stringify(subscriptionData));
            } catch (error) {
              console.error('Error saving subscription data:', error);
            }
          },
          
          checkReadOnlyMode() {
            const readOnlyMode = localStorage.getItem('umi_read_only_mode');
            const readOnlyTimestamp = localStorage.getItem('umi_read_only_timestamp');
            
            if (readOnlyMode === 'true' && readOnlyTimestamp) {
              const timestamp = new Date(readOnlyTimestamp);
              const now = new Date();
              const minutesElapsed = (now - timestamp) / (1000 * 60);
              
              if (minutesElapsed < 5) {
                this.enableReadOnlyMode();
                this.scheduleAutoLogout();
                this.showError('Your account is in read-only mode. You will be automatically logged out in ' + Math.ceil(5 - minutesElapsed) + ' minutes.');
              } else {
                // Clear expired read-only mode
                localStorage.removeItem('umi_read_only_mode');
                localStorage.removeItem('umi_read_only_timestamp');
              }
            }
          },
          
          // Computed properties
          get filteredSuggestions() {
            if (!this.searchQuery || this.searchQuery.length < 2) return [];
            return this.suggestions.filter(suggestion => 
              suggestion.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
              suggestion.description.toLowerCase().includes(this.searchQuery.toLowerCase())
            );
          },
          
          // Watchers
          'passwordForm.newPassword'() {
            this.validatePassword();
          },
          
          // Search methods
          selectSuggestion(suggestion) {
            this.activeSection = suggestion.id;
            this.searchQuery = '';
            this.searchOpen = false;
          },
          
          // Save methods
          saveProfile() {
            try {
              // Validate required fields
              if (!this.profile.firstName || !this.profile.lastName || !this.profile.email) {
                this.showError('Please fill in all required fields (First Name, Last Name, Email)');
                return;
              }

              // Save to localStorage first
              this.saveProfileToLocalStorage();
              
              // Try to save to API/database
              if (!window.adminAPI) {
                this.showError('API services are not available. Changes saved locally only.');
                return;
              }
              
              // Show loading state
              const originalButtonText = event.target.innerHTML;
              event.target.innerHTML = '<span class="material-symbols-rounded" style="animation: spin 1s linear infinite;">refresh</span> Saving...';
              event.target.disabled = true;
              
              window.adminAPI.updateUserProfile(this.profile)
                .then((response) => {
                  if (response.success) {
                    this.showSuccess('Profile updated successfully and synced across all portals');
                    
                    // Broadcast update to other portals
                    this.broadcastProfileUpdate();
                    
                    // Update userInfo in real-time
                    this.userInfo = {
                      name: `${this.profile.firstName} ${this.profile.lastName}`,
                      role: this.userInfo.role || 'Admin',
                      initials: `${this.profile.firstName?.[0] || 'U'}${this.profile.lastName?.[0] || 'H'}`,
                      email: this.profile.email
                    };
                  } else {
                    this.showError('Failed to update profile on server: ' + (response.message || 'Unknown error'));
                  }
                })
                .catch((error) => {
                  console.error('Error updating profile:', error);
                  this.showError('Failed to update profile on server. Changes saved locally only.');
                })
                .finally(() => {
                  // Restore button state
                  event.target.innerHTML = originalButtonText;
                  event.target.disabled = false;
                });
            } catch (error) {
              console.error('Save profile error:', error);
              this.saveProfileToLocalStorage();
              this.showError('API services are not available. Changes saved locally only.');
            }
          },
          
          saveProfileToLocalStorage() {
            try {
              // Update localStorage with new profile data
              const currentUser = JSON.parse(localStorage.getItem('umi_current_user') || '{}');
              currentUser.name = `${this.profile.firstName} ${this.profile.lastName}`;
              currentUser.email = this.profile.email;
              currentUser.phone = this.profile.phone; // Save phone number
              currentUser.bio = this.profile.bio; // Save bio
              localStorage.setItem('umi_current_user', JSON.stringify(currentUser));
              
              // Save complete profile data separately
              localStorage.setItem('umi_user_profile', JSON.stringify(this.profile));
              
              // Update userInfo in the component
              this.userInfo = {
                name: currentUser.name,
                role: currentUser.role || 'Admin',
                initials: `${this.profile.firstName?.[0] || 'U'}${this.profile.lastName?.[0] || 'H'}`,
                email: this.profile.email
              };
              
              console.log('Profile saved to localStorage:', this.profile);
            } catch (error) {
              console.error('Error saving profile to localStorage:', error);
            }
          },
          
          savePharmacySettings() {
            try {
              // Validate required fields
              if (!this.pharmacySettings.name) {
                this.showError('Pharmacy name is required');
                return;
              }

              // Save to localStorage first
              this.savePharmacySettingsToLocalStorage();
              
              // Try to save to API/database
              if (!window.adminAPI) {
                this.showError('API services are not available. Changes saved locally only.');
                return;
              }
              
              // Show loading state
              const originalButtonText = event.target.innerHTML;
              event.target.innerHTML = '<span class="material-symbols-rounded" style="animation: spin 1s linear infinite;">refresh</span> Saving...';
              event.target.disabled = true;
              
              window.adminAPI.updatePharmacySettings(this.pharmacySettings)
                .then((response) => {
                  if (response && response.success) {
                    this.showSuccess('Pharmacy settings updated successfully and synced across all portals');
                    
                    // Broadcast update to other portals
                    this.broadcastPharmacyUpdate();
                    
                    // Update pharmacyInfo in real-time
                    this.pharmacyInfo = {
                      name: this.pharmacySettings.name,
                      location: `${this.pharmacySettings.city}, ${this.pharmacySettings.province}`
                    };
                    
                    // Update data sync if available
                    if (window.adminDataSync) {
                      window.adminDataSync.setData('pharmacySettings', this.pharmacySettings);
                    }
                  } else {
                    this.showError('Failed to update pharmacy settings on server: ' + (response?.message || 'Unknown error'));
                  }
                })
                .catch((error) => {
                  console.error('Error updating pharmacy settings:', error);
                  this.showError('Failed to update pharmacy settings on server. Changes saved locally only.');
                })
                .finally(() => {
                  // Restore button state
                  event.target.innerHTML = originalButtonText;
                  event.target.disabled = false;
                });
            } catch (error) {
              console.error('Save pharmacy settings error:', error);
              this.savePharmacySettingsToLocalStorage();
              this.showError('API services are not available. Changes saved locally only.');
            }
          },
          
          savePharmacySettingsToLocalStorage() {
            try {
              // Update localStorage with complete pharmacy settings
              const currentTenant = JSON.parse(localStorage.getItem('umi_current_tenant') || '{}');
              
              // Update tenant basic info
              currentTenant.name = this.pharmacySettings.name;
              currentTenant.phone = this.pharmacySettings.phone;
              currentTenant.email = this.pharmacySettings.email;
              currentTenant.website = this.pharmacySettings.website;
              currentTenant.address = this.pharmacySettings.address;
              currentTenant.city = this.pharmacySettings.city;
              currentTenant.province = this.pharmacySettings.province;
              currentTenant.postalCode = this.pharmacySettings.postalCode;
              
              localStorage.setItem('umi_current_tenant', JSON.stringify(currentTenant));
              
              // Save complete pharmacy settings separately
              localStorage.setItem('umi_pharmacy_settings', JSON.stringify(this.pharmacySettings));
              
              // Update pharmacyInfo in the component
              this.pharmacyInfo = {
                name: this.pharmacySettings.name,
                location: `${this.pharmacySettings.city || 'Lusaka'}, ${this.pharmacySettings.province || 'Zambia'}`
              };
              
              console.log('Pharmacy settings saved to localStorage:', this.pharmacySettings);
            } catch (error) {
              console.error('Error saving pharmacy settings to localStorage:', error);
            }
          },
          
          saveNotificationSettings() {
            try {
              // Save to localStorage first
              this.saveNotificationSettingsToLocalStorage();
              
              if (!window.adminAPI) {
                this.showError('API services are not available. Changes saved locally.');
                return;
              }
              
              window.adminAPI.updateNotificationSettings(this.notifications)
                .then(() => {
                  this.showSuccess('Notification settings updated successfully');
                })
                .catch(error => {
                  console.error('Error updating notification settings:', error);
                  this.showError('Failed to update notification settings on server. Changes saved locally.');
                });
            } catch (error) {
              console.error('API not available:', error);
              this.saveNotificationSettingsToLocalStorage();
              this.showError('API services are not available. Changes saved locally.');
            }
          },
          
          saveNotificationSettingsToLocalStorage() {
            try {
              // Save notification settings to localStorage
              localStorage.setItem('umi_notification_settings', JSON.stringify(this.notifications));
              console.log('Notification settings saved to localStorage');
            } catch (error) {
              console.error('Error saving notification settings to localStorage:', error);
            }
          },
          
          // Notification methods
          showSuccess(message) {
            this.showNotification(message, 'success');
          },

          showError(message) {
            this.showNotification(message, 'error');
          },
          
          showWarning(message) {
            this.showNotification(message, 'warning');
          },
          
          showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
              notification.classList.add('show');
            }, 100);

            // Remove after 5 seconds
            setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => {
                if (notification.parentNode) {
                  document.body.removeChild(notification);
                }
              }, 300);
            }, 5000);
          },

          // Upgrade functions
          getPlanPrice(planType) {
            const prices = {
              'Care': 250,
              'Care Plus': 450,
              'Care Pro': 700
            };
            return prices[planType] || 0;
          },
          
          formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
          },
          
          upgradePlan(planType) {
            this.selectedUpgradePlan = planType;
            this.showUpgradeModal = true;
          },
          
          selectUpgradePlan(planType) {
            this.selectedUpgradePlan = planType;
          },
          
          cancelUpgrade() {
            this.showUpgradeModal = false;
            this.selectedUpgradePlan = null;
          },
          
          async confirmUpgrade() {
            if (!this.selectedUpgradePlan || this.selectedUpgradePlan === this.subscription.planType) {
              alert('Please select a different plan to upgrade');
              return;
            }
            
            // Check if API is available
            if (!window.adminAPI) {
              this.showError('API services are not available. Please check your connection and try again.');
              return;
            }
            
            try {
              this.upgradeRequestPending = true;
              
              // Create upgrade request that requires approval
              const response = await window.adminAPI.upgradeSubscription({
                planType: this.selectedUpgradePlan,
                billingCycle: 'monthly',
                amount: this.getPlanPrice(this.selectedUpgradePlan),
                currency: 'ZMW',
                autoRenew: true,
                requiresApproval: true,
                requestedBy: this.userInfo.email,
                planFrom: this.subscription.planType,
                requestDate: new Date().toISOString(),
                pharmacyName: this.pharmacySettings.name,
                pharmacyId: this.pharmacyInfo.name
              });
              
              if (response && response.success) {
                // Send notifications to super admin and operations
                await this.sendUpgradeNotifications({
                  planType: this.selectedUpgradePlan,
                  planFrom: this.subscription.planType,
                  amount: this.getPlanPrice(this.selectedUpgradePlan),
                  requestedBy: this.userInfo.email,
                  transactionId: response.transactionId,
                  pharmacyName: this.pharmacySettings.name
                });
                
                this.showSuccess(`Upgrade request submitted! Transaction ID: ${response.transactionId}. Your upgrade is pending approval from super admin and operations team.`);
                this.showUpgradeModal = false;
                this.selectedUpgradePlan = null;
              } else {
                this.showError('Upgrade request failed: ' + (response?.message || 'Unknown error'));
              }
            } catch (error) {
              console.error('Upgrade error:', error);
              if (error.message.includes('404')) {
                this.showError('Upgrade service is not available. Please contact support.');
              } else if (error.message.includes('Failed to execute')) {
                this.showError('Server error occurred. Please try again later.');
              } else {
                this.showError('Upgrade request failed. Please try again.');
              }
            } finally {
              this.upgradeRequestPending = false;
            }
          },
          
          async sendUpgradeNotifications(upgradeData) {
            try {
              // Send notification to super admin
              await window.adminAPI.sendNotification({
                type: 'upgrade_request',
                recipient: 'super_admin',
                subject: `Subscription Upgrade Request - ${upgradeData.pharmacyName}`,
                message: `Upgrade request from ${upgradeData.planFrom} to ${upgradeData.planType} plan. Amount: ${upgradeData.amount} ZMW/month. Requested by: ${upgradeData.requestedBy}. Transaction ID: ${upgradeData.transactionId}`,
                priority: 'high',
                data: upgradeData
              });
              
              // Send notification to operations team
              await window.adminAPI.sendNotification({
                type: 'upgrade_request',
                recipient: 'operations',
                subject: `Subscription Upgrade Approval Needed - ${upgradeData.pharmacyName}`,
                message: `New upgrade request requires approval. Plan: ${upgradeData.planFrom} → ${upgradeData.planType}. Amount: ${upgradeData.amount} ZMW/month. Requested by: ${upgradeData.requestedBy}. Transaction ID: ${upgradeData.transactionId}`,
                priority: 'high',
                data: upgradeData
              });
              
              console.log('Upgrade notifications sent successfully');
            } catch (error) {
              console.error('Failed to send upgrade notifications:', error);
              // Continue with the process even if notifications fail
            }
          },
          
          // Real-time sync functions
          broadcastProfileUpdate() {
            try {
              if (window.adminAPI) {
                window.adminAPI.broadcastUpdate({
                  type: 'profile_update',
                  data: this.profile,
                  userId: this.userInfo.email,
                  timestamp: new Date().toISOString()
                }).catch(error => {
                  console.warn('Failed to broadcast profile update:', error);
                });
              }
              
              // Update data sync if available
              if (window.adminDataSync) {
                window.adminDataSync.setData('currentUser', this.profile);
              }
              
              // Trigger storage event for cross-tab sync
              window.dispatchEvent(new StorageEvent('storage', {
                key: 'umi_user_profile',
                newValue: JSON.stringify(this.profile)
              }));
            } catch (error) {
              console.error('Error broadcasting profile update:', error);
            }
          },
          
          broadcastPharmacyUpdate() {
            try {
              if (window.adminAPI) {
                window.adminAPI.broadcastUpdate({
                  type: 'pharmacy_update',
                  data: this.pharmacySettings,
                  pharmacyId: this.pharmacySettings.name,
                  timestamp: new Date().toISOString()
                }).catch(error => {
                  console.warn('Failed to broadcast pharmacy update:', error);
                });
              }
              
              // Update data sync if available
              if (window.adminDataSync) {
                window.adminDataSync.setData('pharmacySettings', this.pharmacySettings);
              }
              
              // Trigger storage event for cross-tab sync
              window.dispatchEvent(new StorageEvent('storage', {
                key: 'umi_pharmacy_settings',
                newValue: JSON.stringify(this.pharmacySettings)
              }));
            } catch (error) {
              console.error('Error broadcasting pharmacy update:', error);
            }
          },
          
          broadcastSecurityUpdate(action, data = {}) {
            try {
              const securityData = {
                type: 'security_update',
                action: action,
                userId: this.userInfo.email,
                timestamp: new Date().toISOString(),
                ...data
              };
              
              if (window.adminAPI) {
                window.adminAPI.broadcastUpdate(securityData).catch(error => {
                  console.warn('Failed to broadcast security update:', error);
                });
              }
              
              // Trigger storage event for immediate local updates
              window.dispatchEvent(new StorageEvent('storage', {
                key: 'umi_security_update',
                newValue: JSON.stringify(securityData)
              }));
            } catch (error) {
              console.error('Error broadcasting security update:', error);
            }
          },
          
          async revokeAllOtherSessions() {
            try {
              if (window.adminAPI) {
                await window.adminAPI.revokeAllSessions();
                console.log('All other sessions revoked for security');
              }
            } catch (error) {
              console.warn('Failed to revoke other sessions:', error);
            }
          },
          
          // Listen for real-time updates from other portals
          setupRealtimeListeners() {
            try {
              // Listen for storage events (cross-tab sync)
              window.addEventListener('storage', (e) => {
                if (e.key === 'umi_user_profile' && e.newValue) {
                  try {
                    const newProfile = JSON.parse(e.newValue);
                    if (newProfile.email !== this.profile.email) {
                      // Update if it's a different user's profile change
                      console.log('Received profile update from another tab');
                      this.profile = { ...this.profile, ...newProfile };
                    }
                  } catch (error) {
                    console.warn('Failed to parse profile update:', error);
                  }
                } else if (e.key === 'umi_pharmacy_settings' && e.newValue) {
                  try {
                    const newSettings = JSON.parse(e.newValue);
                    console.log('Received pharmacy settings update from another tab');
                    this.pharmacySettings = { ...this.pharmacySettings, ...newSettings };
                  } catch (error) {
                    console.warn('Failed to parse pharmacy settings update:', error);
                  }
                } else if (e.key === 'umi_security_update' && e.newValue) {
                  try {
                    const securityUpdate = JSON.parse(e.newValue);
                    console.log('Received security update:', securityUpdate.action);
                    
                    if (securityUpdate.action === 'password_changed') {
                      this.passwordInfo.lastChanged = new Date().toLocaleDateString();
                    } else if (securityUpdate.action === 'session_revoked') {
                      this.loadActiveSessions();
                    }
                  } catch (error) {
                    console.warn('Failed to parse security update:', error);
                  }
                }
              });
              
              // Listen for data sync updates if available
              if (window.adminDataSync) {
                window.adminDataSync.subscribe('currentUser', (userData) => {
                  if (userData && userData.email === this.profile.email) {
                    console.log('Received user data sync update');
                    this.profile = { ...this.profile, ...userData };
                  }
                });
                
                window.adminDataSync.subscribe('pharmacySettings', (settings) => {
                  if (settings) {
                    console.log('Received pharmacy settings sync update');
                    this.pharmacySettings = { ...this.pharmacySettings, ...settings };
                  }
                });
              }
              
              console.log('Real-time listeners setup complete');
            } catch (error) {
              console.error('Error setting up real-time listeners:', error);
            }
          },

          canManageBranches() {
            const subscription = JSON.parse(localStorage.getItem('umi_subscription') || '{}');
            const planType = subscription.planType || 'Care';
            
            const tierConfig = {
              'Care': { maxBranches: 1 },
              'Care Plus': { maxBranches: 3 },
              'Care Pro': { maxBranches: 10 }
            };
            
            return tierConfig[planType] ? tierConfig[planType].maxBranches > 1 : false;
          }
        }
      }
    </script>

    <!-- Include required styles and scripts -->
    <link rel="stylesheet" href="../../shared/css/shared-styles.css">
    <script src="../../shared/js/data-sync.js"></script>
    <script src="../../shared/js/role-based-access.js"></script>
    <script src="js/admin-api.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
