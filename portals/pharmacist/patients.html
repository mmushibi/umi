<!DOCTYPE html>
<html lang="en" x-data="patientSystem()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Patients - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #000000;
      --color-accent: #14B8A6;
      --color-success: #22c55e;
      --color-warning: #ef4444;
      --color-text-primary: #000000;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      --color-background: #ffffff;
      --color-surface: #f9fafb;
      --color-border: #e5e7eb;
      --font-primary: 'Inter', sans-serif;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      font-family: 'Nunito', 'Varela Round', sans-serif;
      font-size: 13px;
      line-height: 1.4;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--color-text-primary);
      color: var(--color-accent);
      z-index: 1000;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Hidden attribute support */
    [hidden] {
      display: none !important;
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      max-width: 400px;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .notification-success {
      background: var(--color-success);
    }

    .notification-error {
      background: var(--color-warning);
    }

    .notification-warning {
      background: #f59e0b;
    }

    .notification-info {
      background: var(--color-primary);
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo-text {
      font-size: 1rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }


    .nav-menu {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-accent);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-accent);
      border-left: 3px solid var(--color-accent);
    }

    .nav-icon {
      font-size: 1rem;
    }

    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    /* Header Styles */
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-title-section {
      margin-right: 2rem;
    }

    .page-title-section .page-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
      font-family: 'Inter', sans-serif;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .create-button {
      background: var(--color-primary);
      color: var(--color-accent);
      border: none;
      padding: 0.375rem 0.875rem;
      border-radius: 6px;
      font-size: 0.625rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .create-button:hover {
      background: var(--color-text-secondary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-profile:hover {
      background: var(--color-surface);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--color-text-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.875rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    /* Patients Content */
    .patients-content {
      padding: 1.25rem;
      max-width: 1400px;
      margin: 0 auto;
      font-size: 13px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      font-size: 13px;
    }

    .stat-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .stat-icon.primary {
      background: rgba(0, 0, 0, 0.1);
      color: var(--color-primary);
    }

    .stat-icon.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .stat-icon.warning {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
    }

    .stat-label {
      color: var(--color-text-secondary);
      font-size: 13px;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.625rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-change.positive {
      color: var(--color-success);
    }

    .stat-change.negative {
      color: var(--color-warning);
    }

    /* Patients Table */
    .patients-section {
      background: var(--color-background);
      border-radius: 12px;
      border: 1px solid var(--color-border);
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.04);
    }

    .section-header {
      padding: 0.875rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .controls-bar {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .search-bar {
      position: relative;
    }

    .search-input {
      width: 300px;
      padding: 0.5rem 1rem 0.5rem 2.5rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-text-muted);
      font-size: 1rem;
    }

    .table-container {
      overflow-x: auto;
    }

    .patients-table {
      width: 100%;
      border-collapse: collapse;
    }

    .patients-table th {
      background: var(--color-surface);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
    }

    .patients-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.75rem;
    }

    .patients-table tr:hover {
      background: var(--color-surface);
    }

    .patient-name {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .patient-contact {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 0.125rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-size: 0.625rem;
      font-weight: 600;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .status-badge.inactive {
      background: rgba(0, 0, 0, 0.1);
      color: var(--color-text-secondary);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      border: none;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.125rem;
    }

    .action-btn:hover {
      background: var(--color-surface);
    }

    .action-btn.edit {
      color: var(--color-primary);
    }

    .action-btn.delete {
      color: var(--color-warning);
    }

    .action-btn.view {
      color: var(--color-text-secondary);
    }

    .logout-section {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }

    .logout-button {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
    }

    .logout-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

.logout-icon {
  font-size: 1.25rem;
}

    .csv-instructions-list li {
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
    }

    .csv-import-area {
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    .csv-import-area:hover,
    .csv-import-area.drag-over {
      border-color: var(--color-primary);
      background: var(--color-surface);
    }

    .csv-upload-icon {
      font-size: 2rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }

    .csv-upload-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .csv-upload-text {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    .csv-file-input {
      display: none;
    }

    .csv-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .csv-preview-table {
      overflow-x: auto;
      margin-top: 0.5rem;
    }

    .csv-preview-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.625rem;
    }

    .csv-preview-table th,
    .csv-preview-table td {
      padding: 0.375rem;
      text-align: left;
      border: 1px solid var(--color-border);
    }

    .csv-preview-table th {
      background: var(--color-primary);
      color: var(--color-accent);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .page-title-section {
        display: none;
      }

      .patients-content {
        padding: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-input {
        width: 100%;
      }

      .table-container {
        font-size: 0.75rem;
      }

      .patients-table th,
      .patients-table td {
        padding: 0.5rem;
      }
    }

    /* Patient Management Layout */
    .content-area {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 1.5rem;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .content-header p {
      color: var(--color-text-secondary);
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 0.75rem;
    }

    .primary-button, .secondary-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.875rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.625rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .primary-button {
      background: var(--color-primary);
      color: var(--color-accent);
      border-color: var(--color-primary);
    }

    .primary-button:hover {
      background: #333;
      transform: translateY(-0.5px);
    }

    .secondary-button {
      background: var(--color-surface);
      color: var(--color-text-primary);
      border-color: var(--color-border);
    }

    .secondary-button:hover {
      background: var(--color-border);
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .quick-stat-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .quick-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .quick-stat-card.success {
      border-left: 4px solid #10b981;
    }

    .quick-stat-card.warning {
      border-left: 4px solid #f59e0b;
    }

    .quick-stat-card.info {
      border-left: 4px solid #3b82f6;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--color-primary);
      color: var(--color-accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .stat-body h3 {
      margin: 0 0 0.25rem 0;
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    .stat-body strong {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text-primary);
      line-height: 1;
    }

    .stat-meta {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    /* Patient Management */
    .patients-management {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .patients-filters {
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 150px;
    }

    .filter-group label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .filter-select {
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-background);
      color: var(--color-text-primary);
      font-size: 0.75rem;
    }

    .filter-actions {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: end;
    }

    /* Table */
    .patients-table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    .data-table th {
      background: var(--color-surface);
      padding: 0.5rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-text-primary);
      border-bottom: 2px solid var(--color-border);
      font-size: 0.625rem;
    }

    .data-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.625rem;
      vertical-align: top;
    }

    .data-table tbody tr:hover {
      background: var(--color-surface);
    }

    /* Pagination */
    .table-pagination {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pagination-info {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pagination-btn {
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      background: var(--color-background);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-numbers {
      display: flex;
      gap: 0.25rem;
    }

    /* Patient Modules */
    .patient-modules {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .module-tabs {
      display: flex;
      flex-direction: column;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid var(--color-border);
    }

    .tab-btn {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
    }

    .tab-content {
      padding: 1.5rem;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Medical History */
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .summary-card {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .summary-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    /* Allergies */
    .allergies-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .allergy-categories {
      display: grid;
      gap: 1.5rem;
    }

    .category-card {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1rem;
    }

    .category-card h4 {
      margin: 0 0 1rem 0;
      color: var(--color-text-primary);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: 12px;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      margin: 1rem;
    }

    .modal-content.large {
      max-width: 900px;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--color-text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 0.875rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0.25rem;
      border-radius: 4px;
    }

    .modal-close:hover {
      background: var(--color-background);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 2rem;
    }

    .form-section h4 {
      margin: 0 0 1rem 0;
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .form-full-width {
      grid-column: 1 / -1;
    }

    .form-textarea {
      display: block;
      margin-top: 1rem;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }

    input, select, textarea {
      padding: 0.75rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-background);
      color: var(--color-text-primary);
      font-size: 0.75rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .header-actions {
        justify-content: stretch;
      }

      .header-actions button {
        flex: 1;
      }

      .quick-stats {
        grid-template-columns: 1fr;
      }

      .patients-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-actions {
        margin-left: 0;
        justify-content: stretch;
      }

      .filter-actions button {
        flex: 1;
      }

      .tab-nav {
        overflow-x: auto;
      }

      .modal-content {
        margin: 0;
        border-radius: 0;
        max-height: 100vh;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

    <!-- Backend Integration Libraries -->
    <script src="../../js/api-client.js"></script>
    <script src="../../js/auth-manager.js"></script>
    <script src="../shared/js/backend-integration-helper.js"></script>
    <script src="../shared/js/page-integration-template.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script></head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>


    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="patients.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="prescriptions.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">prescriptions</span>
        <span>Prescriptions</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory</span>
        <span>Inventory</span>
      </a>
      <a href="clinical.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">medical_services</span>
        <span>Clinical</span>
      </a>
      <a href="compliance.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">verified</span>
        <span>Compliance</span>
      </a>
      <a href="reports.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">analytics</span>
        <span>Reports</span>
      </a>
      <a href="suppliers.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">local_shipping</span>
        <span>Suppliers</span>
      </a>
      <a href="help.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">help</span>
        <span>Help & Training</span>
      </a>
      <a href="account.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">person</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        
        <div class="page-title-section">
          <h1 class="page-title">Patients Management</h1>
        </div>
        
        <div class="search-bar" x-data="{ searchOpen: false, query: '' }">
          <span class="material-symbols-rounded search-icon">search</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Search patients by name, ID, or prescription..."
            x-model="query"
            @focus="searchOpen = true"
            @input="searchOpen = true"
            @blur="setTimeout(() => searchOpen = false, 200)"
          >
          
          <div class="search-suggestions" :class="searchOpen && query.length > 0 ? 'show' : ''">
            <template x-for="suggestion in filteredSuggestions" :key="suggestion.id">
              <div class="suggestion-item" @click="selectSuggestion(suggestion)">
                <div class="suggestion-icon">
                  <span class="material-symbols-rounded" x-text="suggestion.icon"></span>
                </div>
                <div class="suggestion-content">
                  <div class="suggestion-title" x-text="suggestion.title"></div>
                  <div class="suggestion-description" x-text="suggestion.description"></div>
                </div>
                <div class="suggestion-type" x-text="suggestion.type"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div class="header-right">
        <!-- Header elements removed per request -->
      </div>
    </header>

    <section class="content-area">
        <div class="content-header">
          <div>
             <p>Manage patient profiles, medical history, and prescription records.</p>
          </div>
          <div class="header-actions">
            <button class="secondary-button" id="importPatientsBtn" data-action="import-patients">
              <span class="material-symbols-rounded">upload</span>
              Import Patients
            </button>
            <button class="primary-button" id="addPatientBtn" data-action="add-patient">
              <span class="material-symbols-rounded">add</span>
              Add Patient
            </button>
          </div>
        </div>

        <div class="overview-row">
          <section class="quick-stats" aria-label="Patient statistics">
            <article class="quick-stat-card" data-stat="total-patients">
              <div class="stat-icon" aria-hidden="true">
                <span class="material-symbols-rounded">people</span>
              </div>
              <div class="stat-body">
                <h3>Total Patients</h3>
                <strong id="totalPatientsCount">0</strong>
                <span class="stat-meta">Registered patients</span>
              </div>
            </article>
            <article class="quick-stat-card success" data-stat="active-prescriptions">
              <div class="stat-icon" aria-hidden="true">
                <span class="material-symbols-rounded">medical_services</span>
              </div>
              <div class="stat-body">
                <h3>Active Prescriptions</h3>
                <strong id="activePrescriptionsCount">0</strong>
                <span class="stat-meta">Ongoing treatments</span>
              </div>
            </article>
            <article class="quick-stat-card warning" data-stat="critical-patients">
              <div class="stat-icon" aria-hidden="true">
                <span class="material-symbols-rounded">priority_high</span>
              </div>
              <div class="stat-body">
                <h3>Critical Patients</h3>
                <strong id="criticalPatientsCount">0</strong>
                <span class="stat-meta">Require attention</span>
              </div>
            </article>
            <article class="quick-stat-card info" data-stat="new-patients">
              <div class="stat-icon" aria-hidden="true">
                <span class="material-symbols-rounded">person_add</span>
              </div>
              <div class="stat-body">
                <h3>New Patients</h3>
                <strong id="newPatientsCount">0</strong>
                <span class="stat-meta">This month</span>
              </div>
            </article>
          </section>
        </div>

        <div class="patients-management">
          <div class="patients-filters">
            <div class="filter-group">
              <label for="statusFilter">Status</label>
              <select id="statusFilter" class="filter-select">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="critical">Critical</option>
                <option value="discharged">Discharged</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="genderFilter">Gender</label>
              <select id="genderFilter" class="filter-select">
                <option value="">All Genders</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="ageFilter">Age Group</label>
              <select id="ageFilter" class="filter-select">
                <option value="">All Ages</option>
                <option value="0-17">0-17 years</option>
                <option value="18-35">18-35 years</option>
                <option value="36-50">36-50 years</option>
                <option value="51+">51+ years</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="conditionFilter">Condition</label>
              <select id="conditionFilter" class="filter-select">
                <option value="">All Conditions</option>
                <option value="chronic">Chronic</option>
                <option value="acute">Acute</option>
                <option value="preventive">Preventive</option>
              </select>
            </div>
            <div class="filter-actions">
              <button class="secondary-button" id="resetFilters">Reset Filters</button>
              <button class="primary-button" id="exportPatients">Export Data</button>
            </div>
          </div>

          <div class="patients-table-container">
            <table class="data-table" aria-label="Patients table">
              <thead>
                <tr>
                  <th scope="col">
                    <input type="checkbox" id="selectAllPatients" aria-label="Select all patients">
                  </th>
                  <th scope="col">Patient</th>
                  <th scope="col">Age/Gender</th>
                  <th scope="col">Contact</th>
                  <th scope="col">Blood Type</th>
                  <th scope="col">Last Visit</th>
                  <th scope="col">Active Prescriptions</th>
                  <th scope="col">Status</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="patientsTableBody">
                <tr>
                  <td colspan="9" class="loading-cell">
                    <span class="material-symbols-rounded loading-icon">people</span>
                    <p class="loading-text">Loading patient data...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="table-pagination" id="patientsPagination">
            <div class="pagination-info">
              <span id="paginationInfo">Showing 0 of 0 patients</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevPage" disabled>
                <span class="material-symbols-rounded">chevron_left</span>
              </button>
              <div class="pagination-numbers" id="paginationNumbers"></div>
              <button class="pagination-btn" id="nextPage" disabled>
                <span class="material-symbols-rounded">chevron_right</span>
              </button>
            </div>
          </div>
        </div>

        <div class="patient-modules">
          <div class="module-tabs">
            <div class="tab-nav">
              <button class="tab-btn active" data-tab="medical-history">Medical History</button>
              <button class="tab-btn" data-tab="allergies">Allergies</button>
              <button class="tab-btn" data-tab="medications">Medications</button>
              <button class="tab-btn" data-tab="vaccinations">Vaccinations</button>
            </div>
            
            <div class="tab-content">
              <div class="tab-pane active" id="medical-history-tab">
                <div class="medical-history-view">
                  <div class="history-header">
                    <h3>Medical History Overview</h3>
                    <button class="primary-button" id="addMedicalRecordBtn">Add Medical Record</button>
                  </div>
                  
                  <div class="history-summary">
                    <div class="summary-cards">
                      <div class="summary-card">
                        <h4>Chronic Conditions</h4>
                        <div class="summary-value">0</div>
                      </div>
                      <div class="summary-card">
                        <h4>Previous Surgeries</h4>
                        <div class="summary-value">0</div>
                      </div>
                      <div class="summary-card">
                        <h4>Family History</h4>
                        <div class="summary-value">0 records</div>
                      </div>
                      <div class="summary-card">
                        <h4>Last Checkup</h4>
                        <div class="summary-value">-</div>
                      </div>
                    </div>
                  </div>

                  <div class="medical-records">
                    <h4>Medical Records</h4>
                    <div class="records-timeline">
                      <div class="timeline-item">
                        <div class="timeline-date"></div>
                        <div class="timeline-content">
                          <h5></h5>
                          <p></p>
                          <div class="record-meta">
                            <span class="doctor"></span>
                            <span class="type"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="allergies-tab">
                <div class="allergies-management">
                  <div class="allergies-header">
                    <h3>Allergy Information</h3>
                    <button class="primary-button" id="addAllergyBtn">Add Allergy</button>
                  </div>

                  <div class="allergy-categories">
                    <div class="category-card">
                      <h4>Drug Allergies</h4>
                      <div class="allergy-list">
                        <div class="allergy-item severe">
                          <span class="allergy-name"></span>
                          <span class="severity"></span>
                          <span class="reaction"></span>
                        </div>
                      </div>
                    </div>
                    <div class="category-card">
                      <h4>Food Allergies</h4>
                      <div class="allergy-list">
                        <div class="allergy-item mild">
                          <span class="allergy-name"></span>
                          <span class="severity"></span>
                          <span class="reaction"></span>
                        </div>
                      </div>
                    </div>
                    <div class="category-card">
                      <h4>Environmental Allergies</h4>
                      <div class="allergy-list">
                        <div class="allergy-item moderate">
                          <span class="allergy-name"></span>
                          <span class="severity"></span>
                          <span class="reaction"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="medications-tab">
                <div class="medications-management">
                  <div class="medications-header">
                    <h3>Current & Past Medications</h3>
                    <button class="primary-button" id="addMedicationBtn">Add Medication</button>
                  </div>

                  <div class="medication-categories">
                    <div class="category-section">
                      <h4>Current Medications</h4>
                      <div class="medication-list">
                        <div class="medication-item active">
                          <div class="medication-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="medication-details">
                            <span class="prescribed-by"></span>
                            <span class="start-date"></span>
                            <span class="remaining"></span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="category-section">
                      <h4>Past Medications</h4>
                      <div class="medication-list">
                        <div class="medication-item completed">
                          <div class="medication-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="medication-details">
                            <span class="prescribed-by"></span>
                            <span class="period"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="vaccinations-tab">
                <div class="vaccinations-management">
                  <div class="vaccinations-header">
                    <h3>Vaccination Records</h3>
                    <button class="primary-button" id="addVaccinationBtn">Add Vaccination</button>
                  </div>

                  <div class="vaccination-schedule">
                    <div class="schedule-section">
                      <h4>Childhood Vaccinations</h4>
                      <div class="vaccination-list">
                        <div class="vaccination-item completed">
                          <div class="vaccine-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="vaccine-details">
                            <span class="date"></span>
                            <span class="status"></span>
                          </div>
                        </div>
                        <div class="vaccination-item completed">
                          <div class="vaccine-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="vaccine-details">
                            <span class="date"></span>
                            <span class="status"></span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="schedule-section">
                      <h4>Adult Vaccinations</h4>
                      <div class="vaccination-list">
                        <div class="vaccination-item completed">
                          <div class="vaccine-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="vaccine-details">
                            <span class="date"></span>
                            <span class="status"></span>
                          </div>
                        </div>
                        <div class="vaccination-item upcoming">
                          <div class="vaccine-info">
                            <h5></h5>
                            <p></p>
                          </div>
                          <div class="vaccine-details">
                            <span class="date"></span>
                            <span class="status"></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="overlay" id="modalOverlay" hidden></div>

  <!-- Add/Edit Patient Modal -->
  <section class="modal" id="patientModal" role="dialog" aria-modal="true" aria-labelledby="patientModalTitle" hidden>
    <div class="modal-content large">
      <header class="modal-header">
        <h2 id="patientModalTitle">Add New Patient</h2>
        <button type="button" class="modal-close" data-close="patientModal" aria-label="Close patient form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="patientForm" class="modal-body">
        <div class="form-section">
          <h4>Patient Information</h4>
          <div class="form-grid">
            <label>
              <span>First Name *</span>
              <input type="text" id="formFirstName" name="firstName" required>
            </label>
            <label>
              <span>Last Name *</span>
              <input type="text" id="formLastName" name="lastName" required>
            </label>
            <label>
              <span>Gender *</span>
              <select id="formGender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </label>
            <label>
              <span>Phone Number *</span>
              <input type="tel" id="formPhone" name="phone" required>
            </label>
          </div>
        </div>

        <div class="form-section">
          <h4>Emergency Contact</h4>
          <div class="form-grid">
            <label>
              <span>Emergency Contact Name *</span>
              <input type="text" id="formEmergencyContact" name="emergencyContact" required>
            </label>
            <label>
              <span>Emergency Contact Phone *</span>
              <input type="tel" id="formEmergencyPhone" name="emergencyPhone" required>
            </label>
          </div>
        </div>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary" data-close="patientModal">Cancel</button>
        <button type="submit" form="patientForm" class="primary" id="submitPatient">Create Patient</button>
      </footer>
    </div>
  </section>

  <!-- Patient Details Modal -->
  <section class="modal" id="patientDetailsModal" role="dialog" aria-modal="true" aria-labelledby="patientDetailsTitle" hidden>
    <div class="modal-content large">
      <header class="modal-header">
        <h2 id="patientDetailsTitle">Patient Details</h2>
        <button type="button" class="modal-close" data-close="patientDetailsModal" aria-label="Close patient details">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <div class="modal-body">
        <div class="patient-details-tabs">
          <div class="tab-nav">
            <button class="tab-btn active" data-tab="profile">Profile</button>
            <button class="tab-btn" data-tab="medical">Medical History</button>
            <button class="tab-btn" data-tab="prescriptions">Prescriptions</button>
            <button class="tab-btn" data-tab="visits">Visit History</button>
          </div>
          
          <div class="tab-content">
            <div class="tab-pane active" id="profile-tab">
              <div class="patient-profile-content">
                <!-- Profile content populated dynamically -->
              </div>
            </div>
            <div class="tab-pane" id="medical-tab">
              <div class="patient-medical-content">
                <!-- Medical history content populated dynamically -->
              </div>
            </div>
            <div class="tab-pane" id="prescriptions-tab">
              <div class="patient-prescriptions-content">
                <!-- Prescriptions content populated dynamically -->
              </div>
            </div>
            <div class="tab-pane" id="visits-tab">
              <div class="patient-visits-content">
                <!-- Visit history content populated dynamically -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <button type="button" class="secondary" data-close="patientDetailsModal">Close</button>
        <button class="primary" id="editPatientBtn">Edit Patient</button>
      </footer>
    </div>
  </section>

  <!-- CSV Import Modal -->
  <section class="modal" id="csvImportModal" role="dialog" aria-modal="true" aria-labelledby="csvImportTitle" hidden>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="csvImportTitle">Import Patients from CSV</h2>
        <button type="button" class="modal-close" data-close="csvImportModal" aria-label="Close CSV import">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <div class="modal-body">
        <div class="csv-import-instructions">
          <h4>Import Instructions:</h4>
          <ol class="csv-instructions-list">
            <li>Download the CSV template using the button below</li>
            <li>Fill in patient information following the template format</li>
            <li>Upload the completed CSV file</li>
            <li>Review and confirm the import</li>
          </ol>
          <button class="secondary-button download-template-btn" id="downloadTemplateBtn">
            <span class="material-symbols-rounded">download</span>
            Download CSV Template
          </button>
        </div>
        
        <div class="csv-import-area" id="csvDropZone">
          <span class="material-symbols-rounded csv-upload-icon">upload_file</span>
          <h4 class="csv-upload-title">Drop CSV file here or click to browse</h4>
          <p class="csv-upload-text">Supported format: .csv (Maximum 1000 records)</p>
          <input type="file" id="csvFileInput" accept=".csv" class="csv-file-input">
        </div>
        
        <div id="csvPreview" class="csv-preview">
          <h4>Preview (First 5 rows)</h4>
          <div id="csvPreviewTable" class="csv-preview-table"></div>
          <p id="csvStats" class="csv-stats"></p>
        </div>
      </div>
      <footer class="modal-footer">
        <button type="button" class="secondary-button" data-close="csvImportModal">Cancel</button>
        <button type="button" class="primary-button" id="confirmImportBtn" disabled>Import Patients</button>
      </footer>
    </div>
  </section>

  <!-- Add Allergy Modal -->
  <section class="modal" id="allergyModal" role="dialog" aria-modal="true" aria-labelledby="allergyModalTitle" hidden>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="allergyModalTitle">Add Allergy</h2>
        <button type="button" class="modal-close" data-close="allergyModal" aria-label="Close allergy form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="allergyForm" class="modal-body">
        <div class="form-grid">
          <label>
            <span>Allergy Type *</span>
            <select id="allergyType" name="allergyType" required>
              <option value="">Select Type</option>
              <option value="drug">Drug Allergy</option>
              <option value="food">Food Allergy</option>
              <option value="environmental">Environmental Allergy</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            <span>Allergen Name *</span>
            <input type="text" id="allergenName" name="allergenName" placeholder="e.g., Penicillin" required>
          </label>
          <label>
            <span>Severity *</span>
            <select id="allergySeverity" name="severity" required>
              <option value="">Select Severity</option>
              <option value="mild">Mild</option>
              <option value="moderate">Moderate</option>
              <option value="severe">Severe</option>
            </select>
          </label>
          <label>
            <span>Date Identified</span>
            <input type="date" id="allergyDate" name="allergyDate">
          </label>
        </div>
        <label class="form-textarea form-spacing-top">
          <span>Reaction Description *</span>
          <textarea id="allergyReaction" name="reaction" rows="3" placeholder="Describe the allergic reaction..." required></textarea>
        </label>
        <label class="form-textarea form-spacing-top">
          <span>Notes</span>
          <textarea id="allergyNotes" name="notes" rows="2" placeholder="Additional notes or treatment recommendations..."></textarea>
        </label>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary-button" data-close="allergyModal">Cancel</button>
        <button type="submit" form="allergyForm" class="primary-button">Save Allergy</button>
      </footer>
    </div>
  </section>

  <!-- Add Medication Modal -->
  <section class="modal" id="medicationModal" role="dialog" aria-modal="true" aria-labelledby="medicationModalTitle" hidden>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="medicationModalTitle">Add Medication</h2>
        <button type="button" class="modal-close" data-close="medicationModal" aria-label="Close medication form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="medicationForm" class="modal-body">
        <div class="form-grid">
          <label>
            <span>Medication Name *</span>
            <input type="text" id="medicationName" name="medicationName" placeholder="e.g., Amoxicillin" required>
          </label>
          <label>
            <span>Dosage *</span>
            <input type="text" id="medicationDosage" name="dosage" placeholder="e.g., 500mg" required>
          </label>
          <label>
            <span>Frequency *</span>
            <select id="medicationFrequency" name="frequency" required>
              <option value="">Select Frequency</option>
              <option value="once_daily">Once Daily</option>
              <option value="twice_daily">Twice Daily</option>
              <option value="three_times_daily">Three Times Daily</option>
              <option value="four_times_daily">Four Times Daily</option>
              <option value="as_needed">As Needed</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            <span>Route *</span>
            <select id="medicationRoute" name="route" required>
              <option value="">Select Route</option>
              <option value="oral">Oral</option>
              <option value="topical">Topical</option>
              <option value="injection">Injection</option>
              <option value="inhalation">Inhalation</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            <span>Start Date *</span>
            <input type="date" id="medicationStartDate" name="startDate" required>
          </label>
          <label>
            <span>End Date</span>
            <input type="date" id="medicationEndDate" name="endDate">
          </label>
          <label>
            <span>Prescribed By</span>
            <input type="text" id="medicationPrescriber" name="prescriber" placeholder="Doctor's name">
          </label>
          <label>
            <span>Status *</span>
            <select id="medicationStatus" name="status" required>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
              <option value="discontinued">Discontinued</option>
            </select>
          </label>
        </div>
        <label class="form-textarea form-spacing-top">
          <span>Instructions</span>
          <textarea id="medicationInstructions" name="instructions" rows="3" placeholder="e.g., Take with food, twice daily after meals..."></textarea>
        </label>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary-button" data-close="medicationModal">Cancel</button>
        <button type="submit" form="medicationForm" class="primary-button">Save Medication</button>
      </footer>
    </div>
  </section>

  <!-- Add Vaccination Modal -->
  <section class="modal" id="vaccinationModal" role="dialog" aria-modal="true" aria-labelledby="vaccinationModalTitle" hidden>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="vaccinationModalTitle">Add Vaccination</h2>
        <button type="button" class="modal-close" data-close="vaccinationModal" aria-label="Close vaccination form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="vaccinationForm" class="modal-body">
        <div class="form-grid">
          <label>
            <span>Vaccine Name *</span>
            <input type="text" id="vaccineName" name="vaccineName" placeholder="e.g., COVID-19 Vaccine" required>
          </label>
          <label>
            <span>Vaccine Type *</span>
            <select id="vaccineType" name="vaccineType" required>
              <option value="">Select Type</option>
              <option value="childhood">Childhood Vaccine</option>
              <option value="adult">Adult Vaccine</option>
              <option value="travel">Travel Vaccine</option>
              <option value="seasonal">Seasonal Vaccine</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>
            <span>Date Administered *</span>
            <input type="date" id="vaccineDate" name="vaccineDate" required>
          </label>
          <label>
            <span>Dose Number</span>
            <input type="number" id="vaccineDose" name="doseNumber" min="1" placeholder="e.g., 1">
          </label>
          <label>
            <span>Administered By</span>
            <input type="text" id="vaccineAdministrator" name="administrator" placeholder="Healthcare provider name">
          </label>
          <label>
            <span>Batch/Lot Number</span>
            <input type="text" id="vaccineBatch" name="batchNumber" placeholder="Vaccine batch number">
          </label>
          <label>
            <span>Next Dose Due</span>
            <input type="date" id="vaccineNextDose" name="nextDoseDate">
          </label>
          <label>
            <span>Status *</span>
            <select id="vaccineStatus" name="status" required>
              <option value="completed">Completed</option>
              <option value="scheduled">Scheduled</option>
              <option value="overdue">Overdue</option>
            </select>
          </label>
        </div>
        <label class="form-textarea form-spacing-top">
          <span>Notes</span>
          <textarea id="vaccineNotes" name="notes" rows="3" placeholder="Additional notes, side effects, or observations..."></textarea>
        </label>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary-button" data-close="vaccinationModal">Cancel</button>
        <button type="submit" form="vaccinationForm" class="primary-button">Save Vaccination</button>
      </footer>
    </div>
  </section>

  <!-- Medical Records Modal -->
  <section class="modal" id="medicalRecordModal" role="dialog" aria-modal="true" aria-labelledby="medicalRecordTitle" hidden>
    <div class="modal-content large">
      <header class="modal-header">
        <h2 id="medicalRecordTitle">Add Medical Record</h2>
        <button type="button" class="modal-close" data-close="medicalRecordModal" aria-label="Close medical record form">
          <span class="material-symbols-rounded" aria-hidden="true">close</span>
        </button>
      </header>
      <form id="medicalRecordForm" class="medical-record-form">
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-section">
              <h3>Visit Information</h3>
              <label class="form-input">
                <span>Visit Date *</span>
                <input type="datetime-local" id="visitDate" name="visitDate" required>
              </label>
              <label class="form-input">
                <span>Visit Type *</span>
                <select id="visitType" name="visitType" required>
                  <option value="">Select visit type</option>
                  <option value="consultation">Consultation</option>
                  <option value="followup">Follow-up</option>
                  <option value="emergency">Emergency</option>
                  <option value="routine">Routine Check-up</option>
                  <option value="vaccination">Vaccination</option>
                </select>
              </label>
              <label class="form-input">
                <span>Chief Complaint *</span>
                <textarea id="chiefComplaint" name="chiefComplaint" rows="3" placeholder="Main reason for visit..." required></textarea>
              </label>
            </div>

            <div class="form-section">
              <h3>Vital Signs</h3>
              <div class="vitals-grid">
                <label class="form-input">
                  <span>Blood Pressure</span>
                  <input type="text" id="bloodPressure" name="bloodPressure" placeholder="120/80">
                </label>
                <label class="form-input">
                  <span>Heart Rate (bpm)</span>
                  <input type="number" id="heartRate" name="heartRate" placeholder="72">
                </label>
                <label class="form-input">
                  <span>Temperature (C)</span>
                  <input type="number" id="temperature" name="temperature" step="0.1" placeholder="36.5">
                </label>
                <label class="form-input">
                  <span>Weight (kg)</span>
                  <input type="number" id="weight" name="weight" step="0.1" placeholder="70">
                </label>
                <label class="form-input">
                  <span>Height (cm)</span>
                  <input type="number" id="height" name="height" placeholder="170">
                </label>
              </div>
            </div>

            <div class="form-section">
              <h3>Diagnosis & Treatment</h3>
              <label class="form-input">
                <span>Diagnosis *</span>
                <textarea id="diagnosis" name="diagnosis" rows="3" placeholder="Diagnosis based on examination..." required></textarea>
              </label>
              <label class="form-input">
                <span>Treatment Plan *</span>
                <textarea id="treatment" name="treatment" rows="3" placeholder="Treatment and management plan..." required></textarea>
              </label>
              <label class="form-input">
                <span>Medications Prescribed</span>
                <textarea id="medications" name="medications" rows="3" placeholder="List of medications prescribed..."></textarea>
              </label>
              <label class="form-input">
                <span>Follow-up Instructions</span>
                <textarea id="followup" name="followup" rows="2" placeholder="Follow-up care instructions..."></textarea>
              </label>
            </div>

            <div class="form-section">
              <h3>Additional Notes</h3>
              <label class="form-textarea">
                <span>Clinical Notes</span>
                <textarea id="clinicalNotes" name="clinicalNotes" rows="4" placeholder="Detailed clinical observations and notes..."></textarea>
              </label>
              <label class="form-input">
                <span>Attending Healthcare Provider *</span>
                <input type="text" id="provider" name="provider" placeholder="Dr. Smith" required>
              </label>
            </div>
          </div>
        </div>
      </form>
      <footer class="modal-footer">
        <button type="button" class="secondary-button" data-close="medicalRecordModal">Cancel</button>
        <button type="submit" form="medicalRecordForm" class="primary-button">Save Medical Record</button>
      </footer>
    </div>
  </section>
  </main>

  <!-- Alpine.js Component -->
  <script>
    // Patient System with Backend Integration
    
    function patientSystem() {
      // Initialize backend integration
      const pageIntegration = new PageIntegrationTemplate('pharmacist-patients', {
          requireAuth: true,
          enableRealTime: true,
          enableCaching: true
      });
      
      return {
        pageIntegration,
        backendHelper: window.backendHelper,
        apiClient: window.apiClient,
        authManager: window.authManager,
        isAuthenticated: false,
        loading: false,
        error: null,
        sidebarOpen: false,
        searchQuery: '',
        showFilterMenu: false,
        loading: false,
        tenantInfo: {
          name: 'Umi Health',
          location: 'Lusaka, Zambia'
        },
        userInfo: {
          name: 'Umi Health',
          role: 'Admin',
          initials: 'UH'
        },
        patients: [],
        currentPage: 1,
        itemsPerPage: 10,
        searchOpen: false,
        searchSuggestions: [],

        get filteredSuggestions() {
          if (!this.searchQuery || this.searchQuery.length < 2) return [];
          
          const query = this.searchQuery.toLowerCase();
          return this.patients
            .filter(patient => 
              patient.firstName?.toLowerCase().includes(query) ||
              patient.lastName?.toLowerCase().includes(query) ||
              patient.email?.toLowerCase().includes(query) ||
              patient.phone?.includes(query) ||
              patient.patientNumber?.toLowerCase().includes(query)
            )
            .slice(0, 5)
            .map(patient => ({
              id: patient.id,
              title: `${patient.firstName} ${patient.lastName}`,
              description: `Patient ID: ${patient.patientNumber} | ${patient.email}`,
              type: 'Patient',
              icon: 'person'
            }));
        },

        get filteredPatients() {
          if (!this.searchQuery) return this.patients;
          
          return this.patients.filter(patient => 
            patient.firstName?.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            patient.lastName?.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            patient.email?.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
            patient.phone?.includes(this.searchQuery)
          );
        },

        get totalPatients() {
          return this.patients.length;
        },

        get newPatients() {
          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();
          
          return this.patients.filter(patient => {
            const regDate = new Date(patient.createdAt);
            return regDate.getMonth() === currentMonth && regDate.getFullYear() === currentYear;
          }).length;
        },

        get activePatients() {
          return this.patients.filter(p => p.isActive !== false).length;
        },

        async loadPatients() {
          try {
            this.loading = true;
            const response = await api.getPatients();
            
            if (response.success) {
              this.patients = response.data || [];
              console.log('Patients loaded:', this.patients.length);
            } else {
              throw new Error(response.message || 'Failed to load patients');
            }
          } catch (error) {
            console.error('Failed to load patients:', error);
            this.showNotification('Failed to load patients: ' + error.message, 'error');
            this.patients = [];
          } finally {
            this.loading = false;
          }
        },

        async createPatient(patientData) {
          try {
            this.loading = true;
            
            const response = await api.createPatient(patientData);
            
            if (response.success) {
              this.showNotification('Patient created successfully', 'success');
              await this.loadPatients(); // Refresh the list
              return response.data;
            } else {
              throw new Error(response.message || 'Failed to create patient');
            }
          } catch (error) {
            console.error('Failed to create patient:', error);
            this.showNotification('Failed to create patient: ' + error.message, 'error');
            throw error;
          } finally {
            this.loading = false;
          }
        },

        async updatePatient(id, patientData) {
          try {
            this.loading = true;
            const response = await api.updatePatient(id, patientData);
            
            if (response.success) {
              const index = this.patients.findIndex(p => p.id === id);
              if (index !== -1) {
                this.patients[index] = response.data;
              }
              this.showNotification('Patient updated successfully', 'success');
              return response.data;
            } else {
              throw new Error(response.message || 'Failed to update patient');
            }
          } catch (error) {
            console.error('Failed to update patient:', error);
            this.showNotification('Failed to update patient: ' + error.message, 'error');
            throw error;
          } finally {
            this.loading = false;
          }
        },

        async deletePatient(patientId) {
          if (!confirm('Are you sure you want to delete this patient record?')) {
            return;
          }

          try {
            this.loading = true;
            
            const response = await api.deletePatient(patientId);
            
            if (response.success) {
              this.patients = this.patients.filter(p => p.id !== patientId);
              this.showNotification('Patient deleted successfully', 'success');
            } else {
              throw new Error(response.message || 'Failed to delete patient');
            }
          } catch (error) {
            console.error('Failed to delete patient:', error);
            this.showNotification('Failed to delete patient: ' + error.message, 'error');
          } finally {
            this.loading = false;
          }
        },

        // Search suggestion methods
        selectSuggestion(suggestion) {
          this.searchQuery = suggestion.title;
          this.searchOpen = false;
          // Navigate to patient or perform search
          this.viewPatient({ id: suggestion.id, ...suggestion });
        },

        // Search Patients functionality
        async searchPatients(query, limit = 10) {
          try {
            const response = await api.searchPatients(query);
            
            if (response.success) {
              return (response.data || []).slice(0, limit);
            }
          } catch (error) {
            console.error('Failed to search patients:', error);
          }
          return [];
        },

        viewPatient(patient) {
          console.log('View patient:', patient);
          // Navigate to patient details or open modal
          // For now, just show a notification
          this.showNotification(`Viewing patient: ${patient.firstName || 'Unknown'} ${patient.lastName || ''}`, 'info');
        },

        editPatient(patient) {
          // Populate form with patient data for editing
          const form = document.getElementById('patientForm');
          if (form) {
            form.firstName.value = patient.firstName || '';
            form.lastName.value = patient.lastName || '';
            form.email.value = patient.email || '';
            form.phone.value = patient.phone || '';
            form.dateOfBirth.value = patient.dateOfBirth ? patient.dateOfBirth.split('T')[0] : '';
            form.gender.value = patient.gender || '';
            form.address.value = patient.address || '';
            form.medicalAidNumber.value = patient.medicalAidNumber || '';
            form.medicalAidProvider.value = patient.medicalAidProvider || '';
            
            // Store patient ID for update
            form.dataset.patientId = patient.id;
            
            // Show modal
            this.openModal('patientModal');
          }
        },

        formatCurrency(amount) {
          return new Intl.NumberFormat('en-ZM', {
            style: 'currency',
            currency: 'ZMW'
          }).format(amount);
        },

        showNotification(message, type = 'info') {
          // Create notification element
          const notification = document.createElement('div');
          notification.className = `notification notification-${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);

          // Animate in
          setTimeout(() => {
            notification.classList.add('show');
          }, 100);

          // Remove after 5 seconds
          setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
              if (notification.parentNode) {
                document.body.removeChild(notification);
              }
            }, 300);
          }, 5000);
        },

        // Modal Management
        openModal(modalId) {
          document.getElementById(modalId).hidden = false;
          document.getElementById('modalOverlay').hidden = false;
          document.body.style.overflow = 'hidden';
        },

        closeModal(modalId) {
          document.getElementById(modalId).hidden = true;
          document.getElementById('modalOverlay').hidden = true;
          document.body.style.overflow = '';
        },

        // Patient Form Management
        submitPatientForm(event) {
          event.preventDefault();
          const form = event.target;
          const formData = new FormData(form);
          const patientId = form.dataset.patientId;
          
          const patientData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            dateOfBirth: formData.get('dateOfBirth'),
            gender: formData.get('gender'),
            address: formData.get('address'),
            city: formData.get('city'),
            province: formData.get('province'),
            postalCode: formData.get('postalCode'),
            medicalAidNumber: formData.get('medicalAidNumber'),
            medicalAidProvider: formData.get('medicalAidProvider'),
            emergencyContactName: formData.get('emergencyContactName'),
            emergencyContactPhone: formData.get('emergencyContactPhone'),
            emergencyContactRelationship: formData.get('emergencyContactRelationship')
          };
          
          try {
            if (patientId) {
              // Update existing patient
              this.updatePatient(patientId, patientData);
            } else {
              // Create new patient
              this.createPatient(patientData);
            }
            
            this.closeModal('patientModal');
            form.reset();
            delete form.dataset.patientId;
          } catch (error) {
            console.error('Patient save error:', error);
            alert('Failed to save patient. Please try again.');
          }
        },

        // Setup event listeners for buttons
        setupEventListeners() {
          // Import Patients Button
          const importBtn = document.getElementById('importPatientsBtn');
          if (importBtn) {
            importBtn.addEventListener('click', () => this.openImportModal());
          }

          // Add Patient Button
          const addPatientBtn = document.getElementById('addPatientBtn');
          if (addPatientBtn) {
            addPatientBtn.addEventListener('click', () => this.openAddPatientModal());
          }

          // Export Patients Button
          const exportBtn = document.getElementById('exportPatients');
          if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportPatients());
          }

          // Add Medical Record Button
          const addMedicalBtn = document.getElementById('addMedicalRecordBtn');
          if (addMedicalBtn) {
            addMedicalBtn.addEventListener('click', () => this.openMedicalRecordModal());
          }

          // Medical Record Form
          const medicalRecordForm = document.getElementById('medicalRecordForm');
          if (medicalRecordForm) {
            medicalRecordForm.addEventListener('submit', (e) => this.submitMedicalRecord(e));
          }

          // Download Template Button
          const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
          if (downloadTemplateBtn) {
            downloadTemplateBtn.addEventListener('click', () => this.downloadCSVTemplate());
          }

          // CSV Import functionality
          this.setupCSVImport();

          // Modal close buttons
          document.querySelectorAll('[data-close]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const modalId = e.target.closest('[data-close]').getAttribute('data-close');
              this.closeModal(modalId);
            });
          });
        },

        // Add Patient functionality
        openAddPatientModal() {
          // Clear any existing form data
          const form = document.getElementById('patientForm');
          if (form) {
            form.reset();
            delete form.dataset.patientId;
          }
          
          // Open the patient modal
          this.openModal('patientModal');
        },

        // Import functionality
        openImportModal() {
          this.openModal('csvImportModal');
        },

        setupCSVImport() {
          const dropZone = document.getElementById('csvDropZone');
          const fileInput = document.getElementById('csvFileInput');
          const confirmBtn = document.getElementById('confirmImportBtn');

          if (!dropZone || !fileInput || !confirmBtn) return;

          // Click to browse
          dropZone.addEventListener('click', () => fileInput.click());

          // Drag and drop
          dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
          });

          dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
          });

          dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            this.handleFileSelect(e.dataTransfer.files[0]);
          });

          // File selection
          fileInput.addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files[0]);
          });

          // Confirm import
          confirmBtn.addEventListener('click', () => this.confirmImport());
        },

        handleFileSelect(file) {
          if (!file || !file.name.endsWith('.csv')) {
            this.showNotification('Please select a CSV file', 'error');
            return;
          }

          if (file.size > 5 * 1024 * 1024) { // 5MB limit
            this.showNotification('File size must be less than 5MB', 'error');
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              this.csvData = this.parseCSV(e.target.result);
              this.showCSVPreview();
              document.getElementById('confirmImportBtn').disabled = false;
            } catch (error) {
              this.showNotification('Error parsing CSV file', 'error');
            }
          };
          reader.readAsText(file);
        },

        parseCSV(csvText) {
          const lines = csvText.split('\n').filter(line => line.trim());
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const data = [];

          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            if (values.length === headers.length) {
              const patient = {};
              headers.forEach((header, index) => {
                patient[header] = values[index];
              });
              data.push(patient);
            }
          }

          return data;
        },

        showCSVPreview() {
          const preview = document.getElementById('csvPreview');
          if (!preview || !this.csvData) return;

          const previewHtml = `
            <h4>Preview (${this.csvData.length} records)</h4>
            <div class="csv-preview-table">
              <table>
                <thead>
                  <tr>${Object.keys(this.csvData[0]).map(key => `<th>${key}</th>`).join('')}</tr>
                </thead>
                <tbody>
                  ${this.csvData.slice(0, 5).map(row => 
                    `<tr>${Object.values(row).map(value => `<td>${value}</td>`).join('')}</tr>`
                  ).join('')}
                </tbody>
              </table>
            </div>
            ${this.csvData.length > 5 ? `<p>... and ${this.csvData.length - 5} more records</p>` : ''}
          `;
          
          preview.innerHTML = previewHtml;
          preview.style.display = 'block';
        },

        async confirmImport() {
          if (!this.csvData || this.csvData.length === 0) {
            this.showNotification('No data to import', 'error');
            return;
          }

          try {
            this.loading = true;
            const tenantId = this.getTenantId();
            
            // Convert CSV data to patient format
            const patients = this.csvData.map(row => ({
              firstName: row.FirstName || row.firstName || '',
              lastName: row.LastName || row.lastName || '',
              dateOfBirth: row.DateOfBirth || row.dateOfBirth || '',
              gender: row.Gender || row.gender || '',
              email: row.Email || row.email || '',
              phone: row.Phone || row.phone || '',
              address: row.Address || row.address || '',
              city: row.City || row.city || '',
              country: row.Country || row.country || '',
              postalCode: row.PostalCode || row.postalCode || '',
              bloodType: row.BloodType || row.bloodType || '',
              insuranceProvider: row.InsuranceProvider || row.insuranceProvider || '',
              insurancePolicyNumber: row.InsuranceNumber || row.insuranceNumber || ''
            }));

            // Call bulk import API
            const response = await fetch(`/api/v1/patients/bulk-import?tenantId=${tenantId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.getAuthToken()}`
              },
              body: JSON.stringify(patients)
            });

            const result = await response.json();
            
            if (response.ok) {
              this.showNotification(`Successfully imported ${result.imported?.length || 0} patients`, 'success');
              this.closeModal('csvImportModal');
              await this.loadPatients();
            } else {
              this.showNotification(result.error || 'Import failed', 'error');
            }
          } catch (error) {
            console.error('Import error:', error);
            this.showNotification('Import failed', 'error');
          } finally {
            this.loading = false;
          }
        },

        downloadCSVTemplate() {
          const template = [
            'FirstName,LastName,DateOfBirth,Gender,Email,Phone,Address,City,Country,PostalCode,BloodType,InsuranceProvider,InsuranceNumber',
            'John,Doe,1990-01-01,Male,john.doe@email.com,+1234567890,123 Main St,Test City,Test Country,12345,O+,Test Insurance,INS123456',
            'Jane,Smith,1985-05-15,Female,jane.smith@email.com,+0987654321,456 Oak Ave,Sample City,Sample Country,67890,A+,Sample Insurance,INS789012'
          ].join('\n');

          const blob = new Blob([template], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'patients_template.csv';
          a.click();
          window.URL.revokeObjectURL(url);
        },

        // Export functionality
        async exportPatients() {
          try {
            this.loading = true;
            
            // Get all patients
            const patients = this.patients;
            
            if (patients.length === 0) {
              this.showNotification('No patients to export', 'warning');
              return;
            }

            // Convert to CSV
            const csv = this.convertPatientsToCSV(patients);
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patients_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            const mode = this.getAuthToken() ? 'Authenticated' : 'Real';
            this.showNotification(`Exported ${patients.length} patients (${mode} Mode)`, 'success');
          } catch (error) {
            console.error('Export error:', error);
            this.showNotification('Export failed', 'error');
          } finally {
            this.loading = false;
          }
        },

        convertPatientsToCSV(patients) {
          if (!Array.isArray(patients) || patients.length === 0) return '';
          
          const headers = [
            'PatientNumber', 'FirstName', 'LastName', 'DateOfBirth', 'Gender', 
            'Email', 'Phone', 'Address', 'City', 'Country', 'PostalCode',
            'BloodType', 'Allergies', 'ChronicConditions', 'EmergencyContactName',
            'EmergencyContactPhone', 'InsuranceProvider', 'InsuranceNumber', 'IsActive', 'CreatedAt'
          ];
          
          const csvRows = [headers.join(',')];
          
          for (const patient of patients) {
            const values = [
              `"${patient.patientNumber || ''}"`,
              `"${patient.firstName || ''}"`,
              `"${patient.lastName || ''}"`,
              `"${patient.dateOfBirth || ''}"`,
              `"${patient.gender || ''}"`,
              `"${patient.email || ''}"`,
              `"${patient.phone || ''}"`,
              `"${patient.address || ''}"`,
              `"${patient.city || ''}"`,
              `"${patient.country || ''}"`,
              `"${patient.postalCode || ''}"`,
              `"${patient.bloodType || ''}"`,
              `"${patient.allergies || ''}"`,
              `"${patient.chronicConditions || ''}"`,
              `"${patient.emergencyContactName || ''}"`,
              `"${patient.emergencyContactPhone || ''}"`,
              `"${patient.insuranceProvider || ''}"`,
              `"${patient.insuranceNumber || ''}"`,
              `"${patient.isActive || true}"`,
              `"${patient.createdAt || new Date().toISOString()}"`
            ];
            csvRows.push(values.join(','));
          }
          
          return csvRows.join('\n');
        },

        // Medical Records functionality
        openMedicalRecordModal() {
          this.selectedPatient = this.getCurrentSelectedPatient();
          if (!this.selectedPatient) {
            this.showNotification('Please select a patient first', 'warning');
            return;
          }
          
          // Reset form
          this.resetMedicalRecordForm();
          
          // Set default values
          const now = new Date();
          document.getElementById('visitDate').value = now.toISOString().slice(0, 16);
          document.getElementById('provider').value = this.userInfo.name || 'Pharmacist';
          
          // Show modal
          document.getElementById('medicalRecordModal').hidden = false;
          document.getElementById('modalOverlay').hidden = false;
        },

        resetMedicalRecordForm() {
          const form = document.getElementById('medicalRecordForm');
          if (form) {
            form.reset();
          }
        },

        async submitMedicalRecord(event) {
          event.preventDefault();
          
          if (!this.selectedPatient) {
            this.showNotification('No patient selected', 'error');
            return;
          }

          const formData = new FormData(event.target);
          const medicalRecord = {
            id: Date.now().toString(),
            patientId: this.selectedPatient.id,
            patientName: `${this.selectedPatient.firstName} ${this.selectedPatient.lastName}`,
            visitDate: formData.get('visitDate'),
            visitType: formData.get('visitType'),
            chiefComplaint: formData.get('chiefComplaint'),
            vitalSigns: {
              bloodPressure: formData.get('bloodPressure'),
              heartRate: formData.get('heartRate'),
              temperature: formData.get('temperature'),
              weight: formData.get('weight'),
              height: formData.get('height')
            },
            diagnosis: formData.get('diagnosis'),
            treatment: formData.get('treatment'),
            medications: formData.get('medications'),
            followup: formData.get('followup'),
            clinicalNotes: formData.get('clinicalNotes'),
            provider: formData.get('provider'),
            createdAt: new Date().toISOString(),
            tenantId: this.getTenantId()
          };

          try {
            // Try to save via API first
            if (this.apiClient) {
              await this.apiClient.createMedicalRecord(medicalRecord);
            } else {
              // Fallback to localStorage
              this.saveMedicalRecordLocally(medicalRecord);
            }
            
            this.showNotification('Medical record saved successfully!', 'success');
            this.closeMedicalRecordModal();
            this.loadPatientMedicalRecords(); // Refresh records
            
          } catch (error) {
            console.error('Error saving medical record:', error);
            this.showNotification('Failed to save medical record', 'error');
          }
        },

        saveMedicalRecordLocally(record) {
          const records = JSON.parse(localStorage.getItem('umi_medical_records') || '[]');
          records.push(record);
          localStorage.setItem('umi_medical_records', JSON.stringify(records));
        },

        closeMedicalRecordModal() {
          document.getElementById('medicalRecordModal').hidden = true;
          document.getElementById('modalOverlay').hidden = true;
        },

        getCurrentSelectedPatient() {
          // Get selected patient from the patients table or current view
          const selectedRow = document.querySelector('.patient-row.selected');
          if (selectedRow) {
            const patientId = selectedRow.dataset.patientId;
            return this.patients.find(p => p.id === patientId);
          }
          return this.selectedPatient || null;
        },

        loadPatientMedicalRecords() {
          if (!this.selectedPatient) return;
          
          try {
            const records = JSON.parse(localStorage.getItem('umi_medical_records') || '[]');
            const patientRecords = records.filter(r => r.patientId === this.selectedPatient.id);
            
            // Update the medical records display in patient details
            this.updateMedicalRecordsDisplay(patientRecords);
          } catch (error) {
            console.error('Error loading medical records:', error);
          }
        },

        updateMedicalRecordsDisplay(records) {
          const recordsContainer = document.querySelector('.records-timeline');
          if (!recordsContainer) return;

          recordsContainer.innerHTML = records.map(record => `
            <div class="timeline-item">
              <div class="timeline-date">${this.formatDate(record.visitDate)}</div>
              <div class="timeline-content">
                <h5>${record.visitType} - ${record.diagnosis}</h5>
                <p><strong>Provider:</strong> ${record.provider}</p>
                <p><strong>Chief Complaint:</strong> ${record.chiefComplaint}</p>
                <p><strong>Treatment:</strong> ${record.treatment}</p>
                ${record.medications ? `<p><strong>Medications:</strong> ${record.medications}</p>` : ''}
              </div>
            </div>
          `).join('');
        },

        // Helper methods
        getTenantId() {
          try {
            const userStr = localStorage.getItem('umi_currentUser') || localStorage.getItem('umi_current_user');
            if (userStr && userStr !== 'undefined' && userStr !== 'null') {
              const user = JSON.parse(userStr);
              return user.tenantId || null;
            }
          } catch (error) {
            console.error('Failed to get tenant ID:', error);
          }
          return null;
        },

        getAuthToken() {
          return localStorage.getItem('umi_auth_token') || 
                 sessionStorage.getItem('umi_auth_token') || 
                 '';
        },

        async init() {
            try {
                // Check authentication
                this.isAuthenticated = this.authManager?.isAuthenticated() || false;
                
                if (!this.isAuthenticated) {
                    this.error = 'Please login to access this page';
                    return;
                }
                
                // Initialize backend integration
                await this.backendHelper.initPage('pharmacist-patients', {
                    enableRealTime: true,
                    initialData: this.getInitialDataConfig()
                });
                
                // Load page data
                await this.loadPageData();
                
                // Set up event listeners
                this.setupEventListeners();
                
                console.log('pharmacist-patients page initialized with backend integration');
            } catch (error) {
                console.error('Failed to initialize pharmacist-patients page:', error);
                this.error = 'Failed to initialize page';
            }
        },

        // Methods required by PageIntegrationTemplate
        getInitialDataConfig() {
            return {
                patients: {
                    endpoint: '/patients',
                    autoLoad: true,
                    cacheKey: 'patients-list'
                }
            };
        },

        async loadPageData() {
            await this.loadPatients();
        },

        setupEventListeners() {
            // Setup modal event listeners, form submissions, etc.
            this.setupModalListeners();
            this.setupFormListeners();
        },

        setupModalListeners() {
            // Modal close buttons
            document.querySelectorAll('[data-close]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalId = e.target.closest('[data-close]').dataset.close;
                    this.closeModal(modalId);
                });
            });

            // Modal backdrop clicks
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal.id);
                    }
                });
            });
        },

        setupFormListeners() {
            // Patient form submission
            const patientForm = document.getElementById('patientForm');
            if (patientForm) {
                patientForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handlePatientSubmit(patientForm);
                });
            }
        },

        async handlePatientSubmit(form) {
            const formData = new FormData(form);
            const patientData = Object.fromEntries(formData.entries());
            const patientId = form.dataset.patientId;

            try {
                if (patientId) {
                    await this.updatePatient(patientId, patientData);
                } else {
                    await this.createPatient(patientData);
                }
                this.closeModal('patientModal');
                form.reset();
                delete form.dataset.patientId;
            } catch (error) {
                console.error('Failed to save patient:', error);
            }
        },

        openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.removeAttribute('hidden');
                modal.querySelector('input, select, textarea')?.focus();
            }
        },

        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.setAttribute('hidden', '');
            }
        },

        showNotification(message, type = 'info', duration = 5000) {
            // Use backend helper notification if available, otherwise fallback
            if (this.backendHelper) {
                this.backendHelper.showNotification(message, type, duration);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        },

        // Legacy init method for backward compatibility
        async initLegacy() {
          // Setup event listeners first (works without auth)
          this.setupEventListeners();

          // Get user information from auth manager
          const authInfo = auth.getAuthInfo();
          if (!authInfo.isAuthenticated) {
            this.error = 'Please login to access this page';
            return;
          }

          // Set user info
          this.tenantInfo.name = authInfo.tenant?.name || 'Pharmacy';
          this.tenantInfo.location = authInfo.tenant?.location || 'Main Branch';
          this.userInfo.name = authInfo.user?.name || 'User';
          this.userInfo.role = authInfo.user?.role || 'pharmacist';
          this.userInfo.initials = this.getInitials(authInfo.user?.name || 'User');
          
          // Load patients from API
          await this.loadPatients();
          
          console.log('Patient management initialized successfully');

          try {
            const user = authInfo.user;
            this.tenantInfo.name = 'Umi Health';
            this.userInfo.name = user.name || 'User';
            this.userInfo.role = user.roles?.[0] || 'pharmacist';
            this.userInfo.initials = this.userInfo.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            
            console.log('User authenticated:', { userId: user.id, role: this.userInfo.role });
          } catch (error) {
            console.error('Failed to parse user info:', error);
            this.showNotification('Authentication error', 'error');
            return;
          }

          // Load patients from API
          await this.loadPatients();
          
          // Setup periodic refresh
          setInterval(async () => {
            try {
              await this.loadPatients();
            } catch (error) {
              console.error('Periodic refresh failed:', error);
            }
          }, 60000); // Refresh every minute
          
          // Add sync button to header
          this.addSyncButton();

          console.log('Patient system initialized');
        },
        
        addSyncButton() {
          const headerRight = document.querySelector('.header-right');
          if (!headerRight) return;
          
          const syncButton = document.createElement('button');
          syncButton.className = 'create-button sync-button';
          syncButton.innerHTML = `
            <span class="material-symbols-rounded">sync</span>
            <span>Sync</span>
          `;
          syncButton.addEventListener('click', async () => {
            try {
              syncButton.disabled = true;
              syncButton.innerHTML = `
                <span class="material-symbols-rounded">sync</span>
                <span>Syncing...</span>
              `;
              
              await this.loadPatients();
              
            } catch (error) {
              console.error('Sync failed:', error);
            } finally {
              syncButton.disabled = false;
              syncButton.innerHTML = `
                <span class="material-symbols-rounded">sync</span>
                <span>Sync</span>
              `;
            }
          });
          
          headerRight.appendChild(syncButton);
        }
      };
    }
  </script>

  <script src="../../js/api-client.js"></script>
  <script src="../../js/auth-manager.js"></script>
  <script>
    // Initialize API clients
    const api = apiClient;
    const auth = authManager;

    // Check authentication
    if (!auth.isAuthenticated()) {
      window.location.href = '../../public/signin.html';
    }

    // Check permissions
    if (!auth.hasAnyRole(['Pharmacist', 'Admin', 'SuperAdmin'])) {
      window.location.href = '/unauthorized';
    }
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
