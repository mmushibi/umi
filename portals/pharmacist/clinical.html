<!DOCTYPE html>
<html lang="en" x-data="clinicalSystem()" x-init="init()">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clinical Decision Support - Umi Health Information Systems</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&family=Varela+Round&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --color-primary: #000000;
      --color-accent: #14B8A6;
      --color-success: #22c55e;
      --color-warning: #ef4444;
      --color-info: #3b82f6;
      --color-text-primary: #000000;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      --color-background: #ffffff;
      --color-surface: #f9fafb;
      --color-border: #e5e7eb;
      --font-primary: 'Inter', sans-serif;
      --sidebar-width: 280px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      font-family: 'Nunito', 'Varela Round', sans-serif;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--color-text-primary);
      color: var(--color-accent);
      z-index: 1000;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }

    .pharmacy-info {
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      margin: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 0.85rem;
    }

    .pharmacy-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .pharmacy-location {
      opacity: 0.8;
      font-size: 0.75rem;
    }

    .nav-menu {
      padding: 1rem 0;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-accent);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-accent);
      border-left: 3px solid var(--color-accent);
    }

    .nav-icon {
      font-size: 1.25rem;
    }

    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    /* Header Styles */
    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-title-section {
      margin-right: 2rem;
    }

    .mobile-page-title {
      display: none;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text-primary);
      font-family: 'Inter', sans-serif;
    }

    .page-title-section .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0;
      font-family: 'Inter', sans-serif;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    /* Content Styles */
    .content {
      padding: 2rem;
    }

    /* Patient Search Styles */
    .patient-search-section {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--color-border);
    }

    .patient-search-input {
      position: relative;
    }

    .patient-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }

    .patient-result-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .patient-result-item:hover {
      background: var(--color-surface);
    }

    .patient-result-item:last-child {
      border-bottom: none;
    }

    .patient-name {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .patient-details {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      margin-top: 0.25rem;
    }

    .selected-patient {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--color-success);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    /* Clinical History Panel */
    .history-panel {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--color-border);
    }

    .history-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.875rem;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      color: var(--color-text-muted);
      font-size: 0.75rem;
    }

    .history-type {
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    /* Drug Monograph Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      /* Force hide initially */
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--color-border);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Clinical Alerts */
    .alerts-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 300px;
      z-index: 1500;
    }

    .alert-notification {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--color-warning);
    }

    .alert-notification.high {
      border-left-color: var(--color-warning);
    }

    .alert-notification.medium {
      border-left-color: #f59e0b;
    }

    .alert-notification.low {
      border-left-color: var(--color-info);
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .alert-message {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .alert-dismiss {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      float: right;
    }

    /* Enhanced Form Styles */
    .enhanced-form-group {
      margin-bottom: 1.5rem;
    }

    .form-row-three {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }

    .severity-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .severity-high {
      background: var(--color-warning);
    }

    .severity-medium {
      background: #f59e0b;
    }

    .severity-low {
      background: var(--color-info);
    }

    .export-section {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 1px solid var(--color-border);
    }

    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
    }

    .info-badge {
      background: var(--color-info);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .warning-badge {
      background: var(--color-warning);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .success-badge {
      background: var(--color-success);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .tool-card {
      background: var(--color-background);
      border-radius: 20px;
      border: 1px solid var(--color-border);
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tool-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .tool-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .tool-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .tool-icon.interaction {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .tool-icon.dosage {
      background: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
    }

    .tool-icon.allergy {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .tool-icon.alternative {
      background: rgba(59, 130, 246, 0.1);
      color: var(--color-info);
    }

    .tool-title {
      flex: 1;
    }

    .tool-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
    }

    .tool-description {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .tool-content {
      padding: 1.5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--color-background);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--color-background);
    }

    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-accent);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover {
      background: var(--color-text-secondary);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-border);
    }

    /* Result Styles */
    .result-container {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--color-border);
    }

    .result-container.success {
      background: rgba(34, 197, 94, 0.05);
      border-color: var(--color-success);
    }

    .result-container.warning {
      background: rgba(239, 68, 68, 0.05);
      border-color: var(--color-warning);
    }

    .result-container.info {
      background: rgba(59, 130, 246, 0.05);
      border-color: var(--color-info);
    }

    .result-title {
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .result-content {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .alert-item.high {
      background: rgba(239, 68, 68, 0.1);
    }

    .alert-item.medium {
      background: rgba(245, 158, 11, 0.1);
    }

    .alert-item.low {
      background: rgba(59, 130, 246, 0.1);
    }

    .alert-icon {
      margin-top: 0.125rem;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }

    .alert-description {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .logout-section {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
    }

    .logout-button {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
    }

    .logout-button:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-warning);
    }

    .logout-icon {
      font-size: 1.25rem;
    }

    /* Tool Grid Layout */
    .tool-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.5rem;
      margin-top: 2rem;
    }

    @media (max-width: 1024px) {
      .tool-grid {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .page-title-section {
        display: none;
      }

      .mobile-page-title {
        display: block;
      }

      .tool-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" :class="sidebarOpen ? 'open' : ''">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="logo-icon">
          <span class="material-symbols-rounded">medication</span>
        </div>
        <div class="logo-text">Umi Health</div>
      </div>
    </div>


    <nav class="nav-menu">
      <a href="home.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">home</span>
        <span>Home</span>
      </a>
      <a href="prescriptions.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">prescriptions</span>
        <span>Prescriptions</span>
      </a>
      <a href="patients.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">people</span>
        <span>Patients</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">inventory_2</span>
        <span>Inventory</span>
      </a>
      <a href="payments.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">payments</span>
        <span>Payments</span>
      </a>
      <a href="suppliers.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">local_shipping</span>
        <span>Suppliers</span>
      </a>
      <a href="clinical.html" class="nav-item active">
        <span class="material-symbols-rounded nav-icon">medical_services</span>
        <span>Clinical Support</span>
      </a>
      <a href="compliance.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">gavel</span>
        <span>Compliance</span>
      </a>
      <a href="reports.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">analytics</span>
        <span>Reports</span>
      </a>
      <a href="help.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">help</span>
        <span>Help & Training</span>
      </a>
      <a href="account.html" class="nav-item">
        <span class="material-symbols-rounded nav-icon">settings</span>
        <span>Account</span>
      </a>
    </nav>
    
    <div class="logout-section">
      <button class="logout-button" @click="logout()">
        <span class="material-symbols-rounded logout-icon">logout</span>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-toggle" @click="sidebarOpen = !sidebarOpen">
          <span class="material-symbols-rounded">menu</span>
        </button>
        
        <div class="mobile-page-title">Clinical Decision Support</div>
        
        <div class="page-title-section">
          <h1 class="page-title">Clinical Decision Support</h1>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="content">
      <!-- Patient Search Section -->
      <div class="patient-search-section">
        <h2 class="section-title">Patient Selection</h2>
        <div class="patient-search-input">
          <input 
            type="text" 
            class="form-input" 
            x-model="patientSearchQuery"
            @input="searchPatients"
            @focus="showPatientResults = true"
            @blur="setTimeout(() => showPatientResults = false, 200)"
            placeholder="Search patients by name, ID, or date of birth..."
          >
          <div x-show="showPatientResults && patientSearchResults.length > 0" class="patient-search-results">
            <template x-for="patient in patientSearchResults" :key="patient.id">
              <div class="patient-result-item" @click="selectPatient(patient)">
                <div class="patient-name" x-text="`${patient.firstName} ${patient.lastName}`"></div>
                <div class="patient-details">
                  ID: <span x-text="patient.id"></span> | 
                  DOB: <span x-text="patient.dateOfBirth"></span> | 
                  Age: <span x-text="patient.age"></span>
                </div>
              </div>
            </template>
          </div>
        </div>
        
        <div x-show="selectedPatient" class="selected-patient">
          <h3 class="subsection-title">Selected Patient</h3>
          <div class="patient-info-header">
            <div>
              <strong x-text="`${selectedPatient.firstName} ${selectedPatient.lastName}`"></strong><br>
              <span class="patient-details">
                ID: <span x-text="selectedPatient.id"></span> | 
                Age: <span x-text="selectedPatient.age"></span> | 
                Gender: <span x-text="selectedPatient.gender"></span>
              </span>
            </div>
            <button class="btn btn-secondary btn-small" @click="clearPatient()">Clear</button>
          </div>
        </div>
      </div>

      <!-- Clinical History Panel -->
      <div x-show="selectedPatient" class="history-panel">
        <h3 class="section-title">Recent Clinical History</h3>
        <div x-show="clinicalHistory.length === 0" class="no-history-message">
          No clinical history available for this patient
        </div>
        <template x-for="item in clinicalHistory" :key="item.id">
          <div class="history-item">
            <div class="history-date" x-text="new Date(item.timestamp).toLocaleString()"></div>
            <div class="history-type" x-text="item.type.replace('_', ' ').toUpperCase()"></div>
            <div x-text="item.description"></div>
          </div>
        </template>
      </div>

      <!-- Clinical Alerts Panel -->
      <div x-show="clinicalAlerts.length > 0" class="alerts-panel">
        <template x-for="alert in clinicalAlerts" :key="alert.id">
          <div class="alert-notification" :class="alert.severity">
            <button class="alert-dismiss" @click="dismissAlert(alert.id)">
              <span class="material-symbols-rounded">close</span>
            </button>
            <div class="alert-title" x-text="alert.title"></div>
            <div class="alert-message" x-text="alert.message"></div>
          </div>
        </template>
      </div>
      <!-- Tool Grid -->
      <div class="tool-grid">
        <!-- Drug Interaction Checker -->
        <div class="tool-card">
          <div class="tool-header">
            <div class="tool-icon interaction">
              <span class="material-symbols-rounded">warning</span>
            </div>
            <div class="tool-title">
              <div class="tool-name">Drug Interaction Checker</div>
              <div class="tool-description">Check for potential drug interactions</div>
            </div>
          </div>
          <div class="tool-content">
            <form @submit.prevent="checkInteractions">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Drug 1</label>
                  <div class="position-relative">
                    <select class="form-select" x-model="interaction.drug1" title="Select first drug for interaction check">
                      <option value="">Select drug...</option>
                      <template x-for="drug in medications" :key="drug.id">
                        <option :value="drug.id" x-text="drug.name"></option>
                      </template>
                    </select>
                    <button type="button" class="btn btn-secondary btn-small icon-button-absolute" @click="showDrugMonograph(interaction.drug1)" x-show="interaction.drug1">
                      <span class="material-symbols-rounded icon-button-small">info</span>
                    </button>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Drug 2</label>
                  <div class="position-relative">
                    <select class="form-select" x-model="interaction.drug2" title="Select second drug for interaction check">
                      <option value="">Select drug...</option>
                      <template x-for="drug in medications" :key="drug.id">
                        <option :value="drug.id" x-text="drug.name"></option>
                      </template>
                    </select>
                    <button type="button" class="btn btn-secondary btn-small icon-button-absolute" @click="showDrugMonograph(interaction.drug2)" x-show="interaction.drug2">
                      <span class="material-symbols-rounded icon-button-small">info</span>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="enhanced-form-group" x-show="selectedPatient">
                <label class="form-label">Severity Scoring</label>
                <div class="severity-indicators">
                  <span class="severity-indicator severity-low"></span><span>Low Risk</span>
                  <span class="severity-indicator severity-medium"></span><span>Medium Risk</span>
                  <span class="severity-indicator severity-high"></span><span>High Risk</span>
                </div>
              </div>
              
              <div class="btn-group">
                <button type="submit" class="btn btn-primary" :disabled="loading">
                  <span class="material-symbols-rounded" x-show="!loading">search</span>
                  <span class="material-symbols-rounded loading-spinner" x-show="loading">refresh</span>
                  <span x-text="loading ? 'Checking...' : 'Check Interactions'"></span>
                </button>
                <button type="button" class="btn btn-secondary" @click="checkTherapeuticDuplication" :disabled="!selectedPatient">
                  <span class="material-symbols-rounded">content_copy</span>
                  <span>Check Duplication</span>
                </button>
              </div>
            </form>

            <div x-show="interaction.result" class="result-container" :class="interaction.result.type">
              <div class="result-title">
                <span class="material-symbols-rounded" x-text="interaction.result.icon"></span>
                <span x-text="interaction.result.title"></span>
                <span x-show="interaction.result.severityScore" class="severity-indicator" :class="`severity-${interaction.result.severityLevel}`"></span>
                <span x-show="interaction.result.severityScore" x-text="`Score: ${interaction.result.severityScore}`" class="severity-score"></span>
              </div>
              <div class="result-content" x-html="interaction.result.content"></div>
              <div x-show="interaction.result.recommendations" class="recommendations-section">
                <strong>Recommendations:</strong>
                <ul class="recommendations-list">
                  <template x-for="rec in interaction.result.recommendations">
                    <li x-text="rec"></li>
                  </template>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Dosage Calculator -->
        <div class="tool-card">
          <div class="tool-header">
            <div class="tool-icon dosage">
              <span class="material-symbols-rounded">calculate</span>
            </div>
            <div class="tool-title">
              <div class="tool-name">Dosage Calculator</div>
              <div class="tool-description">Calculate appropriate medication dosages</div>
            </div>
          </div>
          <div class="tool-content">
            <form @submit.prevent="calculateDosage">
              <div class="form-group">
                <label class="form-label">Medication</label>
                <div class="dosage-calculator-container">
                  <select class="form-select" x-model="dosage.medication" title="Select medication for dosage calculation">
                    <option value="">Select medication...</option>
                    <template x-for="drug in medications" :key="drug.id">
                      <option :value="drug.id" x-text="drug.name"></option>
                    </template>
                  </select>
                  <button type="button" class="btn btn-secondary btn-small dosage-info-button" @click="showDrugMonograph(dosage.medication)" x-show="dosage.medication">
                    <span class="material-symbols-rounded dosage-info-icon">info</span>
                  </button>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Patient Weight (kg)</label>
                  <input type="number" class="form-input" x-model="dosage.weight" placeholder="Enter weight">
                </div>
                <div class="form-group">
                  <label class="form-label">Patient Age</label>
                  <input type="number" class="form-input" x-model="dosage.age" placeholder="Enter age">
                </div>
              </div>
              
              <div class="form-row-three" x-show="selectedPatient">
                <div class="form-group">
                  <label class="form-label">Serum Creatinine (mg/dL)</label>
                  <input type="number" step="0.1" class="form-input" x-model="dosage.creatinine" placeholder="1.0">
                </div>
                <div class="form-group">
                  <label class="form-label">Child-Pugh Score</label>
                  <select class="form-select" x-model="dosage.childPugh" title="Select Child-Pugh classification">
                    <option value="">Normal</option>
                    <option value="A">Class A (Mild)</option>
                    <option value="B">Class B (Moderate)</option>
                    <option value="C">Class C (Severe)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Pregnancy Trimester</label>
                  <select class="form-select" x-model="dosage.trimester" title="Select pregnancy trimester">
                    <option value="">Not Pregnant</option>
                    <option value="1">First Trimester</option>
                    <option value="2">Second Trimester</option>
                    <option value="3">Third Trimester</option>
                  </select>
                </div>
              </div>
              
              <div class="enhanced-form-group" x-show="selectedPatient && dosage.age >= 65">
                <label class="form-label">Elderly Considerations</label>
                <div class="elderly-considerations">
                  <span class="warning-badge">Beers Criteria Check</span>
                  <span class="consideration-text">Age-related dosage adjustments will be applied</span>
                </div>
              </div>
              
              <div class="btn-group">
                <button type="submit" class="btn btn-primary" :disabled="loading">
                  <span class="material-symbols-rounded" x-show="!loading">calculate</span>
                  <span class="material-symbols-rounded loading-spinner" x-show="loading">refresh</span>
                  <span x-text="loading ? 'Calculating...' : 'Calculate Dosage'"></span>
                </button>
                <button type="button" class="btn btn-secondary" @click="checkElderlyAppropriateness" x-show="dosage.age >= 65">
                  <span class="material-symbols-rounded">elderly</span>
                  <span>Check Beers Criteria</span>
                </button>
              </div>
            </form>

            <div x-show="dosage.result" class="result-container success">
              <div class="result-title">
                <span class="material-symbols-rounded">check_circle</span>
                <span>Recommended Dosage</span>
              </div>
              <div class="result-content" x-text="dosage.result"></div>
              <div x-show="dosage.renalAdjustment" class="adjustment-section">
                <span class="info-badge">Renal Adjustment Applied</span>
                <p class="adjustment-text" x-text="dosage.renalAdjustment"></p>
              </div>
              <div x-show="dosage.hepaticAdjustment" class="adjustment-section">
                <span class="warning-badge">Hepatic Adjustment Applied</span>
                <p class="adjustment-text" x-text="dosage.hepaticAdjustment"></p>
              </div>
              <div x-show="dosage.pregnancyWarning" class="adjustment-section">
                <span class="warning-badge">Pregnancy Warning</span>
                <p class="adjustment-text" x-text="dosage.pregnancyWarning"></p>
              </div>
              <div x-show="dosage.elderlyWarning" class="adjustment-section">
                <span class="warning-badge">Elderly Consideration</span>
                <p class="adjustment-text" x-text="dosage.elderlyWarning"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Allergy Checker -->
        <div class="tool-card">
          <div class="tool-header">
            <div class="tool-icon allergy">
              <span class="material-symbols-rounded">health_and_safety</span>
            </div>
            <div class="tool-title">
              <div class="tool-name">Allergy Checker</div>
              <div class="tool-description">Check for patient allergies and contraindications</div>
            </div>
          </div>
          <div class="tool-content">
            <form @submit.prevent="checkAllergies">
              <div class="form-group">
                <label class="form-label">Patient ID</label>
                <input type="text" class="form-input" x-model="allergy.patientId" placeholder="Enter patient ID">
              </div>
              <div class="form-group">
                <label class="form-label">Or Enter Allergies Manually</label>
                <input type="text" class="form-input" x-model="allergy.allergies" placeholder="e.g., Penicillin, NSAIDs">
              </div>
              <div class="form-group">
                <label class="form-label">Prescribed Medication</label>
                <select class="form-select" x-model="allergy.medication" title="Select medication for allergy check">
                  <option value="">Select medication...</option>
                  <template x-for="drug in medications" :key="drug.id">
                    <option :value="drug.id" x-text="drug.name"></option>
                  </template>
                </select>
              </div>
              <button type="submit" class="btn btn-primary" :disabled="loading">
                <span class="material-symbols-rounded" x-show="!loading">search</span>
                <span class="material-symbols-rounded animate-spin" x-show="loading">refresh</span>
                <span x-text="loading ? 'Checking...' : 'Check Allergies'"></span>
              </button>
            </form>

            <div x-show="allergy.result" class="result-container" :class="allergy.result.type">
              <div class="result-title">
                <span class="material-symbols-rounded" x-text="allergy.result.icon"></span>
                <span x-text="allergy.result.title"></span>
              </div>
              <div class="result-content" x-html="allergy.result.content"></div>
            </div>
          </div>
        </div>

        <!-- Alternative Medications -->
        <div class="tool-card">
          <div class="tool-header">
            <div class="tool-icon alternative">
              <span class="material-symbols-rounded">swap_horiz</span>
            </div>
            <div class="tool-title">
              <div class="tool-name">Alternative Medications</div>
              <div class="tool-description">Find therapeutic alternatives</div>
            </div>
          </div>
          <div class="tool-content">
            <form @submit.prevent="findAlternatives">
              <div class="form-group">
                <label class="form-label">Current Medication</label>
                <select class="form-select" x-model="alternative.medication" title="Select current medication for alternatives">
                  <option value="">Select medication...</option>
                  <template x-for="drug in medications" :key="drug.id">
                    <option :value="drug.id" x-text="drug.name"></option>
                  </template>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Reason for Alternative</label>
                <select class="form-select" x-model="alternative.reason" title="Select reason for alternative medication">
                  <option value="">Select reason...</option>
                  <option value="cost">Cost</option>
                  <option value="side_effects">Side Effects</option>
                  <option value="availability">Availability</option>
                  <option value="contraindication">Contraindication</option>
                  <option value="patient_preference">Patient Preference</option>
                  <option value="formulation">Formulation Issues</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Patient ID (Optional)</label>
                <input type="text" class="form-input" x-model="alternative.patientId" placeholder="Enter patient ID for personalized alternatives">
              </div>
              <button type="submit" class="btn btn-primary" :disabled="loading">
                <span class="material-symbols-rounded" x-show="!loading">search</span>
                <span class="material-symbols-rounded animate-spin" x-show="loading">refresh</span>
                <span x-text="loading ? 'Finding...' : 'Find Alternatives'"></span>
              </button>
            </form>

            <div x-show="alternative.result" class="result-container info">
              <div class="result-title">
                <span class="material-symbols-rounded">info</span>
                <span>Alternative Options</span>
              </div>
              <div class="result-content" x-html="alternative.result"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="export-section">
        <h3 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Export Clinical Report</h3>
        <div class="btn-group">
          <button class="btn btn-primary" @click="generateReport('pdf')" :disabled="!hasClinicalData()">
            <span class="material-symbols-rounded">picture_as_pdf</span>
            <span>Export PDF</span>
          </button>
          <button class="btn btn-secondary" @click="generateReport('print')" :disabled="!hasClinicalData()">
            <span class="material-symbols-rounded">print</span>
            <span>Print Report</span>
          </button>
          <button class="btn btn-secondary" @click="generateReport('email')" :disabled="!hasClinicalData()">
            <span class="material-symbols-rounded">email</span>
            <span>Email Report</span>
          </button>
        </div>
      </div>
    </div>
  </main>



  <script src="js/pharmacist-api.js"></script>
  <script>
    // Force modal to be hidden on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Hide any modal overlays immediately
      const modals = document.querySelectorAll('.modal-overlay');
      modals.forEach(modal => {
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        modal.style.pointerEvents = 'none';
        modal.classList.remove('show');
      });
      
      console.log('Modal elements forced hidden on page load');
    });
    
    function clinicalSystem() {
      return {
        sidebarOpen: false,
        loading: false,
        medications: [],
        selectedPatient: null,
        patientSearchQuery: '',
        patientSearchResults: [],
        showPatientResults: false,
        clinicalHistory: [],
        clinicalAlerts: [],
        showDrugModal: false,
        drugMonograph: {},
        pharmacyInfo: {
          name: '',
          location: ''
        },
        interaction: {
          drug1: '',
          drug2: '',
          result: null
        },
        dosage: {
          medication: '',
          weight: '',
          age: '',
          creatinine: '',
          childPugh: '',
          trimester: '',
          patientId: '',
          result: null,
          renalAdjustment: null,
          hepaticAdjustment: null,
          pregnancyWarning: null,
          elderlyWarning: null
        },
        allergy: {
          patientId: '',
          allergies: '',
          medication: '',
          result: null
        },
        alternative: {
          medication: '',
          reason: '',
          patientId: '',
          result: null
        },

        async init() {
          // Force modal to be closed on initialization
          this.showDrugModal = false;
          this.drugMonograph = {};
          
          console.log('Clinical system initializing - forcing modal closed');
          
          // Add a delay to ensure modal is closed after Alpine.js initializes
          setTimeout(() => {
            this.showDrugModal = false;
            this.drugMonograph = {};
            console.log('Modal state after timeout:', this.showDrugModal);
          }, 100);
          
          await this.loadInitialData();
          // Load clinical alerts periodically
          setInterval(() => this.loadClinicalAlerts(), 30000); // Every 30 seconds
        },

        async loadInitialData() {
          try {
            // Load medications from inventory
            const medicationsResponse = await window.pharmacistApi.clinical.getMedications();
            this.medications = medicationsResponse.data || [];

            // Load pharmacy info from account settings
            const accountResponse = await window.pharmacistApi.account.getProfile();
            if (accountResponse.data) {
              this.pharmacyInfo.name = accountResponse.data.pharmacyName || 'Umi Health Pharmacy';
              this.pharmacyInfo.location = accountResponse.data.location || 'Main Branch';
            }

            // Load recent decisions
            await this.loadRecentDecisions();
            
            // Load clinical alerts
            await this.loadClinicalAlerts();
          } catch (error) {
            console.error('Failed to load initial data:', error);
            // Fallback to empty arrays if API fails
            this.medications = [];
          }
        },

        async loadRecentDecisions() {
          try {
            const response = await window.pharmacistApi.clinical.getRecentDecisions(10);
            this.clinicalHistory = response.data || [];
          } catch (error) {
            console.error('Failed to load recent decisions:', error);
          }
        },

        async loadClinicalAlerts() {
          try {
            const patientId = this.selectedPatient ? this.selectedPatient.id : null;
            const response = await window.pharmacistApi.clinical.getClinicalAlerts(patientId);
            this.clinicalAlerts = response.data || [];
          } catch (error) {
            console.error('Failed to load clinical alerts:', error);
          }
        },

        // Patient search and selection
        async searchPatients() {
          if (this.patientSearchQuery.length < 2) {
            this.patientSearchResults = [];
            return;
          }

          try {
            const response = await window.pharmacistApi.clinical.searchPatients(this.patientSearchQuery, 10);
            this.patientSearchResults = response.data || [];
          } catch (error) {
            console.error('Failed to search patients:', error);
            this.patientSearchResults = [];
          }
        },

        async selectPatient(patient) {
          this.selectedPatient = patient;
          this.patientSearchQuery = '';
          this.patientSearchResults = [];
          this.showPatientResults = false;

          // Load patient-specific data
          await this.loadPatientClinicalHistory(patient.id);
          await this.loadClinicalAlerts();

          // Auto-fill patient ID in forms
          this.allergy.patientId = patient.id;
          this.alternative.patientId = patient.id;
          this.dosage.patientId = patient.id;
          this.dosage.age = patient.age;
        },

        clearPatient() {
          this.selectedPatient = null;
          this.clinicalHistory = [];
          this.allergy.patientId = '';
          this.alternative.patientId = '';
          this.dosage.patientId = '';
          this.dosage.age = '';
          this.loadClinicalAlerts();
        },

        async loadPatientClinicalHistory(patientId) {
          try {
            const response = await window.pharmacistApi.clinical.getPatientClinicalHistory(patientId, 20);
            this.clinicalHistory = response.data || [];
          } catch (error) {
            console.error('Failed to load patient clinical history:', error);
            this.clinicalHistory = [];
          }
        },

        async dismissAlert(alertId) {
          try {
            await window.pharmacistApi.clinical.dismissAlert(alertId);
            this.clinicalAlerts = this.clinicalAlerts.filter(alert => alert.id !== alertId);
          } catch (error) {
            console.error('Failed to dismiss alert:', error);
          }
        },

        // Drug monograph
        async showDrugMonograph(drugId) {
          if (!drugId) return;
          
          // Prevent multiple modal opens
          if (this.showDrugModal) {
            return;
          }

          try {
            const response = await window.pharmacistApi.clinical.getDrugMonograph(drugId);
            this.drugMonograph = response.data || {};
            this.showDrugModal = true;
          } catch (error) {
            console.error('Failed to load drug monograph:', error);
            this.drugMonograph = { name: 'Information not available' };
            this.showDrugModal = true;
          }
        },

        closeDrugModal() {
          console.log('Closing drug modal - called manually');
          this.showDrugModal = false;
          this.drugMonograph = {};
        },
        
        // Debug function to check modal state
        debugModalState() {
          console.log('Modal state debug:', {
            showDrugModal: this.showDrugModal,
            drugMonograph: this.drugMonograph,
            interaction: this.interaction,
            dosage: this.dosage
          });
        },

        // Therapeutic duplication checker
        async checkTherapeuticDuplication() {
          if (!this.selectedPatient || !this.interaction.drug1 || !this.interaction.drug2) {
            alert('Please select a patient and both medications to check for therapeutic duplication.');
            return;
          }

          this.loading = true;
          try {
            const medications = [this.interaction.drug1, this.interaction.drug2];
            const response = await window.pharmacistApi.clinical.checkTherapeuticDuplication(
              this.selectedPatient.id,
              medications
            );
            
            if (response.data.duplicationFound) {
              this.interaction.result = {
                type: 'warning',
                icon: 'warning',
                title: 'Therapeutic Duplication Detected',
                content: this.formatDuplicationResult(response.data),
                severityScore: response.data.severityScore,
                severityLevel: response.data.severityLevel
              };
            } else {
              this.interaction.result = {
                type: 'success',
                icon: 'check_circle',
                title: 'No Therapeutic Duplication',
                content: 'No therapeutic duplication detected between these medications.'
              };
            }
          } catch (error) {
            console.error('Failed to check therapeutic duplication:', error);
            this.interaction.result = {
              type: 'warning',
              icon: 'error',
              title: 'Error',
              content: 'Failed to check therapeutic duplication. Please try again.'
            };
          } finally {
            this.loading = false;
          }
        },

        // Elderly appropriateness checker
        async checkElderlyAppropriateness() {
          if (!this.dosage.medication || !this.dosage.age) {
            alert('Please select a medication and enter patient age.');
            return;
          }

          this.loading = true;
          try {
            const response = await window.pharmacistApi.clinical.checkElderlyAppropriateness(
              this.dosage.medication,
              parseInt(this.dosage.age)
            );
            
            if (response.data.inappropriate) {
              this.dosage.elderlyWarning = response.data.recommendation;
            } else {
              this.dosage.elderlyWarning = 'This medication is appropriate for elderly patients.';
            }
          } catch (error) {
            console.error('Failed to check elderly appropriateness:', error);
            this.dosage.elderlyWarning = 'Failed to check elderly appropriateness. Please consult Beers Criteria manually.';
          } finally {
            this.loading = false;
          }
        },

        // Export functions
        hasClinicalData() {
          return this.interaction.result || this.dosage.result || this.allergy.result || this.alternative.result;
        },

        async generateReport(format) {
          if (!this.hasClinicalData()) {
            alert('No clinical data available to export.');
            return;
          }

          this.loading = true;
          try {
            const reportData = {
              patient: this.selectedPatient,
              interactions: this.interaction.result,
              dosage: this.dosage.result,
              allergies: this.allergy.result,
              alternatives: this.alternative.result,
              timestamp: new Date().toISOString(),
              pharmacist: window.pharmacistApi.userId
            };

            const response = await window.pharmacistApi.clinical.generateClinicalReport(reportData);
            
            if (format === 'pdf') {
              const exportResponse = await window.pharmacistApi.clinical.exportClinicalReport(response.data.reportId, 'pdf');
              // Download PDF
              window.open(exportResponse.data.downloadUrl, '_blank');
            } else if (format === 'print') {
              window.print();
            } else if (format === 'email') {
              // Implement email functionality
              alert('Report would be emailed to the healthcare provider.');
            }
          } catch (error) {
            console.error('Failed to generate report:', error);
            alert('Failed to generate report. Please try again.');
          } finally {
            this.loading = false;
          }
        },

        async checkInteractions() {
          if (!this.interaction.drug1 || !this.interaction.drug2) {
            this.interaction.result = {
              type: 'warning',
              icon: 'warning',
              title: 'Warning',
              content: 'Please select both medications to check for interactions.'
            };
            return;
          }

          this.loading = true;
          try {
            const response = await window.pharmacistApi.clinical.checkDrugInteractions(
              this.interaction.drug1,
              this.interaction.drug2
            );
            
            // Get severity scoring
            const severityResponse = await window.pharmacistApi.clinical.getInteractionSeverity(
              this.interaction.drug1,
              this.interaction.drug2
            );
            
            this.interaction.result = {
              type: response.data.severity === 'high' ? 'warning' : 'success',
              icon: response.data.severity === 'high' ? 'warning' : 'check_circle',
              title: response.data.severity === 'high' ? 'Interaction Detected' : 'No Significant Interactions',
              content: this.formatInteractionResult(response.data),
              severityScore: severityResponse.data.score,
              severityLevel: severityResponse.data.level,
              recommendations: response.data.recommendations || []
            };

            // Save clinical decision
            await this.saveClinicalDecision('drug_interaction', {
              drug1: this.interaction.drug1,
              drug2: this.interaction.drug2,
              result: response.data,
              severity: severityResponse.data
            });
          } catch (error) {
            console.error('Failed to check interactions:', error);
            this.interaction.result = {
              type: 'warning',
              icon: 'error',
              title: 'Error',
              content: 'Failed to check drug interactions. Please try again.'
            };
          } finally {
            this.loading = false;
          }
        },

        async calculateDosage() {
          if (!this.dosage.medication || !this.dosage.weight || !this.dosage.age) {
            this.dosage.result = 'Please fill in all required fields to calculate dosage.';
            return;
          }

          this.loading = true;
          this.dosage.renalAdjustment = null;
          this.dosage.hepaticAdjustment = null;
          this.dosage.pregnancyWarning = null;
          this.dosage.elderlyWarning = null;

          try {
            let response;
            
            // Check for renal adjustments if creatinine provided
            if (this.dosage.creatinine && this.selectedPatient) {
              const renalResponse = await window.pharmacistApi.clinical.calculateRenalDose(
                this.dosage.medication,
                parseFloat(this.dosage.creatinine),
                parseFloat(this.dosage.weight),
                parseInt(this.dosage.age),
                this.selectedPatient.gender || 'unknown'
              );
              
              if (renalResponse.data.adjustmentRequired) {
                this.dosage.renalAdjustment = renalResponse.data.recommendation;
              }
            }

            // Check for hepatic adjustments if Child-Pugh provided
            if (this.dosage.childPugh) {
              const hepaticResponse = await window.pharmacistApi.clinical.calculateHepaticDose(
                this.dosage.medication,
                this.dosage.childPugh
              );
              
              if (hepaticResponse.data.adjustmentRequired) {
                this.dosage.hepaticAdjustment = hepaticResponse.data.recommendation;
              }
            }

            // Check pregnancy safety if trimester provided
            if (this.dosage.trimester) {
              const pregnancyResponse = await window.pharmacistApi.clinical.checkPregnancySafety(
                this.dosage.medication,
                this.dosage.trimester
              );
              
              if (pregnancyResponse.data.category !== 'A') {
                this.dosage.pregnancyWarning = pregnancyResponse.data.warning;
              }
            }

            // Calculate base dosage
            response = await window.pharmacistApi.clinical.calculateDosage(
              this.dosage.medication,
              parseFloat(this.dosage.weight),
              parseInt(this.dosage.age),
              this.dosage.patientId || null
            );
            
            this.dosage.result = response.data.dosageRecommendation;

            // Check elderly appropriateness for patients 65+
            if (this.dosage.age >= 65) {
              const elderlyResponse = await window.pharmacistApi.clinical.checkElderlyAppropriateness(
                this.dosage.medication,
                parseInt(this.dosage.age)
              );
              
              if (elderlyResponse.data.inappropriate) {
                this.dosage.elderlyWarning = elderlyResponse.data.recommendation;
              }
            }

            // Save clinical decision
            await this.saveClinicalDecision('dosage_calculation', {
              medication: this.dosage.medication,
              weight: this.dosage.weight,
              age: this.dosage.age,
              patientId: this.dosage.patientId,
              creatinine: this.dosage.creatinine,
              childPugh: this.dosage.childPugh,
              trimester: this.dosage.trimester,
              result: response.data,
              adjustments: {
                renal: this.dosage.renalAdjustment,
                hepatic: this.dosage.hepaticAdjustment,
                pregnancy: this.dosage.pregnancyWarning,
                elderly: this.dosage.elderlyWarning
              }
            });
          } catch (error) {
            console.error('Failed to calculate dosage:', error);
            this.dosage.result = 'Failed to calculate dosage. Please try again.';
          } finally {
            this.loading = false;
          }
        },

        async checkAllergies() {
          if (!this.allergy.medication) {
            this.allergy.result = {
              type: 'warning',
              icon: 'warning',
              title: 'Warning',
              content: 'Please select a medication to check for allergies.'
            };
            return;
          }

          this.loading = true;
          try {
            let response;
            if (this.allergy.patientId) {
              // Use patient profile if patient ID is provided
              response = await window.pharmacistApi.clinical.checkAllergies(
                this.allergy.patientId,
                this.allergy.medication
              );
            } else {
              // Use manual allergy entry
              response = await window.pharmacistApi.clinical.checkAllergies(
                null,
                this.allergy.medication,
                this.allergy.allergies
              );
            }
            
            this.allergy.result = {
              type: response.data.allergyDetected ? 'warning' : 'success',
              icon: response.data.allergyDetected ? 'error' : 'check_circle',
              title: response.data.allergyDetected ? 'Allergy Alert' : 'No Allergy Concerns',
              content: this.formatAllergyResult(response.data)
            };

            // Save clinical decision
            await this.saveClinicalDecision('allergy_check', {
              patientId: this.allergy.patientId,
              allergies: this.allergy.allergies,
              medication: this.allergy.medication,
              result: response.data
            });
          } catch (error) {
            console.error('Failed to check allergies:', error);
            this.allergy.result = {
              type: 'warning',
              icon: 'error',
              title: 'Error',
              content: 'Failed to check allergies. Please try again.'
            };
          } finally {
            this.loading = false;
          }
        },

        async findAlternatives() {
          if (!this.alternative.medication || !this.alternative.reason) {
            this.alternative.result = 'Please select both medication and reason for alternative.';
            return;
          }

          this.loading = true;
          try {
            const response = await window.pharmacistApi.clinical.findAlternatives(
              this.alternative.medication,
              this.alternative.reason,
              this.alternative.patientId || null
            );
            
            this.alternative.result = this.formatAlternativesResult(response.data);

            // Save clinical decision
            await this.saveClinicalDecision('alternative_search', {
              medication: this.alternative.medication,
              reason: this.alternative.reason,
              patientId: this.alternative.patientId,
              result: response.data
            });
          } catch (error) {
            console.error('Failed to find alternatives:', error);
            this.alternative.result = 'Failed to find alternatives. Please try again.';
          } finally {
            this.loading = false;
          }
        },

        async saveClinicalDecision(type, data) {
          try {
            await window.pharmacistApi.clinical.saveClinicalDecision({
              type,
              data,
              timestamp: new Date().toISOString(),
              userId: window.pharmacistApi.userId
            });
          } catch (error) {
            console.error('Failed to save clinical decision:', error);
            // Don't show error to user as this is background operation
          }
        },

        formatInteractionResult(data) {
          if (data.severity === 'high') {
            return `<div class="alert-item high">
              <span class="material-symbols-rounded alert-icon">error</span>
              <div class="alert-content">
                <div class="alert-title">${data.interactionType}</div>
                <div class="alert-description">${data.description}</div>
              </div>
            </div>`;
          }
          return data.description || 'No clinically significant interactions detected.';
        },

        formatAllergyResult(data) {
          if (data.allergyDetected) {
            return `<div class="alert-item ${data.severity}">
              <span class="material-symbols-rounded alert-icon">${data.severity === 'high' ? 'error' : 'warning'}</span>
              <div class="alert-content">
                <div class="alert-title">${data.allergyType}</div>
                <div class="alert-description">${data.description}</div>
              </div>
            </div>`;
          }
          return 'No known allergies detected for this medication.';
        },

        formatAlternativesResult(data) {
          if (!data.alternatives || data.alternatives.length === 0) {
            return 'No alternatives found for this medication.';
          }

          return data.alternatives.map(alt => `
            <div class="alert-item low">
              <span class="material-symbols-rounded alert-icon">info</span>
              <div class="alert-content">
                <div class="alert-title">${alt.name}</div>
                <div class="alert-description">
                  <strong>Class:</strong> ${alt.class}<br>
                  <strong>Dosage:</strong> ${alt.dosage}<br>
                  <strong>Notes:</strong> ${alt.notes}
                </div>
              </div>
            </div>
          `).join('');
        },

        formatDuplicationResult(data) {
          return `<div class="alert-item medium">
            <span class="material-symbols-rounded alert-icon">warning</span>
            <div class="alert-content">
              <div class="alert-title">Therapeutic Duplication</div>
              <div class="alert-description">
                <strong>Therapeutic Class:</strong> ${data.therapeuticClass}<br>
                <strong>Risk Level:</strong> ${data.riskLevel}<br>
                <strong>Recommendation:</strong> ${data.recommendation}
              </div>
            </div>
          </div>`;
        },

        logout() {
          if (window.pharmacistApi) {
            window.pharmacistApi.clearAuth();
          }
          window.location.href = '/public/admin-signin.html';
        }
      }
    }
    
    // Global function to force close modal - can be called from console
    window.forceCloseModal = function() {
      const modals = document.querySelectorAll('.modal-overlay');
      modals.forEach(modal => {
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        modal.style.pointerEvents = 'none';
        modal.classList.remove('show');
      });
      
      // Also try to close via Alpine.js if available
      if (window.Alpine) {
        const alpineData = window.Alpine.$data(document.querySelector('[x-data]'));
        if (alpineData && alpineData.closeDrugModal) {
          alpineData.closeDrugModal();
        }
      }
      
      console.log('Modal force closed via global function');
    };
  </script>
</body>
</html>
