name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.404'
      
      - name: Verify .NET Version
        run: |
          echo "DOTNET_ROOT: $DOTNET_ROOT"
          echo "DOTNET version:"
          dotnet --version
          echo "Available SDKs:"
          dotnet --list-sdks
      
      - name: Verify File Structure
        run: |
          echo "Current directory:"
          pwd
          echo "Backend directory contents:"
          ls -la backend/
          echo "Solution file:"
          cat backend/UmiHealth.sln | head -20
          echo "API project file check:"
          ls -la backend/src/UmiHealth.API/

      - name: Restore
        run: dotnet restore backend/UmiHealth.sln

      - name: Build
        run: dotnet build backend/UmiHealth.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test backend/UmiHealth.sln --no-build --verbosity normal

  build-and-push:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.404'
      
      - name: Set registry variables
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "REGISTRY=${{ env.REGISTRY || 'ghcr.io' }}" >> $GITHUB_ENV
          if [[ -n "$ACR_LOGIN_SERVER" && -n "$ACR_USERNAME" && -n "$ACR_PASSWORD" ]]; then
            echo "HAS_ACR_LOGIN=true" >> $GITHUB_ENV
          else
            echo "HAS_ACR_LOGIN=false" >> $GITHUB_ENV
          fi

      - name: Log in to registry (GHCR or ACR)
        if: env.HAS_ACR_LOGIN == 'true'
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
          ecr: false

      - name: Check CR_PAT availability
        if: env.HAS_ACR_LOGIN != 'true'
        run: |
          if [[ -z "${{ secrets.CR_PAT }}" ]]; then
            echo "❌ CR_PAT secret is not set or empty"
            echo "Please create a Personal Access Token with 'write:packages' scope and add it as CR_PAT secret"
            echo "Go to: https://github.com/settings/tokens/new"
            echo "Required scopes: write:packages, repo"
            exit 1
          else
            echo "✅ CR_PAT secret is available"
            echo "Token length: $(echo '${{ secrets.CR_PAT }}' | wc -c)"
          fi

      - name: Test GHCR authentication
        if: env.HAS_ACR_LOGIN != 'true'
        run: |
          echo "Testing GHCR authentication..."
          echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u mmushibi --password-stdin
          if [ $? -eq 0 ]; then
            echo "✅ GHCR authentication successful"
          else
            echo "❌ GHCR authentication failed"
            echo "Please verify:"
            echo "1. CR_PAT secret is correctly set"
            echo "2. Token has 'write:packages' scope"
            echo "3. Token has not expired"
            exit 1
          fi

      - name: Log in to GHCR (fallback)
        if: env.HAS_ACR_LOGIN != 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: mmushibi
          password: ${{ secrets.CR_PAT }}
          ecr: false

      - name: Build and push API image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ghcr.io/mmushibi/umihealth-api:latest
            ghcr.io/mmushibi/umihealth-api:${{ github.sha }}

      - name: Build and push Identity image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: backend/src/UmiHealth.Identity/Dockerfile
          push: true
          tags: |
            ghcr.io/mmushibi/umihealth-identity:latest
            ghcr.io/mmushibi/umihealth-identity:${{ github.sha }}

      - name: Build and push Background Jobs image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: backend/src/UmiHealth.Jobs/Dockerfile
          push: true
          tags: |
            ghcr.io/mmushibi/umihealth-jobs:latest
            ghcr.io/mmushibi/umihealth-jobs:${{ github.sha }}

  deploy-azure:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Azure Web App (Container)
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          slot-name: production
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          images: ${{ env.REGISTRY }}/${{ github.repository }}/umihealth-api:${{ github.sha }}

      - name: Wait for app to become available
        run: |
          for i in {1..12}; do
            if curl -fsS https://${{ secrets.AZURE_WEBAPP_DEFAULT_HOSTNAME }}/health; then
              echo "app is healthy"; break
            fi
            echo "waiting for app... ($i)"; sleep 5
          done

      - name: Run EF Core migrations against target DB
        env:
          DOTNET_NOLOGO: true
          DB_CONN: ${{ secrets.DATABASE_CONNECTION }}
        run: |
          echo "Running EF Core migrations using connection from secret DATABASE_CONNECTION"
          git clone --depth 1 https://github.com/${{ github.repository }} .
          cd backend
          dotnet tool restore
          dotnet restore
          dotnet build --configuration Release
          # Run migrations for the UmiHealth project
          dotnet ef database update --project src/UmiHealth.Infrastructure --startup-project src/UmiHealth.API --connection "$DB_CONN"

      - name: Smoke test
        run: |
          curl -f https://${{ secrets.AZURE_WEBAPP_DEFAULT_HOSTNAME }}/health || (echo "Health check failed" && exit 1)

  postman-smoke-tests:
    needs: deploy-azure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Newman
        run: npm install -g newman

      - name: Get access token
        id: auth
        run: |
          TOKEN=$(curl -s -X POST https://${{ secrets.AZURE_WEBAPP_DEFAULT_HOSTNAME }}/api/v1/auth/login \
            -H "Content-Type: application/json" \
            -H "X-Tenant-Code: PROD" \
            -d '{
              "email": "admin@umihealth.com",
              "password": "${{ secrets.ADMIN_PASSWORD }}",
              "tenantSubdomain": "PROD"
            }' | jq -r '.data.token')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Run Postman API smoke tests
        if: steps.auth.outputs.token != 'null' && steps.auth.outputs.token != ''
        run: |
          bash api-testing/scripts/run-postman-tests.sh \
            Production \
            https://${{ secrets.AZURE_WEBAPP_DEFAULT_HOSTNAME }} \
            "${{ steps.auth.outputs.token }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: /tmp/postman-results.json
